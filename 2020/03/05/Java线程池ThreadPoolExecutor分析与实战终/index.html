<!DOCTYPE html>
<html>

<head><meta name="generator" content="Hexo 3.9.0">
  <script type="text/javascript" src="https://cdn.bootcdn.net/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
  <script type="text/javascript" src="/js/jquery.goup.min.js" defer></script>
  
  <title>Javaçº¿ç¨‹æ± ThreadPoolExecutoråˆ†æä¸å®æˆ˜ç»ˆ - å¼ å°å‡¯çš„åšå®¢</title>
  <meta charset="UTF-8">
  <meta name="description" content="è¬™è™šã¯äººã‚’é€²æ­©ã•ã›ã€ã”ã†ã¾ã‚“ã¯äººã‚’è½å¾Œã•ã›ã‚‹ã€‚ç¤¾ä¼šã®åˆå¿ƒè€…ã‹ã‚‰ã€ã‚ˆã‚ã—ããŠé¡˜ã„ã—ã¾ã™ï¼">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  

  <link rel="shortcut icon" href="/favicon.ico" type="image/png">
  <meta name="description" content="å‰é¢ä¸¤ç¯‡æ–‡ç« åˆ†æäº†Javaä¸­å‡ ç§å¸¸è§çš„çº¿ç¨‹æ± , ä¸‹é¢æˆ‘ä»¬é€šè¿‡æºç æ¥çœ‹ä¸€çœ‹ä»–ä»¬ç©¶ç«Ÿåœ¨æœ€åº•å±‚æ˜¯æ€ä¹ˆå®ç°çš„">
<meta name="keywords" content="Javaæºç ,å¹¶å‘ç¼–ç¨‹,çº¿ç¨‹æ± ">
<meta property="og:type" content="article">
<meta property="og:title" content="Javaçº¿ç¨‹æ± ThreadPoolExecutoråˆ†æä¸å®æˆ˜ç»ˆ">
<meta property="og:url" content="https://jasonkayzk.github.io/2020/03/05/Javaçº¿ç¨‹æ± ThreadPoolExecutoråˆ†æä¸å®æˆ˜ç»ˆ/index.html">
<meta property="og:site_name" content="å¼ å°å‡¯çš„åšå®¢">
<meta property="og:description" content="å‰é¢ä¸¤ç¯‡æ–‡ç« åˆ†æäº†Javaä¸­å‡ ç§å¸¸è§çš„çº¿ç¨‹æ± , ä¸‹é¢æˆ‘ä»¬é€šè¿‡æºç æ¥çœ‹ä¸€çœ‹ä»–ä»¬ç©¶ç«Ÿåœ¨æœ€åº•å±‚æ˜¯æ€ä¹ˆå®ç°çš„">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://images2015.cnblogs.com/blog/677054/201704/677054-20170408210905472-1864459025.png">
<meta property="og:image" content="https://images2015.cnblogs.com/blog/677054/201704/677054-20170408211358816-1277836615.png">
<meta property="og:image" content="https://images2015.cnblogs.com/blog/677054/201704/677054-20170408211458878-1033038857.png">
<meta property="og:image" content="https://images2015.cnblogs.com/blog/677054/201704/677054-20170408211632300-254189763.png">
<meta property="og:updated_time" content="2026-02-10T12:07:45.739Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Javaçº¿ç¨‹æ± ThreadPoolExecutoråˆ†æä¸å®æˆ˜ç»ˆ">
<meta name="twitter:description" content="å‰é¢ä¸¤ç¯‡æ–‡ç« åˆ†æäº†Javaä¸­å‡ ç§å¸¸è§çš„çº¿ç¨‹æ± , ä¸‹é¢æˆ‘ä»¬é€šè¿‡æºç æ¥çœ‹ä¸€çœ‹ä»–ä»¬ç©¶ç«Ÿåœ¨æœ€åº•å±‚æ˜¯æ€ä¹ˆå®ç°çš„">
<meta name="twitter:image" content="https://images2015.cnblogs.com/blog/677054/201704/677054-20170408210905472-1864459025.png">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdui@0.4.3/dist/css/mdui.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.16.2/styles/atom-one-dark.css">
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css">
  
  
  <link rel="stylesheet" href="//at.alicdn.com/t/font_1038733_0xvrvpg9c0r.css">
  <link rel="stylesheet" href="/css/style.css?v=1770725348903">

  <!-- è¿›åº¦æ¡åŠ è½½: nprogress -->
  <link href="https://cdn.bootcss.com/nprogress/0.2.0/nprogress.min.css" rel="stylesheet">
  <script src="https://cdn.bootcss.com/nprogress/0.2.0/nprogress.min.js"></script>

  <!-- Google AdSense -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6617852905105366" crossorigin="anonymous"></script>
  <!-- Cloudflare Web Analytics -->
   <script defer src="https://static.cloudflareinsights.com/beacon.min.js" data-cf-beacon="{"token": "73d46a730654451bac205cdc12bea918"}"></script>
  <!-- umami Web Analytics -->
  <script defer src="https://cloud.umami.is/script.js" data-website-id="23fadd4b-d559-4ae0-a4f6-f90680c3d4c0"></script>

  <!-- æœ¬åœ°æœç´¢js -->
  <script type="text/javascript" src="/js/search.js"></script>

  <!-- ç™¾åº¦ç«™ç‚¹ç®¡ç† -->
  <meta name="baidu-site-verification" content="code-SKIvb4A1Qx">

  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-1NWK4EEKDF');
  </script>

  <!-- ç«™å†…é€šçŸ¥ -->
  <link href="https://apps.bdimg.com/libs/bootstrap/3.3.4/css/bootstrap.css" rel="stylesheet" type="text/css">
  <link rel="stylesheet" type="text/css" href="/css/default.css">
  <link rel="stylesheet" href="/css/animate.min.css">
  <link rel="stylesheet" href="/css/notification.css">
  <link rel="stylesheet" href="/css/index.css">
<link rel="alternate" href="/atom.xml" title="å¼ å°å‡¯çš„åšå®¢" type="application/atom+xml">
</head>

<!-- æ–‡ç« é˜…è¯»è¿›åº¦æ¡æ ·å¼ -->
<style>
  #content_progress {
      /* Positioning */
      position: fixed;
      left: 0;
      top: 0;
      z-index: 99999;
      width: 100%;
      height: 3px;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      border: none;
      background-color: transparent;
      color: #ffaa73;
}

#content_progress::-webkit-progress-bar {
      background-color: transparent;
}

#content_progress::-webkit-progress-value {
      background-color: #ffaa73;
}

#content_progress::-moz-progress-bar {
      background-color:#ffaa73;
}
</style>
<!-- æ–‡ç« é˜…è¯»è¿›åº¦æ¡JS -->
<script>
  document.addEventListener('DOMContentLoaded', function () {
      var winHeight = window.innerHeight,
            docHeight = document.documentElement.scrollHeight,
            progressBar = document.querySelector('#content_progress');
      progressBar.max = docHeight - winHeight;
      progressBar.value = window.scrollY;

      document.addEventListener('scroll', function () {
            progressBar.max = document.documentElement.scrollHeight - window.innerHeight;
            progressBar.value = window.scrollY;
      });
});
</script>

<body class="mdui-drawer-body-left">
  <!-- æ–‡ç« é˜…è¯»è¿›åº¦æ¡ -->
  <progress id="content_progress" value="0"></progress>

  <!-- éŸ³é¢‘æ’­æ”¾ -->
  <!-- <link rel="stylesheet" href="/dist/APlayer.min.css">
  <div id="aplayer"></div>
  <script type="text/javascript" src="/dist/APlayer.min.js"></script>
  <script type="text/javascript" src="/dist/music.js"></script> -->

  
  <div id="nexmoe-background">
    <div class="nexmoe-bg" style="background-image: url(/images/bg.jpg)"></div>
    <div class="mdui-appbar mdui-shadow-0">
      <div class="mdui-toolbar">
        <a mdui-drawer="{target: '#drawer', swipe: true}" title="menu" class="mdui-btn mdui-btn-icon"><i class="mdui-icon material-icons">menu</i></a>
        <div class="mdui-toolbar-spacer"></div>
        <a href="/" title="Jasonkay" class="mdui-btn mdui-btn-icon"><img src="/images/avatar4.jpg"></a>
      </div>
    </div>
  </div>
  <div id="nexmoe-header">
    <div class="nexmoe-drawer mdui-drawer" id="drawer">
    <div class="nexmoe-avatar mdui-ripple">
        <a href="/" title="Jasonkay">
            <img src="/images/avatar4.jpg" alt="Jasonkay">
        </a>
    </div>

    <!-- é»‘ç™½åˆ‡æ¢css -->
    <!-- <style>
        .light-dark-checkbox {
            margin: 0 auto;
        }

        /* The switch - the box around the slider */
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        /* Hide default HTML checkbox */
        .switch .theme-switcher {
            opacity: 0;
            width: 0;
            height: 0;
        }

        /* The slider */
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            transition: 0.4s;
        }

        .slider:before {
            position: absolute;
            content: "ğŸŒ";
            height: 0px;
            width: 0px;
            left: -10px;
            top: 16px;
            line-height: 0px;
            transition: 0.4s;
        }

        .theme-switcher:checked+.slider:before {
            left: 35px;
            content: "ğŸŒ‘";
        }

        .theme-switcher:checked+.slider:before {
            transform: translateX(45px);
        }

        /* Rounded sliders */
        .slider.round {
            border-radius: 40px;
        }

        .slider.round:before {
            border-radius: 50%;
        }

        /* æš—é»‘æ ·å¼ */
        body.night {
            background-color: #263238;
            color: #aaa;
        }
        body.night img {
            filter: brightness(30%);
        }
        article.night {
            background-color: black;
            color: white;
        }
    </style> -->

    <!-- é»‘ç™½å¼€å…³ -->
    <!-- <div class="nexmoe-list-item mdui-list-item">
        <div class="light-dark-checkbox">
            <div>
                é»‘ç™½æ¨¡å¼åˆ‡æ¢(Beta)
            </div>
            <label class="switch">
                <input id="light-dark-input" type="checkbox" onclick="switchTheme();" class="theme-switcher">
                <span class="slider round"></span>
            </label>
        </div>
    </div> -->

    <!-- é»‘ç™½åˆ‡æ¢js -->
    <!-- <script>
        // get hours of the day in 24Hr format (0-23)
        var hr = (new Date()).getHours();

        $(document).ready(function () {
            var theme = sessionStorage.getItem("theme");
            if (theme == "dark") {
                document.body.classList.add('night');
                console.log('å¤œé—´æ¨¡å¼å¼€å¯');
            } else if (theme == "light") {
                document.body.classList.remove('night');
                console.log('å¤œé—´æ¨¡å¼å…³é—­');
            } else {
                setDefaultTheme(hr);
            }
        });

        function switchTheme() {
            if (sessionStorage.getItem("theme") == "dark") {
                sessionStorage.setItem("theme", "light");
                document.body.classList.remove('night');
                console.log('å¤œé—´æ¨¡å¼å…³é—­');
            } else if (sessionStorage.getItem("theme") == "light") {
                sessionStorage.setItem("theme", "dark");
                document.body.classList.add('night');
                console.log('å¤œé—´æ¨¡å¼å¼€å¯');
            } else {
                setDefaultTheme(hr);
            }
        };

        function setDefaultTheme(curHr) {
            // 6:00-18:00 light
            if (curHr >= 6 && curHr <= 18) {
                document.body.classList.remove('night');
                console.log('å¤œé—´æ¨¡å¼å…³é—­');
                sessionStorage.setItem("theme", "light");
                $("#light-dark-input").attr("checked", false);
            } else {
                // 0:00-6:00 & 18:00-00:00 night
                sessionStorage.setItem("theme", "dark");
                document.body.classList.add('night');
                console.log('å¤œé—´æ¨¡å¼å¼€å¯');
                $("#light-dark-input").attr("checked", true);
            }
        }
    </script> -->

    <div class="nexmoe-count">
        <div><span>æ–‡ç« </span>522</div>
        <div><span>æ ‡ç­¾</span>277</div>
        <div><span>åˆ†ç±»</span>67</div>
    </div>
    <ul class="nexmoe-list mdui-list" mdui-collapse="{accordion: true}">
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple" href="/" title="å›åˆ°é¦–é¡µ">
            <i class="mdui-list-item-icon nexmoefont icon-home"></i>
            <div class="mdui-list-item-content">
                å›åˆ°é¦–é¡µ
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple" href="/jp/" title="æ—¥è¯­åˆ†ç«™">
            <i class="mdui-list-item-icon nexmoefont icon-calendar-fill"></i>
            <div class="mdui-list-item-content">
                æ—¥è¯­åˆ†ç«™
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple" href="/about/" title="å…³äºåšå®¢">
            <i class="mdui-list-item-icon nexmoefont icon-eye-fill"></i>
            <div class="mdui-list-item-content">
                å…³äºåšå®¢
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple" href="/archive" title="æ–‡ç« å½’æ¡£">
            <i class="mdui-list-item-icon nexmoefont icon-container"></i>
            <div class="mdui-list-item-content">
                æ–‡ç« å½’æ¡£
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple" href="/anki/" title="Ankiç¬”è®°">
            <i class="mdui-list-item-icon nexmoefont icon-tag-fill"></i>
            <div class="mdui-list-item-content">
                Ankiç¬”è®°
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple" href="/study/" title="å­¦ä¹ è¿›åº¦">
            <i class="mdui-list-item-icon nexmoefont icon-telegram"></i>
            <div class="mdui-list-item-content">
                å­¦ä¹ è¿›åº¦
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple" href="/running/" title="è·‘æ­¥å¥èº«">
            <i class="mdui-list-item-icon nexmoefont icon-dribbble"></i>
            <div class="mdui-list-item-content">
                è·‘æ­¥å¥èº«
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple" href="/interview/" title="é¢è¯•ç›¸å…³">
            <i class="mdui-list-item-icon nexmoefont icon-container"></i>
            <div class="mdui-list-item-content">
                é¢è¯•ç›¸å…³
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple" href="/algorithm/" title="ç®—æ³•æ€»ç»“">
            <i class="mdui-list-item-icon nexmoefont icon-areachart"></i>
            <div class="mdui-list-item-content">
                ç®—æ³•æ€»ç»“
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple" href="/installing/" title="è½¯ä»¶å®‰è£…">
            <i class="mdui-list-item-icon nexmoefont icon-unorderedlist"></i>
            <div class="mdui-list-item-content">
                è½¯ä»¶å®‰è£…
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple" href="/board/" title="åˆ›æ„ç™½æ¿">
            <i class="mdui-list-item-icon nexmoefont icon-tag-fill"></i>
            <div class="mdui-list-item-content">
                åˆ›æ„ç™½æ¿
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple" href="http://159.75.131.252:32352/" title="æ‘„å½±åˆ†äº«">
            <i class="mdui-list-item-icon nexmoefont icon-telegram"></i>
            <div class="mdui-list-item-content">
                æ‘„å½±åˆ†äº«
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple" href="/chat/" title="ç•…æ‰€æ¬²è¨€">
            <i class="mdui-list-item-icon nexmoefont icon-ellipsis"></i>
            <div class="mdui-list-item-content">
                ç•…æ‰€æ¬²è¨€
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple" href="/realtime/" title="å®æ—¶æ•°æ®ç»Ÿè®¡">
            <i class="mdui-list-item-icon nexmoefont icon-time-circle-fill"></i>
            <div class="mdui-list-item-content">
                å®æ—¶æ•°æ®ç»Ÿè®¡
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple" href="/py/" title="å‹æƒ…é“¾æ¥">
            <i class="mdui-list-item-icon nexmoefont icon-container"></i>
            <div class="mdui-list-item-content">
                å‹æƒ…é“¾æ¥
            </div>
        </a>
        
    </ul>
    <aside id="nexmoe-sidebar">
  
  <div class="nexmoe-widget-wrap">
    <h3 class="nexmoe-widget-title">ç¤¾äº¤æŒ‰é’®</h3>
    <div class="nexmoe-widget nexmoe-social">
        <a class="mdui-ripple" href="https://space.bilibili.com/23364338" target="_blank" mdui-tooltip="{content: 'å“”å“©å“”å“©'}" style="color: rgb(231, 106, 141);background-color: rgba(231, 106, 141, .15);">
            <i class="nexmoefont icon-bilibili"></i>
        </a><a class="mdui-ripple" href="https://github.com/jasonkayzk/" target="_blank" mdui-tooltip="{content: 'GitHub'}" style="color: rgb(25, 23, 23);background-color: rgba(25, 23, 23, .15);">
            <i class="nexmoefont icon-github"></i>
        </a><a class="mdui-ripple" href="https://steamcommunity.com/id/jasonkayzk/" target="_blank" mdui-tooltip="{content: 'Steam'}" style="color: rgb(29, 161, 242);background-color: rgba(29, 161, 242, .1);">
            <i class="nexmoefont icon-steam"></i>
        </a><a class="mdui-ripple" href="https://twitter.com/Jasonkay_ZK/" target="_blank" mdui-tooltip="{content: 'Twitter'}" style="color: rgb(29, 161, 242);background-color: rgba(29, 161, 242, .1);">
            <i class="nexmoefont icon-twitter"></i>
        </a><a class="mdui-ripple" href="mailto:jasonkayzk@gmail.com" target="_blank" mdui-tooltip="{content: 'Mail'}" style="color: rgb(29, 161, 242);background-color: rgba(29, 161, 242, .1);">
            <i class="nexmoefont icon-mail-fill"></i>
        </a>
    </div>
</div>
  
  <div class="nexmoe-widget-wrap">
    <h3 class="nexmoe-widget-title">ç«™å†…æœç´¢</h3>
    <div class="nexmoe-widget nexmoe-search">
        <form class="site-search-form">
            <input type="text" id="local-search-input" class="st-search-input">
        </form>
        <div id="local-search-result" class="local-search-result-cls">
        </div>
    </div>
</div>

<!-- æ‰§è¡Œæœ¬åœ°æœç´¢è„šæœ¬ -->
<script type="text/javascript">
    var path = "https://cdn.jsdelivr.net/gh/jasonkayzk/JasonkayZK.github.io@master/search.xml";
    searchFunc(path, 'local-search-input', 'local-search-result');
</script>

<style type="text/css">
/* æœç´¢æ¡ */
.site-search-form {
    text-align: center;
}
#local-search-input {
    width: 100%;
}

/* æœç´¢ç»“æœå…³é—­ */
#local-search-close {
    font-size: 22.5px;
    cursor: pointer;
    color: #ff4e6a;
}

.search-result-list > li {
    line-height: 0.75;
    margin-top: -5px;
}

</style>
  
  
  <div class="nexmoe-widget-wrap">
    <h3 class="nexmoe-widget-title">æ ‡ç­¾äº‘</h3>
    <div id="randomtagcloud" class="nexmoe-widget tagcloud">
      <a href="/tags/2048/" style="font-size: 10px;">2048</a> <a href="/tags/ACM/" style="font-size: 10px;">ACM</a> <a href="/tags/AI/" style="font-size: 10px;">AI</a> <a href="/tags/AUFS/" style="font-size: 10px;">AUFS</a> <a href="/tags/Android/" style="font-size: 10.91px;">Android</a> <a href="/tags/AppStore/" style="font-size: 10px;">AppStore</a> <a href="/tags/AppleScript/" style="font-size: 10px;">AppleScript</a> <a href="/tags/Aria2/" style="font-size: 10.91px;">Aria2</a> <a href="/tags/Async/" style="font-size: 10px;">Async</a> <a href="/tags/BFS/" style="font-size: 10.45px;">BFS</a> <a href="/tags/Bash/" style="font-size: 10.45px;">Bash</a> <a href="/tags/BitTorrent/" style="font-size: 10px;">BitTorrent</a> <a href="/tags/BloomFilter/" style="font-size: 10px;">BloomFilter</a> <a href="/tags/Bytebase/" style="font-size: 10px;">Bytebase</a> <a href="/tags/C/" style="font-size: 15.91px;">C++</a> <a href="/tags/CAP/" style="font-size: 10px;">CAP</a> <a href="/tags/CDN/" style="font-size: 10.45px;">CDN</a> <a href="/tags/CGLibåŠ¨æ€ä»£ç†/" style="font-size: 10px;">CGLibåŠ¨æ€ä»£ç†</a> <a href="/tags/CUDA/" style="font-size: 10px;">CUDA</a> <a href="/tags/Cache/" style="font-size: 10px;">Cache</a> <a href="/tags/Caffeine/" style="font-size: 10px;">Caffeine</a> <a href="/tags/Cargo/" style="font-size: 11.82px;">Cargo</a> <a href="/tags/CentOS/" style="font-size: 12.27px;">CentOS</a> <a href="/tags/Cgroups/" style="font-size: 10px;">Cgroups</a> <a href="/tags/Chromeæ‰©å±•/" style="font-size: 10px;">Chromeæ‰©å±•</a> <a href="/tags/Cli/" style="font-size: 10.45px;">Cli</a> <a href="/tags/ClickHouse/" style="font-size: 10px;">ClickHouse</a> <a href="/tags/Cling/" style="font-size: 10px;">Cling</a> <a href="/tags/Clion/" style="font-size: 10px;">Clion</a> <a href="/tags/Colima/" style="font-size: 10px;">Colima</a> <a href="/tags/Container/" style="font-size: 10px;">Container</a> <a href="/tags/DFS/" style="font-size: 10.45px;">DFS</a> <a href="/tags/DLL/" style="font-size: 10.45px;">DLL</a> <a href="/tags/Debian/" style="font-size: 10px;">Debian</a> <a href="/tags/Docker/" style="font-size: 18.64px;">Docker</a> <a href="/tags/Docker-Compose/" style="font-size: 10.45px;">Docker-Compose</a> <a href="/tags/DockerHub/" style="font-size: 10px;">DockerHub</a> <a href="/tags/Dolt/" style="font-size: 10px;">Dolt</a> <a href="/tags/Dubbo/" style="font-size: 10.91px;">Dubbo</a> <a href="/tags/Easegress/" style="font-size: 10px;">Easegress</a> <a href="/tags/ElasticSearch/" style="font-size: 14.09px;">ElasticSearch</a> <a href="/tags/Electron/" style="font-size: 10.45px;">Electron</a> <a href="/tags/English/" style="font-size: 10px;">English</a> <a href="/tags/Excel/" style="font-size: 10px;">Excel</a> <a href="/tags/Express/" style="font-size: 10px;">Express</a> <a href="/tags/FFmpeg/" style="font-size: 10px;">FFmpeg</a> <a href="/tags/FTP/" style="font-size: 10.45px;">FTP</a> <a href="/tags/FaaS/" style="font-size: 10px;">FaaS</a> <a href="/tags/Future/" style="font-size: 10px;">Future</a> <a href="/tags/GC/" style="font-size: 10px;">GC</a> <a href="/tags/GPU/" style="font-size: 10px;">GPU</a> <a href="/tags/GRPC/" style="font-size: 10px;">GRPC</a> <a href="/tags/Gin/" style="font-size: 10px;">Gin</a> <a href="/tags/Git/" style="font-size: 13.64px;">Git</a> <a href="/tags/Gitee/" style="font-size: 10px;">Gitee</a> <a href="/tags/Github/" style="font-size: 14.55px;">Github</a> <a href="/tags/Github-Actions/" style="font-size: 10px;">Github-Actions</a> <a href="/tags/Golang/" style="font-size: 18.18px;">Golang</a> <a href="/tags/Gomod/" style="font-size: 10px;">Gomod</a> <a href="/tags/Goroutine/" style="font-size: 10.91px;">Goroutine</a> <a href="/tags/GraalVM/" style="font-size: 10px;">GraalVM</a> <a href="/tags/Gradle/" style="font-size: 10px;">Gradle</a> <a href="/tags/GraphQL/" style="font-size: 10px;">GraphQL</a> <a href="/tags/HAProxy/" style="font-size: 10px;">HAProxy</a> <a href="/tags/Hadoop/" style="font-size: 10px;">Hadoop</a> <a href="/tags/IDEAé…ç½®/" style="font-size: 10px;">IDEAé…ç½®</a> <a href="/tags/IDç”Ÿæˆå™¨/" style="font-size: 10.45px;">IDç”Ÿæˆå™¨</a> <a href="/tags/IOæ¨¡å‹/" style="font-size: 10px;">IOæ¨¡å‹</a> <a href="/tags/Ingress/" style="font-size: 10.45px;">Ingress</a> <a href="/tags/JDKåŠ¨æ€ä»£ç†/" style="font-size: 10.45px;">JDKåŠ¨æ€ä»£ç†</a> <a href="/tags/JVM/" style="font-size: 10px;">JVM</a> <a href="/tags/Java/" style="font-size: 12.27px;">Java</a> <a href="/tags/JavaWeb/" style="font-size: 10px;">JavaWeb</a> <a href="/tags/JavaåŸºç¡€/" style="font-size: 16.82px;">JavaåŸºç¡€</a> <a href="/tags/Javaæ³¨è§£/" style="font-size: 10px;">Javaæ³¨è§£</a> <a href="/tags/Javaæºç /" style="font-size: 12.27px;">Javaæºç </a> <a href="/tags/Javaé¢è¯•/" style="font-size: 11.36px;">Javaé¢è¯•</a> <a href="/tags/JuiceFS/" style="font-size: 10px;">JuiceFS</a> <a href="/tags/JupyterLab/" style="font-size: 10px;">JupyterLab</a> <a href="/tags/Kafka/" style="font-size: 10.45px;">Kafka</a> <a href="/tags/Kubernetes/" style="font-size: 15.45px;">Kubernetes</a> <a href="/tags/LVS/" style="font-size: 10.91px;">LVS</a> <a href="/tags/Lambdaè¡¨è¾¾å¼/" style="font-size: 10.91px;">Lambdaè¡¨è¾¾å¼</a> <a href="/tags/LevelDB/" style="font-size: 10px;">LevelDB</a> <a href="/tags/Library/" style="font-size: 10.45px;">Library</a> <a href="/tags/Life/" style="font-size: 10px;">Life</a> <a href="/tags/Linux/" style="font-size: 16.36px;">Linux</a> <a href="/tags/LruCache/" style="font-size: 10px;">LruCache</a> <a href="/tags/MacOS/" style="font-size: 10.45px;">MacOS</a> <a href="/tags/Maven/" style="font-size: 12.27px;">Maven</a> <a href="/tags/MongoDB/" style="font-size: 11.82px;">MongoDB</a> <a href="/tags/MySQL/" style="font-size: 13.64px;">MySQL</a> <a href="/tags/Mybatis/" style="font-size: 10.91px;">Mybatis</a> <a href="/tags/NFS/" style="font-size: 10px;">NFS</a> <a href="/tags/NIO/" style="font-size: 10.91px;">NIO</a> <a href="/tags/NPM/" style="font-size: 10px;">NPM</a> <a href="/tags/Namespace/" style="font-size: 10px;">Namespace</a> <a href="/tags/Netty/" style="font-size: 10px;">Netty</a> <a href="/tags/Newman/" style="font-size: 10px;">Newman</a> <a href="/tags/Nginx/" style="font-size: 12.27px;">Nginx</a> <a href="/tags/Node-js/" style="font-size: 11.36px;">Node.js</a> <a href="/tags/Okular/" style="font-size: 10px;">Okular</a> <a href="/tags/P2P/" style="font-size: 10px;">P2P</a> <a href="/tags/POML/" style="font-size: 10px;">POML</a> <a href="/tags/Panic/" style="font-size: 10px;">Panic</a> <a href="/tags/PipelineDB/" style="font-size: 10px;">PipelineDB</a> <a href="/tags/PostgreSQL/" style="font-size: 10.45px;">PostgreSQL</a> <a href="/tags/Postman/" style="font-size: 10.45px;">Postman</a> <a href="/tags/Promise/" style="font-size: 10px;">Promise</a> <a href="/tags/Protobuf/" style="font-size: 10.91px;">Protobuf</a> <a href="/tags/Python/" style="font-size: 11.36px;">Python</a> <a href="/tags/RAII/" style="font-size: 10px;">RAII</a> <a href="/tags/RPC/" style="font-size: 10px;">RPC</a> <a href="/tags/RSS/" style="font-size: 10.91px;">RSS</a> <a href="/tags/React/" style="font-size: 10px;">React</a> <a href="/tags/Redash/" style="font-size: 10px;">Redash</a> <a href="/tags/Redis/" style="font-size: 14.55px;">Redis</a> <a href="/tags/Ruby/" style="font-size: 10px;">Ruby</a> <a href="/tags/Rust/" style="font-size: 18.64px;">Rust</a> <a href="/tags/SPA/" style="font-size: 10px;">SPA</a> <a href="/tags/SQLite/" style="font-size: 10px;">SQLite</a> <a href="/tags/SSE/" style="font-size: 10px;">SSE</a> <a href="/tags/SSH/" style="font-size: 10.45px;">SSH</a> <a href="/tags/Serverless/" style="font-size: 10px;">Serverless</a> <a href="/tags/Shadowsocks/" style="font-size: 10.91px;">Shadowsocks</a> <a href="/tags/Skiplist/" style="font-size: 10px;">Skiplist</a> <a href="/tags/Slice/" style="font-size: 10px;">Slice</a> <a href="/tags/Socket/" style="font-size: 10px;">Socket</a> <a href="/tags/Spring/" style="font-size: 11.82px;">Spring</a> <a href="/tags/Spring-Boot/" style="font-size: 10px;">Spring Boot</a> <a href="/tags/Springæºç /" style="font-size: 10px;">Springæºç </a> <a href="/tags/String/" style="font-size: 10px;">String</a> <a href="/tags/Swagger/" style="font-size: 10px;">Swagger</a> <a href="/tags/TOML/" style="font-size: 10px;">TOML</a> <a href="/tags/Telegraf/" style="font-size: 10px;">Telegraf</a> <a href="/tags/Telegram/" style="font-size: 10px;">Telegram</a> <a href="/tags/Tomcat/" style="font-size: 10.45px;">Tomcat</a> <a href="/tags/TypeScript/" style="font-size: 10px;">TypeScript</a> <a href="/tags/Typora/" style="font-size: 10px;">Typora</a> <a href="/tags/UUID/" style="font-size: 10px;">UUID</a> <a href="/tags/UnionFS/" style="font-size: 10px;">UnionFS</a> <a href="/tags/VMWare/" style="font-size: 13.18px;">VMWare</a> <a href="/tags/VPN/" style="font-size: 10px;">VPN</a> <a href="/tags/WebAssembly/" style="font-size: 10.45px;">WebAssembly</a> <a href="/tags/Websocket/" style="font-size: 10px;">Websocket</a> <a href="/tags/XML/" style="font-size: 10.91px;">XML</a> <a href="/tags/YAML/" style="font-size: 10px;">YAML</a> <a href="/tags/Zookeeper/" style="font-size: 10.91px;">Zookeeper</a> <a href="/tags/apt/" style="font-size: 10px;">apt</a> <a href="/tags/autok3s/" style="font-size: 10px;">autok3s</a> <a href="/tags/cURL/" style="font-size: 10px;">cURL</a> <a href="/tags/chroot/" style="font-size: 10px;">chroot</a> <a href="/tags/cmder/" style="font-size: 10px;">cmder</a> <a href="/tags/grpc/" style="font-size: 10px;">grpc</a> <a href="/tags/hashå†²çª/" style="font-size: 10px;">hashå†²çª</a> <a href="/tags/inoreader/" style="font-size: 10px;">inoreader</a> <a href="/tags/k3s/" style="font-size: 10.45px;">k3s</a> <a href="/tags/kafka/" style="font-size: 10px;">kafka</a> <a href="/tags/keepalived/" style="font-size: 10px;">keepalived</a> <a href="/tags/libp2p/" style="font-size: 10px;">libp2p</a> <a href="/tags/minikube/" style="font-size: 10.45px;">minikube</a> <a href="/tags/ntfy/" style="font-size: 10px;">ntfy</a> <a href="/tags/picocli/" style="font-size: 10px;">picocli</a> <a href="/tags/telnet/" style="font-size: 10px;">telnet</a> <a href="/tags/uv/" style="font-size: 10px;">uv</a> <a href="/tags/vcpkg/" style="font-size: 10px;">vcpkg</a> <a href="/tags/xorm/" style="font-size: 10px;">xorm</a> <a href="/tags/äºŒåˆ†æ³•/" style="font-size: 10px;">äºŒåˆ†æ³•</a> <a href="/tags/äºŒå‰æ ‘/" style="font-size: 15.45px;">äºŒå‰æ ‘</a> <a href="/tags/äºŒç»´ç /" style="font-size: 10px;">äºŒç»´ç </a> <a href="/tags/äº¤å‰ç¼–è¯‘/" style="font-size: 10px;">äº¤å‰ç¼–è¯‘</a> <a href="/tags/äººå·¥æ™ºèƒ½/" style="font-size: 10.91px;">äººå·¥æ™ºèƒ½</a> <a href="/tags/äººç”Ÿæ—¥è®°/" style="font-size: 17.73px;">äººç”Ÿæ—¥è®°</a> <a href="/tags/ä»£ç†æ¨¡å¼/" style="font-size: 10px;">ä»£ç†æ¨¡å¼</a> <a href="/tags/ä½è¿ç®—/" style="font-size: 10.45px;">ä½è¿ç®—</a> <a href="/tags/ä¿¡å·/" style="font-size: 10px;">ä¿¡å·</a> <a href="/tags/ä¿¡æ¯èšåˆ/" style="font-size: 10px;">ä¿¡æ¯èšåˆ</a> <a href="/tags/å†…å­˜ç®¡ç†/" style="font-size: 10.45px;">å†…å­˜ç®¡ç†</a> <a href="/tags/å†…ç½‘ç©¿é€/" style="font-size: 10px;">å†…ç½‘ç©¿é€</a> <a href="/tags/å‡½æ•°å¼æ¥å£/" style="font-size: 10px;">å‡½æ•°å¼æ¥å£</a> <a href="/tags/åˆ†å¸ƒå¼/" style="font-size: 15.91px;">åˆ†å¸ƒå¼</a> <a href="/tags/åŠå…¬/" style="font-size: 10px;">åŠå…¬</a> <a href="/tags/åŠ¨æ€è§„åˆ’/" style="font-size: 11.36px;">åŠ¨æ€è§„åˆ’</a> <a href="/tags/åç¨‹æ± /" style="font-size: 10px;">åç¨‹æ± </a> <a href="/tags/åšå®¢ç®¡ç†/" style="font-size: 13.18px;">åšå®¢ç®¡ç†</a> <a href="/tags/åšå®¢ç¾åŒ–/" style="font-size: 11.82px;">åšå®¢ç¾åŒ–</a> <a href="/tags/åŒæŒ‡é’ˆ/" style="font-size: 10.45px;">åŒæŒ‡é’ˆ</a> <a href="/tags/åå°„/" style="font-size: 12.27px;">åå°„</a> <a href="/tags/å£æ‰/" style="font-size: 10px;">å£æ‰</a> <a href="/tags/å“ˆå¸Œè¡¨/" style="font-size: 10.45px;">å“ˆå¸Œè¡¨</a> <a href="/tags/å›æº¯/" style="font-size: 10.45px;">å›æº¯</a> <a href="/tags/å›æº¯æ³•/" style="font-size: 10px;">å›æº¯æ³•</a> <a href="/tags/å †/" style="font-size: 10.45px;">å †</a> <a href="/tags/å¤šçº¿ç¨‹ä¸‹è½½/" style="font-size: 10.45px;">å¤šçº¿ç¨‹ä¸‹è½½</a> <a href="/tags/å¤§æ•°æ®/" style="font-size: 10px;">å¤§æ•°æ®</a> <a href="/tags/å­—ç¬¦ä¸²/" style="font-size: 13.18px;">å­—ç¬¦ä¸²</a> <a href="/tags/å­—ç¬¦ä¸²å¤„ç†/" style="font-size: 10px;">å­—ç¬¦ä¸²å¤„ç†</a> <a href="/tags/å­¦ä¹ æ¡ˆä¾‹/" style="font-size: 10.45px;">å­¦ä¹ æ¡ˆä¾‹</a> <a href="/tags/å®¹å™¨/" style="font-size: 10px;">å®¹å™¨</a> <a href="/tags/å·¥å…·åˆ†äº«/" style="font-size: 19.09px;">å·¥å…·åˆ†äº«</a> <a href="/tags/å¹¶å‘ç¼–ç¨‹/" style="font-size: 15.45px;">å¹¶å‘ç¼–ç¨‹</a> <a href="/tags/å¹¶è¡Œè®¡ç®—/" style="font-size: 10px;">å¹¶è¡Œè®¡ç®—</a> <a href="/tags/åºåˆ—åŒ–/" style="font-size: 10px;">åºåˆ—åŒ–</a> <a href="/tags/å»ºç­‘/" style="font-size: 10px;">å»ºç­‘</a> <a href="/tags/å¼€å‘è§„èŒƒ/" style="font-size: 10.45px;">å¼€å‘è§„èŒƒ</a> <a href="/tags/å¼€æºåè®®/" style="font-size: 10px;">å¼€æºåè®®</a> <a href="/tags/æ€§èƒ½æŒ‡æ ‡/" style="font-size: 10px;">æ€§èƒ½æŒ‡æ ‡</a> <a href="/tags/æŠ€æœ¯æ‚è°ˆ/" style="font-size: 20px;">æŠ€æœ¯æ‚è°ˆ</a> <a href="/tags/æ’åº/" style="font-size: 11.82px;">æ’åº</a> <a href="/tags/æ¨é€/" style="font-size: 10px;">æ¨é€</a> <a href="/tags/æœç´¢/" style="font-size: 10px;">æœç´¢</a> <a href="/tags/æ“ä½œç³»ç»Ÿ/" style="font-size: 10.91px;">æ“ä½œç³»ç»Ÿ</a> <a href="/tags/æ•™å¸ˆ/" style="font-size: 10.45px;">æ•™å¸ˆ</a> <a href="/tags/æ•™æ¡ˆ/" style="font-size: 10.45px;">æ•™æ¡ˆ</a> <a href="/tags/æ•°å­¦/" style="font-size: 12.73px;">æ•°å­¦</a> <a href="/tags/æ•°æ®åº“/" style="font-size: 15px;">æ•°æ®åº“</a> <a href="/tags/æ•°ç»„/" style="font-size: 13.64px;">æ•°ç»„</a> <a href="/tags/æ–‡å­—éšè—/" style="font-size: 10px;">æ–‡å­—éšè—</a> <a href="/tags/æ–­ç‚¹ç»­ä¼ /" style="font-size: 10px;">æ–­ç‚¹ç»­ä¼ </a> <a href="/tags/æ–°æµªå¾®åš/" style="font-size: 10px;">æ–°æµªå¾®åš</a> <a href="/tags/æ—¥å¿—/" style="font-size: 10px;">æ—¥å¿—</a> <a href="/tags/æ—¥æœ¬èª/" style="font-size: 14.55px;">æ—¥æœ¬èª</a> <a href="/tags/æ—¥è¨˜/" style="font-size: 10.45px;">æ—¥è¨˜</a> <a href="/tags/æœåŠ¡è‡ªå»º/" style="font-size: 10.91px;">æœåŠ¡è‡ªå»º</a> <a href="/tags/æŸ¥æ‰¾/" style="font-size: 10.91px;">æŸ¥æ‰¾</a> <a href="/tags/æ ˆ/" style="font-size: 10.91px;">æ ˆ</a> <a href="/tags/æ­Œè©/" style="font-size: 10px;">æ­Œè©</a> <a href="/tags/æ­£åˆ™è¡¨è¾¾å¼/" style="font-size: 10.91px;">æ­£åˆ™è¡¨è¾¾å¼</a> <a href="/tags/æ±‡ç¼–è¯­è¨€/" style="font-size: 10px;">æ±‡ç¼–è¯­è¨€</a> <a href="/tags/æµ‹è¯•/" style="font-size: 10px;">æµ‹è¯•</a> <a href="/tags/æ»‘çª—/" style="font-size: 10px;">æ»‘çª—</a> <a href="/tags/ç‰ˆæœ¬æ§åˆ¶/" style="font-size: 10px;">ç‰ˆæœ¬æ§åˆ¶</a> <a href="/tags/ç”Ÿæ´»æ€»ç»“/" style="font-size: 10px;">ç”Ÿæ´»æ€»ç»“</a> <a href="/tags/ç¦åˆ©åˆ†äº«/" style="font-size: 10px;">ç¦åˆ©åˆ†äº«</a> <a href="/tags/ç®—æ³•/" style="font-size: 12.73px;">ç®—æ³•</a> <a href="/tags/ç®—æ³•é¢˜ç›®/" style="font-size: 19.55px;">ç®—æ³•é¢˜ç›®</a> <a href="/tags/ç±»åŠ è½½å™¨/" style="font-size: 10.45px;">ç±»åŠ è½½å™¨</a> <a href="/tags/ç´ æ•°/" style="font-size: 10px;">ç´ æ•°</a> <a href="/tags/çº¿æ€§æ¢æµ‹æ³•/" style="font-size: 10px;">çº¿æ€§æ¢æµ‹æ³•</a> <a href="/tags/çº¿ç¨‹æ± /" style="font-size: 10.91px;">çº¿ç¨‹æ± </a> <a href="/tags/ç¼–è¯‘ä¼˜åŒ–/" style="font-size: 10px;">ç¼–è¯‘ä¼˜åŒ–</a> <a href="/tags/ç¼–è¯‘å™¨/" style="font-size: 10px;">ç¼–è¯‘å™¨</a> <a href="/tags/ç½‘ç›˜/" style="font-size: 10px;">ç½‘ç›˜</a> <a href="/tags/ç½‘ç»œçº¿è·¯/" style="font-size: 10px;">ç½‘ç»œçº¿è·¯</a> <a href="/tags/ç¿»è¨³/" style="font-size: 10.45px;">ç¿»è¨³</a> <a href="/tags/è‡ªå¯åŠ¨/" style="font-size: 10px;">è‡ªå¯åŠ¨</a> <a href="/tags/è’™ç‰¹å¡ç½—æ–¹æ³•/" style="font-size: 10px;">è’™ç‰¹å¡ç½—æ–¹æ³•</a> <a href="/tags/è™šæ‹Ÿæœº/" style="font-size: 10.45px;">è™šæ‹Ÿæœº</a> <a href="/tags/è¡—æ™¯/" style="font-size: 10px;">è¡—æ™¯</a> <a href="/tags/è£…é¥°å™¨æ¨¡å¼/" style="font-size: 10px;">è£…é¥°å™¨æ¨¡å¼</a> <a href="/tags/è®¡ç®—æœºç½‘ç»œ/" style="font-size: 10px;">è®¡ç®—æœºç½‘ç»œ</a> <a href="/tags/è®¾è®¡æ¨¡å¼/" style="font-size: 10px;">è®¾è®¡æ¨¡å¼</a> <a href="/tags/è¯¾ç¨‹/" style="font-size: 10px;">è¯¾ç¨‹</a> <a href="/tags/è´Ÿè½½å‡è¡¡/" style="font-size: 12.27px;">è´Ÿè½½å‡è¡¡</a> <a href="/tags/è´ªå¿ƒ/" style="font-size: 10px;">è´ªå¿ƒ</a> <a href="/tags/è·³è·³è›™æ—¥è¯­è¯»åº“/" style="font-size: 10.45px;">è·³è·³è›™æ—¥è¯­è¯»åº“</a> <a href="/tags/è½¯ä»¶å®‰è£…ä¸é…ç½®/" style="font-size: 17.27px;">è½¯ä»¶å®‰è£…ä¸é…ç½®</a> <a href="/tags/è½¯ä»¶æ¨è/" style="font-size: 15px;">è½¯ä»¶æ¨è</a> <a href="/tags/è½¯ä»¶æµ‹è¯•/" style="font-size: 10.45px;">è½¯ä»¶æµ‹è¯•</a> <a href="/tags/è½¯è€ƒ/" style="font-size: 10px;">è½¯è€ƒ</a> <a href="/tags/è¿›åº¦æ¡/" style="font-size: 10.45px;">è¿›åº¦æ¡</a> <a href="/tags/è¿›ç¨‹é€šä¿¡/" style="font-size: 10px;">è¿›ç¨‹é€šä¿¡</a> <a href="/tags/é€†å‘å·¥ç¨‹/" style="font-size: 10px;">é€†å‘å·¥ç¨‹</a> <a href="/tags/é€’å½’/" style="font-size: 10.45px;">é€’å½’</a> <a href="/tags/é‡å®šå‘/" style="font-size: 10px;">é‡å®šå‘</a> <a href="/tags/é‡è£…ç³»ç»Ÿ/" style="font-size: 10px;">é‡è£…ç³»ç»Ÿ</a> <a href="/tags/é“¾è¡¨/" style="font-size: 13.64px;">é“¾è¡¨</a> <a href="/tags/é˜Ÿåˆ—/" style="font-size: 10px;">é˜Ÿåˆ—</a> <a href="/tags/éšæœºå›¾ç‰‡/" style="font-size: 10px;">éšæœºå›¾ç‰‡</a> <a href="/tags/é›†åˆ/" style="font-size: 14.09px;">é›†åˆ</a> <a href="/tags/é›¶å®½å­—ç¬¦/" style="font-size: 10px;">é›¶å®½å­—ç¬¦</a> <a href="/tags/é™æ€ä»£ç†/" style="font-size: 10px;">é™æ€ä»£ç†</a> <a href="/tags/é¢è¯•æ€»ç»“/" style="font-size: 15px;">é¢è¯•æ€»ç»“</a> <a href="/tags/é¡¹ç›®æ€»ç»“/" style="font-size: 10.91px;">é¡¹ç›®æ€»ç»“</a> <a href="/tags/é¡¹ç›®æ„å»º/" style="font-size: 10.91px;">é¡¹ç›®æ„å»º</a> <a href="/tags/é¡¹ç›®éƒ¨ç½²/" style="font-size: 11.36px;">é¡¹ç›®éƒ¨ç½²</a> <a href="/tags/é»‘è‹¹æœ/" style="font-size: 10px;">é»‘è‹¹æœ</a>
    </div>
    
  </div>

  
  
  <div class="nexmoe-widget-wrap">
    <h3 class="nexmoe-widget-title">æ–‡ç« åˆ†ç±»</h3>
    <div class="nexmoe-widget">

      <ul class="category-list">

        


        

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/ACM/">ACM</a>
          <span class="category-list-count">1</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/Android/">Android</a>
          <span class="category-list-count">2</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/C/">C++</a>
          <span class="category-list-count">16</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/CUDA/">CUDA</a>
          <span class="category-list-count">1</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/Chromeæ‰©å±•/">Chromeæ‰©å±•</a>
          <span class="category-list-count">1</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/ClickHouse/">ClickHouse</a>
          <span class="category-list-count">1</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/Docker/">Docker</a>
          <span class="category-list-count">25</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/Dolt/">Dolt</a>
          <span class="category-list-count">1</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/Dubbo/">Dubbo</a>
          <span class="category-list-count">3</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/ElasticSearch/">ElasticSearch</a>
          <span class="category-list-count">8</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/Electron/">Electron</a>
          <span class="category-list-count">2</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/Git/">Git</a>
          <span class="category-list-count">6</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/Github/">Github</a>
          <span class="category-list-count">5</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/Golang/">Golang</a>
          <span class="category-list-count">31</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/GraalVM/">GraalVM</a>
          <span class="category-list-count">1</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/IOåŸºç¡€/">IOåŸºç¡€</a>
          <span class="category-list-count">4</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/Java/">Java</a>
          <span class="category-list-count">4</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/Javaæºç /">Javaæºç </a>
          <span class="category-list-count">16</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/JuiceFS/">JuiceFS</a>
          <span class="category-list-count">1</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/Kubernetes/">Kubernetes</a>
          <span class="category-list-count">12</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/Life/">Life</a>
          <span class="category-list-count">1</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/Linux/">Linux</a>
          <span class="category-list-count">16</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/Maven/">Maven</a>
          <span class="category-list-count">2</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/MongoDB/">MongoDB</a>
          <span class="category-list-count">2</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/MySQL/">MySQL</a>
          <span class="category-list-count">1</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/Mybatis/">Mybatis</a>
          <span class="category-list-count">3</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/NPM/">NPM</a>
          <span class="category-list-count">1</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/Netty/">Netty</a>
          <span class="category-list-count">1</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/Nginx/">Nginx</a>
          <span class="category-list-count">3</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/Node-js/">Node.js</a>
          <span class="category-list-count">3</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/PostgreSQL/">PostgreSQL</a>
          <span class="category-list-count">2</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/Protobuf/">Protobuf</a>
          <span class="category-list-count">1</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/Python/">Python</a>
          <span class="category-list-count">1</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/Redash/">Redash</a>
          <span class="category-list-count">1</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/Docker/Redis/">Redis</a>
          <span class="category-list-count">2</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/Ruby/">Ruby</a>
          <span class="category-list-count">1</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/Rust/">Rust</a>
          <span class="category-list-count">35</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/Spring/">Spring</a>
          <span class="category-list-count">5</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/TOML/">TOML</a>
          <span class="category-list-count">1</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/TypeScript/">TypeScript</a>
          <span class="category-list-count">1</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/Websocket/">Websocket</a>
          <span class="category-list-count">1</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/äººå·¥æ™ºèƒ½/">äººå·¥æ™ºèƒ½</a>
          <span class="category-list-count">2</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/äººç”Ÿæ—¥è®°/">äººç”Ÿæ—¥è®°</a>
          <span class="category-list-count">27</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/åˆ†å¸ƒå¼/">åˆ†å¸ƒå¼</a>
          <span class="category-list-count">10</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/åŠå…¬/">åŠå…¬</a>
          <span class="category-list-count">1</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/åšå®¢ç®¡ç†/">åšå®¢ç®¡ç†</a>
          <span class="category-list-count">6</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/Mybatis/æŠ€æœ¯æ‚è°ˆ/å­¦ä¹ æ¡ˆä¾‹/">å­¦ä¹ æ¡ˆä¾‹</a>
          <span class="category-list-count">2</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/å·¥å…·åˆ†äº«/">å·¥å…·åˆ†äº«</a>
          <span class="category-list-count">41</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/å¹¶å‘ç¼–ç¨‹/">å¹¶å‘ç¼–ç¨‹</a>
          <span class="category-list-count">13</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/Mybatis/æŠ€æœ¯æ‚è°ˆ/">æŠ€æœ¯æ‚è°ˆ</a>
          <span class="category-list-count">2</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/æ•™å¸ˆ/">æ•™å¸ˆ</a>
          <span class="category-list-count">2</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/æ•°æ®åº“/">æ•°æ®åº“</a>
          <span class="category-list-count">8</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/æ—¥æœ¬èª/">æ—¥æœ¬èª</a>
          <span class="category-list-count">11</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/æœåŠ¡è‡ªå»º/">æœåŠ¡è‡ªå»º</a>
          <span class="category-list-count">3</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/æ±‡ç¼–è¯­è¨€/">æ±‡ç¼–è¯­è¨€</a>
          <span class="category-list-count">1</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/ç®—æ³•/">ç®—æ³•</a>
          <span class="category-list-count">5</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/ç®—æ³•é¢˜ç›®/">ç®—æ³•é¢˜ç›®</a>
          <span class="category-list-count">60</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/è¯¾ç¨‹/">è¯¾ç¨‹</a>
          <span class="category-list-count">1</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/Redis/è½¯ä»¶å®‰è£…ä¸é…ç½®/">è½¯ä»¶å®‰è£…ä¸é…ç½®</a>
          <span class="category-list-count">2</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/è½¯ä»¶æµ‹è¯•/">è½¯ä»¶æµ‹è¯•</a>
          <span class="category-list-count">2</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/è½¯è€ƒ/">è½¯è€ƒ</a>
          <span class="category-list-count">1</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/é¢è¯•æ€»ç»“/">é¢è¯•æ€»ç»“</a>
          <span class="category-list-count">15</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/é¡¹ç›®æ€»ç»“/">é¡¹ç›®æ€»ç»“</a>
          <span class="category-list-count">3</span>
        </li>

        
      </ul>

    </div>
  </div>


  
  
  <div class="nexmoe-widget-wrap">
    <h3 class="nexmoe-widget-title">æœ€æ–°æ–‡ç« </h3>
    <div class="nexmoe-widget">
      <ul>
        
          <li>
            <a href="/2026/02/10/å†è§2025ï¼Œä½ å¥½2026ï¼/">å†è§2025ï¼Œä½ å¥½2026ï¼</a>
          </li>
        
          <li>
            <a href="/2025/08/20/ä¸‹ä¸€ä»£æç¤ºè¯å·¥ç¨‹è¯­è¨€POMLç®€æ˜æ•™ç¨‹/">ä¸‹ä¸€ä»£æç¤ºè¯å·¥ç¨‹è¯­è¨€POMLç®€æ˜æ•™ç¨‹</a>
          </li>
        
          <li>
            <a href="/2025/07/30/å¼€äº†ä¸€ä¸ªæ–°çš„ä¸“é—¨å­¦ä¹ æ—¥è¯­çš„åšå®¢/">å¼€äº†ä¸€ä¸ªæ–°çš„ä¸“é—¨å­¦ä¹ æ—¥è¯­çš„åšå®¢</a>
          </li>
        
          <li>
            <a href="/2025/07/29/ä¸€ã€å¹¶è¡Œç¼–ç¨‹å¯¼è®ºä¸CUDAå…¥é—¨/">ä¸€ã€å¹¶è¡Œç¼–ç¨‹å¯¼è®ºä¸CUDAå…¥é—¨</a>
          </li>
        
          <li>
            <a href="/2025/07/24/ä¸€äº›å…è´¹çš„GPUèµ„æº/">ä¸€äº›å…è´¹çš„GPUèµ„æº</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
    <div class="nexmoe-copyright">
        <span style="color:#707070;font-size: 14px;">
            æœ¬ç«™æ€»è®¿é—®é‡<span id="busuanzi_value_site_pv"></span>æ¬¡ <br>
            æœ¬ç«™è®¿å®¢æ•°<span id="busuanzi_value_site_uv"></span>äººæ¬¡ <br>
        </span>
        <span id="showsectime" style="color:#707070;font-size: 14px;">
            æœ¬ç«™å·²è¿è¡Œ0å¤©0å°æ—¶0åˆ†0ç§’
        </span>
        <i class="fa fa-heart throb" style="color:#d43f57">â¤</i><br>

        &copy; 2026 Jasonkay
        Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
        & <a href="https://nexmoe.com/hexo-theme-nexmoe.html" target="_blank">Nexmoe</a>
    </div>

    <div id="footer-info">

    </div>

    <script type="text/javascript">
        function NewDate(str) {
            str = str.split('-');
            var date = new Date();
            date.setUTCFullYear(str[0], str[1] - 1, str[2]);
            date.setUTCHours(0, 0, 0, 0);
            return date;
        }
        function showsectime() {
            var birthDay = NewDate("2019-09-01");
            var today = new Date();
            var timeold = today.getTime() - birthDay.getTime();
            var sectimeold = timeold / 1000
            var secondsold = Math.floor(sectimeold);
            var msPerDay = 24 * 60 * 60 * 1000; var e_daysold = timeold / msPerDay;
            var daysold = Math.floor(e_daysold);
            var e_hrsold = (daysold - e_daysold) * -24;
            var hrsold = Math.floor(e_hrsold);
            var e_minsold = (hrsold - e_hrsold) * -60;
            var minsold = Math.floor((hrsold - e_hrsold) * -60); var seconds = Math.floor((minsold - e_minsold) * -60).toString();
            document.getElementById("showsectime").innerHTML = "æœ¬ç«™å·²è¿è¡Œ" + daysold + "å¤©" + hrsold + "å°æ—¶" + minsold + "åˆ†" + seconds + "ç§’";
            setTimeout(showsectime, 1000);
        }
        showsectime();
    </script>

</div><!-- .nexmoe-drawer -->
  </div>
  <div id="nexmoe-content">
    <div class="nexmoe-primary">
      <div class="nexmoe-post">
  <div class="nexmoe-post-cover">
    
    <img src="https://img.paulzzh.com/touhou/random?22">
    
    <h1>Javaçº¿ç¨‹æ± ThreadPoolExecutoråˆ†æä¸å®æˆ˜ç»ˆ</h1>
  </div>
  <div class="nexmoe-post-meta">
    <a><i class="nexmoefont icon-calendar-fill"></i>2020å¹´03æœˆ05æ—¥</a>
    <a><i class="nexmoefont icon-areachart"></i>22.7k å­—</a>
    <a><i class="nexmoefont icon-areachart"></i><span class="archive-article-date">é˜…è¯»é‡<span id="busuanzi_value_page_pv"></span>
      </span></a>
    <a><i class="nexmoefont icon-time-circle-fill"></i>å¤§æ¦‚ 105 åˆ†é’Ÿ</a>

    
    <a class="nexmoefont icon-appstore-fill -link" href="/categories/å¹¶å‘ç¼–ç¨‹/">å¹¶å‘ç¼–ç¨‹</a>
    
    
    <a class="nexmoefont icon-tag-fill -link" href="/tags/Javaæºç /">Javaæºç </a> <a class="nexmoefont icon-tag-fill -link" href="/tags/å¹¶å‘ç¼–ç¨‹/">å¹¶å‘ç¼–ç¨‹</a> <a class="nexmoefont icon-tag-fill -link" href="/tags/çº¿ç¨‹æ± /">çº¿ç¨‹æ± </a>
    
  </div>
  <article>
    
    <div id="toc" class="toc-article">
      <ul class="markdownIt-TOC">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Javaçº¿ç¨‹æ± ThreadPoolExecutoråˆ†æä¸å®æˆ˜ç»ˆ"><span class="toc-text">Javaçº¿ç¨‹æ± ThreadPoolExecutoråˆ†æä¸å®æˆ˜ç»ˆ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ThreadPoolExecutor"><span class="toc-text">ThreadPoolExecutor</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ä¸€-ctlå±æ€§"><span class="toc-text">ä¸€.ctlå±æ€§</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#äºŒ-å…¶ä»–å±æ€§"><span class="toc-text">äºŒ.å…¶ä»–å±æ€§</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ä¸‰-ä»»åŠ¡æäº¤å†…éƒ¨åŸç†"><span class="toc-text">ä¸‰.ä»»åŠ¡æäº¤å†…éƒ¨åŸç†</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#å››-å†…éƒ¨ç±»Worker"><span class="toc-text">å››.å†…éƒ¨ç±»Worker</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#runWorker-æ‰§è¡Œä»»åŠ¡"><span class="toc-text">runWorker()æ‰§è¡Œä»»åŠ¡</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#getTask-è·å–ä»»åŠ¡"><span class="toc-text">getTask()è·å–ä»»åŠ¡</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#processWorkerExit-workerçº¿ç¨‹é€€å‡º"><span class="toc-text">processWorkerExit() workerçº¿ç¨‹é€€å‡º</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#äº”-çº¿ç¨‹æ± ç»ˆæ­¢"><span class="toc-text">äº”.çº¿ç¨‹æ± ç»ˆæ­¢</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#shutdown-æ¸©æŸ”çš„ç»ˆæ­¢çº¿ç¨‹æ± "><span class="toc-text">shutdown()æ¸©æŸ”çš„ç»ˆæ­¢çº¿ç¨‹æ± </span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#shutdownNow-å¼ºç¡¬çš„ç»ˆæ­¢çº¿ç¨‹æ± "><span class="toc-text">shutdownNow()å¼ºç¡¬çš„ç»ˆæ­¢çº¿ç¨‹æ± </span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#awaitTermination-ç­‰å¾…çº¿ç¨‹æ± ç»ˆæ­¢"><span class="toc-text">awaitTermination()ç­‰å¾…çº¿ç¨‹æ± ç»ˆæ­¢</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#å…­-çº¿ç¨‹æ± çš„ç›‘æ§"><span class="toc-text">å…­.çº¿ç¨‹æ± çš„ç›‘æ§</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#æ€»ç»“"><span class="toc-text">æ€»ç»“</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#é™„å½•"><span class="toc-text">é™„å½•</span></a></li></ol>
      </ul>
    </div>
    
    <p>å‰é¢ä¸¤ç¯‡æ–‡ç« åˆ†æäº†Javaä¸­å‡ ç§å¸¸è§çš„çº¿ç¨‹æ± , ä¸‹é¢æˆ‘ä»¬é€šè¿‡æºç æ¥çœ‹ä¸€çœ‹ä»–ä»¬ç©¶ç«Ÿåœ¨æœ€åº•å±‚æ˜¯æ€ä¹ˆå®ç°çš„</p>
<p>æœ¬æ–‡å†…å®¹åŒ…æ‹¬:</p>
<ul>
<li>ctlå±æ€§;</li>
<li>ThreadPoolExecutorä¸­å…¶ä»–å±æ€§;</li>
<li>ä»»åŠ¡æäº¤çš„å®ç°;</li>
<li>å†…éƒ¨ç±»Worker(ä»»åŠ¡æ‰§è¡Œ, ç»ˆæ­¢)</li>
<li>çº¿ç¨‹æ± ç»ˆæ­¢</li>
<li>çº¿ç¨‹æ± çš„ç›‘æ§</li>
<li>çº¿ç¨‹æ± çš„å®‰æ’</li>
</ul>
<br>

<p>æºä»£ç åˆ†æåŸºäºJDK11.0.5</p>
<p>å¦‚æœè§‰å¾—æ–‡ç« å†™çš„ä¸é”™, å¯ä»¥å…³æ³¨å¾®ä¿¡å…¬ä¼—å·: Coderå¼ å°å‡¯</p>
<p>å†…å®¹å’Œåšå®¢åŒæ­¥æ›´æ–°~</p>
<br>

<p>ç³»åˆ—æ–‡ç« å…¥å£:</p>
<ul>
<li><a href="https://jasonkayzk.github.io/2020/02/06/Javaçº¿ç¨‹æ± ThreadPoolExecutoråˆ†æä¸å®æˆ˜/">Javaçº¿ç¨‹æ± ThreadPoolExecutoråˆ†æä¸å®æˆ˜</a></li>
<li><a href="https://jasonkayzk.github.io/2020/03/04/Javaçº¿ç¨‹æ± ThreadPoolExecutoråˆ†æä¸å®æˆ˜ç»­/">Javaçº¿ç¨‹æ± ThreadPoolExecutoråˆ†æä¸å®æˆ˜ç»­</a></li>
<li><a href="https://jasonkayzk.github.io/2020/03/05/Javaçº¿ç¨‹æ± ThreadPoolExecutoråˆ†æä¸å®æˆ˜ç»ˆ/">Javaçº¿ç¨‹æ± ThreadPoolExecutoråˆ†æä¸å®æˆ˜ç»ˆ</a></li>
</ul>
<br>

<a id="more"></a>

<h2 id="Javaçº¿ç¨‹æ± ThreadPoolExecutoråˆ†æä¸å®æˆ˜ç»ˆ"><a href="#Javaçº¿ç¨‹æ± ThreadPoolExecutoråˆ†æä¸å®æˆ˜ç»ˆ" class="headerlink" title="Javaçº¿ç¨‹æ± ThreadPoolExecutoråˆ†æä¸å®æˆ˜ç»ˆ"></a>Javaçº¿ç¨‹æ± ThreadPoolExecutoråˆ†æä¸å®æˆ˜ç»ˆ</h2><p>ä¸Šä¸€ç¯‡è®²è§£äº†Executor, ExecutorSerivceå’ŒAbstractExecutorServiceçš„æºç </p>
<p>ç„¶åJavaä¸­å­˜åœ¨çš„4ç§çº¿ç¨‹æ± çš„å·¥ä½œåŸç†, è¶çƒ­æ‰“é“, ä¸‹é¢çœ‹ä¸€çœ‹ThreadPoolExecutorçš„æºç </p>
<br>

<h2 id="ThreadPoolExecutor"><a href="#ThreadPoolExecutor" class="headerlink" title="ThreadPoolExecutor"></a>ThreadPoolExecutor</h2><p>ThreadPoolExecutorçš„æºç å¦‚ä¸‹, ä¸€å…±2100è¡Œ, æˆ‘ä»¬æ…¢æ…¢ç†è§£:</p>
<pre><code class="java">package java.util.concurrent;

import java.util.ArrayList;
import java.util.ConcurrentModificationException;
import java.util.HashSet;
import java.util.Iterator;
import java.util.List;
import java.util.concurrent.atomic.AtomicInteger;
import java.util.concurrent.locks.AbstractQueuedSynchronizer;
import java.util.concurrent.locks.Condition;
import java.util.concurrent.locks.ReentrantLock;

/**
 * ä¸€ç§ExecutorService
 * å®ƒä½¿ç”¨å‡ ä¸ªæ± çº¿ç¨‹ç±»å‹ä¸­çš„ä¸€ä¸ªæ‰§è¡Œæ¯ä¸ªæäº¤çš„ä»»åŠ¡
 * é€šå¸¸ä½¿ç”¨Executorså·¥å‚æ–¹æ³•é…ç½®åˆ›å»º
 *
 * An {@link ExecutorService} that executes each submitted task using
 * one of possibly several pooled threads, normally configured
 * using {@link Executors} factory methods.
 *
 * çº¿ç¨‹æ± è§£å†³äº†ä¸¤ä¸ªä¸åŒçš„é—®é¢˜: 
 * 1.å®ƒä»¬é€šå¸¸åœ¨æ‰§è¡Œå¤§é‡å¼‚æ­¥ä»»åŠ¡æ—¶æä¾›æ›´å¥½çš„æ€§èƒ½ï¼Œè¿™æ˜¯ç”±äºå‡å°‘äº†æ¯ä¸ªä»»åŠ¡çš„è°ƒç”¨å¼€é”€;
 * 2.å¹¶ä¸”å®ƒä»¬æä¾›äº†ä¸€ç§é™åˆ¶å’Œç®¡ç†èµ„æº(åŒ…æ‹¬æ‰§è¡Œä»»åŠ¡é›†åˆæ—¶æ¶ˆè€—çš„çº¿ç¨‹)çš„æ–¹æ³•
 *
 * æ¯ä¸ªThreadPoolExecutorè¿˜ç»´æŠ¤ä¸€äº›åŸºæœ¬ç»Ÿè®¡ä¿¡æ¯ï¼Œä¾‹å¦‚å·²å®Œæˆçš„ä»»åŠ¡æ•°
 *
 * &lt;p&gt;Thread pools address two different problems: they usually
 * provide improved performance when executing large numbers of
 * asynchronous tasks, due to reduced per-task invocation overhead,
 * and they provide a means of bounding and managing the resources,
 * including threads, consumed when executing a collection of tasks.
 * Each {@code ThreadPoolExecutor} also maintains some basic
 * statistics, such as the number of completed tasks.
 *
 * ä¸ºäº†åœ¨å„ç§ä¸Šä¸‹æ–‡ä¸­(åœºæ™¯)ä½¿ç”¨
 * è¿™ä¸ªç±»æä¾›äº†è®¸å¤šå¯è°ƒæ•´çš„å‚æ•°å’Œå¯æ‰©å±•çš„hookæ–¹æ³•
 * ä½†æ˜¯ï¼Œç¨‹åºå‘˜åº”è¯¥ä½¿ç”¨æ›´æ–¹ä¾¿çš„Executorså·¥å‚æ–¹æ³•
 * 1.Executors{newCachedThreadPool}ï¼ˆæ— é™åˆ¶çº¿ç¨‹æ± ï¼Œè‡ªåŠ¨å›æ”¶çº¿ç¨‹ï¼‰
 * 2.Executors{newFixedThreadPool}ï¼ˆå›ºå®šå¤§å°çš„çº¿ç¨‹æ± ï¼‰
 * 3.Executors{newSingleThreadExecutor}ï¼ˆå•åå°çº¿ç¨‹ï¼‰
 * ä¸ºæœ€å¸¸è§çš„ä½¿ç”¨åœºæ™¯é¢„å…ˆé…ç½®è®¾ç½®
 *
 * å¦åˆ™ï¼Œåœ¨æ‰‹åŠ¨é…ç½®å’Œè°ƒæ•´æ­¤ç±»æ—¶ï¼Œè¯·ä½¿ç”¨ä»¥ä¸‹æŒ‡å—:
 *
 * &lt;p&gt;To be useful across a wide range of contexts, this class
 * provides many adjustable parameters and extensibility
 * hooks. However, programmers are urged to use the more convenient
 * {@link Executors} factory methods {@link
 * Executors#newCachedThreadPool} (unbounded thread pool, with
 * automatic thread reclamation), {@link Executors#newFixedThreadPool}
 * (fixed size thread pool) and {@link
 * Executors#newSingleThreadExecutor} (single background thread), that
 * preconfigure settings for the most common usage
 * scenarios. Otherwise, use the following guide when manually
 * configuring and tuning this class:
 *
 * &lt;dl&gt;
 *
 * æ ¸å¿ƒæ± å’Œæœ€å¤§æ± å¤§å°
 *
 * &lt;dt&gt;Core and maximum pool sizes&lt;/dt&gt;
 *
 * ThreadPoolExecutorå°†æ ¹æ®:
 * corePoolSizeå’ŒmaximumPoolSizeè®¾ç½®çš„ç•Œé™è‡ªåŠ¨è°ƒæ•´æ± å¤§å°
 *
 * &lt;dd&gt;A {@code ThreadPoolExecutor} will automatically adjust the
 * pool size (see {@link #getPoolSize})
 * according to the bounds set by
 * corePoolSize (see {@link #getCorePoolSize}) and
 * maximumPoolSize (see {@link #getMaximumPoolSize}).
 *
 * åœ¨æ–¹æ³•execute(Runnable)ä¸­æäº¤æ–°ä»»åŠ¡æ—¶
 * å¦‚æœæ­£åœ¨è¿è¡Œçš„çº¿ç¨‹å°‘äºcorePoolSizeï¼Œåˆ™ä¼šåˆ›å»ºä¸€ä¸ªæ–°çº¿ç¨‹æ¥å¤„ç†è¯¥è¯·æ±‚
 * (å³ä½¿å…¶ä»–å·¥ä½œçº¿ç¨‹å¤„äºç©ºé—²çŠ¶æ€)
 *
 * å¦åˆ™ï¼Œå¦‚æœè¿è¡Œçš„çº¿ç¨‹å°‘äºmaximumPoolSizeï¼Œåˆ™ä»…å½“é˜Ÿåˆ—å·²æ»¡æ—¶ï¼Œæ‰ä¼šåˆ›å»ºä¸€ä¸ªæ–°çº¿ç¨‹æ¥å¤„ç†è¯¥è¯·æ±‚
 * 1.é€šè¿‡å°†corePoolSizeå’ŒmaximumPoolSizeè®¾ç½®ä¸ºç›¸åŒçš„å€¼ï¼Œå¯ä»¥åˆ›å»ºä¸€ä¸ªå›ºå®šå¤§å°çš„çº¿ç¨‹æ± 
 * 2.é€šè¿‡å°†maximumPoolSizeè®¾ç½®ä¸ºæœ¬è´¨ä¸Šæ— è¾¹ç•Œçš„å€¼ï¼Œä¾‹å¦‚Integer.MAX_valueï¼Œå¯ä»¥å…è®¸æ± å®¹çº³ä»»æ„æ•°é‡çš„å¹¶å‘ä»»åŠ¡
 * æœ€å…¸å‹çš„æƒ…å†µæ˜¯ï¼Œæ ¸å¿ƒæ± å’Œæœ€å¤§æ± å¤§å°ä»…åœ¨æ„é€ æ—¶è®¾ç½®
 * ä½†ä¹Ÿå¯ä»¥ä½¿ç”¨setCorePoolSizeå’ŒsetMaximumPoolSizeåŠ¨æ€æ›´æ”¹å®ƒä»¬
 *
 * When a new task is submitted in method {@link #execute(Runnable)},
 * if fewer than corePoolSize threads are running, a new thread is
 * created to handle the request, even if other worker threads are
 * idle.  Else if fewer than maximumPoolSize threads are running, a
 * new thread will be created to handle the request only if the queue
 * is full.  By setting corePoolSize and maximumPoolSize the same, you
 * create a fixed-size thread pool. By setting maximumPoolSize to an
 * essentially unbounded value such as {@code Integer.MAX_VALUE}, you
 * allow the pool to accommodate an arbitrary number of concurrent
 * tasks. Most typically, core and maximum pool sizes are set only
 * upon construction, but they may also be changed dynamically using
 * {@link #setCorePoolSize} and {@link #setMaximumPoolSize}. &lt;/dd&gt;
 *
 * æŒ‰éœ€æ„é€ 
 *
 * &lt;dt&gt;On-demand construction&lt;/dt&gt;
 *
 * é»˜è®¤æƒ…å†µä¸‹ï¼Œå³ä½¿æ ¸å¿ƒçº¿ç¨‹æœ€åˆä¹Ÿæ˜¯åœ¨æ–°ä»»åŠ¡åˆ°è¾¾æ—¶åˆ›å»ºå’Œå¯åŠ¨çš„
 * ä¹Ÿå¯ä»¥ä½¿ç”¨æ–¹æ³•prestartCoreThreadæˆ–prestartcorethreadsåŠ¨æ€é‡å†™
 * å¦‚æœä½¿ç”¨éç©ºé˜Ÿåˆ—æ„é€ çº¿ç¨‹æ± ï¼Œåˆ™å¯èƒ½éœ€è¦é¢„å¯åŠ¨çº¿ç¨‹
 *
 * &lt;dd&gt;By default, even core threads are initially created and
 * started only when new tasks arrive, but this can be overridden
 * dynamically using method {@link #prestartCoreThread} or {@link
 * #prestartAllCoreThreads}.  You probably want to prestart threads if
 * you construct the pool with a non-empty queue. &lt;/dd&gt;
 *
 * åˆ›å»ºæ–°çº¿ç¨‹
 *
 * &lt;dt&gt;Creating new threads&lt;/dt&gt;
 *
 * ä½¿ç”¨ThreadFactoryåˆ›å»ºæ–°çº¿ç¨‹
 * å¦‚æœæœªå¦è¡ŒæŒ‡å®šï¼Œåˆ™ä½¿ç”¨Executors.defaultThreadFactory
 * å®ƒåˆ›å»ºçš„çº¿ç¨‹éƒ½å¤„äºç›¸åŒçš„ThreadGroupï¼Œå¹¶ä¸”å…·æœ‰ç›¸åŒçš„NORM_PRIORITYä¼˜å…ˆçº§å’Œéå®ˆæŠ¤è¿›ç¨‹çŠ¶æ€
 * é€šè¿‡æä¾›ä¸åŒçš„ThreadFactoryï¼Œå¯ä»¥æ›´æ”¹çº¿ç¨‹çš„åç§°ã€çº¿ç¨‹ç»„ã€ä¼˜å…ˆçº§ã€å®ˆæŠ¤è¿›ç¨‹çŠ¶æ€ç­‰
 * 
 * å¦‚æœThreadFactoryåœ¨ä»newThreadè¿”å›nullæ—¶æ— æ³•åˆ›å»ºçº¿ç¨‹ï¼Œåˆ™æ‰§è¡Œå™¨å°†ç»§ç»­ï¼Œä½†å¯èƒ½æ— æ³•æ‰§è¡Œä»»ä½•ä»»åŠ¡
 * çº¿ç¨‹åº”è¯¥æ‹¥æœ‰modifyThread(RuntimePermission)
 * å¦‚æœå·¥ä½œçº¿ç¨‹æˆ–ä½¿ç”¨æ± çš„å…¶ä»–çº¿ç¨‹ä¸å…·æœ‰æ­¤æƒé™ï¼Œåˆ™æœåŠ¡å¯èƒ½ä¼šé™çº§:
 * é…ç½®æ›´æ”¹å¯èƒ½ä¸ä¼šåŠæ—¶ç”Ÿæ•ˆï¼Œå…³é—­æ± å¯èƒ½ä»å¤„äºå¯ä»¥ç»ˆæ­¢ä½†æœªå®Œæˆçš„çŠ¶æ€
 *
 * &lt;dd&gt;New threads are created using a {@link ThreadFactory}.  If not
 * otherwise specified, a {@link Executors#defaultThreadFactory} is
 * used, that creates threads to all be in the same {@link
 * ThreadGroup} and with the same {@code NORM_PRIORITY} priority and
 * non-daemon status. By supplying a different ThreadFactory, you can
 * alter the thread&#39;s name, thread group, priority, daemon status,
 * etc. If a {@code ThreadFactory} fails to create a thread when asked
 * by returning null from {@code newThread}, the executor will
 * continue, but might not be able to execute any tasks. Threads
 * should possess the &quot;modifyThread&quot; {@code RuntimePermission}. If
 * worker threads or other threads using the pool do not possess this
 * permission, service may be degraded: configuration changes may not
 * take effect in a timely manner, and a shutdown pool may remain in a
 * state in which termination is possible but not completed.&lt;/dd&gt;
 *
 * çº¿ç¨‹ç”Ÿå­˜æ—¶é—´
 *
 * &lt;dt&gt;Keep-alive times&lt;/dt&gt;
 *
 * å¦‚æœæ± å½“å‰æœ‰å¤šä¸ªcorePoolSizeçº¿ç¨‹ï¼Œåˆ™å¦‚æœå¤šä½™çš„çº¿ç¨‹ç©ºé—²æ—¶é—´è¶…è¿‡keepAliveTimeï¼Œåˆ™å°†ç»ˆæ­¢è¿™äº›çº¿ç¨‹
 * è¿™æä¾›äº†ä¸€ç§åœ¨æ± æœªè¢«ç§¯æä½¿ç”¨æ—¶å‡å°‘èµ„æºæ¶ˆè€—çš„æ–¹æ³•
 * å¦‚æœçº¿ç¨‹æ± ç¨åå˜å¾—æ›´ä¸ºæ´»è·ƒï¼Œåˆ™å°†æ„é€ æ–°çº¿ç¨‹
 * ä¹Ÿå¯ä»¥ä½¿ç”¨æ–¹æ³•setKeepAliveTime(longï¼ŒTimeUnit)åŠ¨æ€æ›´æ”¹æ­¤å‚æ•°
 * 
 * ä½¿ç”¨Long.MAX_value, TimeUnit.NANOSECONDSçš„å€¼å¯ä»¥æœ‰æ•ˆåœ°ç¦æ­¢ç©ºé—²çº¿ç¨‹åœ¨å…³é—­ä¹‹å‰ç»ˆæ­¢
 * é»˜è®¤æƒ…å†µä¸‹ï¼Œkeep-aliveç­–ç•¥ä»…åœ¨å­˜åœ¨å¤šä¸ªcorePoolSizeçº¿ç¨‹æ—¶åº”ç”¨
 * ä½†æ˜¯åªè¦keep alive timeå€¼éé›¶ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨æ–¹æ³•allowCoreThreadTimeOut(true)
 * å°†æ­¤è¶…æ—¶ç­–ç•¥åº”ç”¨äºæ ¸å¿ƒçº¿ç¨‹
 *
 * &lt;dd&gt;If the pool currently has more than corePoolSize threads,
 * excess threads will be terminated if they have been idle for more
 * than the keepAliveTime (see {@link #getKeepAliveTime(TimeUnit)}).
 * This provides a means of reducing resource consumption when the
 * pool is not being actively used. If the pool becomes more active
 * later, new threads will be constructed. This parameter can also be
 * changed dynamically using method {@link #setKeepAliveTime(long,
 * TimeUnit)}.  Using a value of {@code Long.MAX_VALUE} {@link
 * TimeUnit#NANOSECONDS} effectively disables idle threads from ever
 * terminating prior to shut down. By default, the keep-alive policy
 * applies only when there are more than corePoolSize threads, but
 * method {@link #allowCoreThreadTimeOut(boolean)} can be used to
 * apply this time-out policy to core threads as well, so long as the
 * keepAliveTime value is non-zero. &lt;/dd&gt;
 *
 * é˜Ÿåˆ—
 *
 * &lt;dt&gt;Queuing&lt;/dt&gt;
 *
 * ä»»ä½•BlockingQueueéƒ½å¯ä»¥ç”¨æ¥ä¼ è¾“å’Œä¿å­˜æäº¤çš„ä»»åŠ¡, æ­¤é˜Ÿåˆ—çš„ä½¿ç”¨ä¸æ± å¤§å°æœ‰å…³ï¼š
 *
 * &lt;dd&gt;Any {@link BlockingQueue} may be used to transfer and hold
 * submitted tasks.  The use of this queue interacts with pool sizing:
 *
 * &lt;ul&gt;
 *
 * å¦‚æœè¿è¡Œçš„çº¿ç¨‹å°‘äºcorePoolSizeï¼Œåˆ™æ‰§è¡Œå™¨æ€»æ˜¯å€¾å‘äºæ·»åŠ æ–°çº¿ç¨‹ï¼Œè€Œä¸æ˜¯æ’é˜Ÿ 
 *
 * &lt;li&gt;If fewer than corePoolSize threads are running, the Executor
 * always prefers adding a new thread
 * rather than queuing.
 *
 * å¦‚æœcorePoolSizeæˆ–æ›´å¤šçº¿ç¨‹æ­£åœ¨è¿è¡Œï¼Œåˆ™æ‰§è¡Œå™¨æ€»æ˜¯å¸Œæœ›å°†è¯·æ±‚æ’é˜Ÿï¼Œè€Œä¸æ˜¯æ·»åŠ æ–°çº¿ç¨‹
 *
 * &lt;li&gt;If corePoolSize or more threads are running, the Executor
 * always prefers queuing a request rather than adding a new
 * thread.
 *
 * å¦‚æœè¯·æ±‚ä¸èƒ½æ’é˜Ÿï¼Œåˆ™åˆ›å»ºä¸€ä¸ªæ–°çº¿ç¨‹
 * é™¤éè¯¥çº¿ç¨‹è¶…è¿‡maximumPoolSizeï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä»»åŠ¡å°†è¢«æ‹’ç»
 *
 * &lt;li&gt;If a request cannot be queued, a new thread is created unless
 * this would exceed maximumPoolSize, in which case, the task will be
 * rejected.
 *
 * &lt;/ul&gt;
 *
 * æ’é˜Ÿçš„ä¸€èˆ¬ç­–ç•¥æœ‰ä¸‰ç§ï¼š
 *
 * There are three general strategies for queuing:
 * &lt;ol&gt;
 *
 * ç›´æ¥äº¤æ¥
 * å·¥ä½œé˜Ÿåˆ—çš„ä¸€ä¸ªå¾ˆå¥½çš„é»˜è®¤é€‰æ‹©æ˜¯SynchronousQueueï¼Œå®ƒå°†ä»»åŠ¡ç›´æ¥äº¤ç»™çº¿ç¨‹ï¼Œè€Œä¸å¿…ä¿å­˜å®ƒä»¬
 * åœ¨è¿™é‡Œï¼Œå¦‚æœæ²¡æœ‰çº¿ç¨‹å¯ä»¥ç«‹å³è¿è¡Œä»»åŠ¡ï¼Œåˆ™å°è¯•å¯¹ä»»åŠ¡è¿›è¡Œæ’é˜Ÿå°†å¤±è´¥ï¼Œå› æ­¤å°†æ„é€ ä¸€ä¸ªæ–°çº¿ç¨‹
 * æ­¤ç­–ç•¥åœ¨å¤„ç†å¯èƒ½å…·æœ‰å†…éƒ¨ä¾èµ–é¡¹çš„è¯·æ±‚é›†æ—¶é¿å…é”å®š
 * ç›´æ¥åˆ‡æ¢é€šå¸¸éœ€è¦æ— é™çš„é˜Ÿåˆ—å¤§å°ï¼Œä»¥é¿å…æ‹’ç»æ–°æäº¤çš„ä»»åŠ¡
 * è¿™åè¿‡æ¥åˆé€ æˆäº†å½“å‘½ä»¤çš„å¹³å‡åˆ°è¾¾é€Ÿåº¦è¶…è¿‡å¯ä»¥å¤„ç†çš„é€Ÿåº¦æ—¶ï¼Œæ— é™çº¿ç¨‹å¢é•¿çš„å¯èƒ½æ€§
 *
 * &lt;li&gt;&lt;em&gt; Direct handoffs.&lt;/em&gt; A good default choice for a work
 * queue is a {@link SynchronousQueue} that hands off tasks to threads
 * without otherwise holding them. Here, an attempt to queue a task
 * will fail if no threads are immediately available to run it, so a
 * new thread will be constructed. This policy avoids lockups when
 * handling sets of requests that might have internal dependencies.
 * Direct handoffs generally require unbounded maximumPoolSizes to
 * avoid rejection of new submitted tasks. This in turn admits the
 * possibility of unbounded thread growth when commands continue to
 * arrive on average faster than they can be processed.
 *
 * æ— ç•Œé˜Ÿåˆ—
 * ä½¿ç”¨æ— ç•Œé˜Ÿåˆ—(ä¾‹å¦‚LinkedBlockingQueueæ²¡æœ‰é¢„å®šä¹‰çš„å®¹é‡)
 * å°†å¯¼è‡´æ–°ä»»åŠ¡åœ¨æ‰€æœ‰corePoolSizeçº¿ç¨‹å¿™æ—¶åœ¨é˜Ÿåˆ—ä¸­ç­‰å¾…
 * å› æ­¤ï¼Œä¸ä¼šåˆ›å»ºè¶…è¿‡corePoolSizeçš„çº¿ç¨‹(æ‰€ä»¥maximumPoolSizeçš„å€¼æ²¡æœ‰ä»»ä½•å½±å“)
 * å½“æ¯ä¸ªä»»åŠ¡å®Œå…¨ç‹¬ç«‹äºå…¶ä»–ä»»åŠ¡æ—¶ï¼Œä»»åŠ¡ä¸ä¼šå½±å“å½¼æ­¤çš„æ‰§è¡Œ;
 * ä¾‹å¦‚ï¼Œåœ¨webé¡µé¢æœåŠ¡å™¨ä¸­
* è™½ç„¶è¿™ç§æ’é˜Ÿæ–¹å¼æœ‰åŠ©äºæ¶ˆé™¤è¯·æ±‚çš„æš‚æ—¶æ€§çªå‘
* ä½†å®ƒå…è®¸åœ¨å‘½ä»¤å¹³å‡åˆ°è¾¾é€Ÿåº¦è¶…è¿‡å…¶å¤„ç†é€Ÿåº¦æ—¶ï¼Œæ— é™å·¥ä½œé˜Ÿåˆ—å¢é•¿çš„å¯èƒ½æ€§
 *
 * &lt;li&gt;&lt;em&gt; Unbounded queues.&lt;/em&gt; Using an unbounded queue (for
 * example a {@link LinkedBlockingQueue} without a predefined
 * capacity) will cause new tasks to wait in the queue when all
 * corePoolSize threads are busy. Thus, no more than corePoolSize
 * threads will ever be created. (And the value of the maximumPoolSize
 * therefore doesn&#39;t have any effect.)  This may be appropriate when
 * each task is completely independent of others, so tasks cannot
 * affect each others execution; for example, in a web page server.
 * While this style of queuing can be useful in smoothing out
 * transient bursts of requests, it admits the possibility of
 * unbounded work queue growth when commands continue to arrive on
 * average faster than they can be processed.
 *
 * æœ‰ç•Œé˜Ÿåˆ—
 * æœ‰ç•Œé˜Ÿåˆ—(ä¾‹å¦‚ArrayBlockingQueue)
 * æœ‰åŠ©äºé˜²æ­¢åœ¨ä¸æœ‰é™çš„maximumPoolSizesä¸€èµ·ä½¿ç”¨æ—¶èµ„æºè€—å°½ï¼Œä½†å¯èƒ½æ›´éš¾è¿›è¡Œä¼˜åŒ–å’Œæ§åˆ¶
 * é˜Ÿåˆ—å¤§å°å’Œæœ€å¤§æ± å¤§å°å¯ä»¥ç›¸äº’äº¤æ¢: 
 * 1.ä½¿ç”¨å¤§é˜Ÿåˆ—å’Œå°æ± å¯ä»¥æœ€å°åŒ–CPUä½¿ç”¨ç‡ã€æ“ä½œç³»ç»Ÿèµ„æºå’Œä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€ï¼Œä½†å¯èƒ½å¯¼è‡´äººä¸ºçš„ä½ååé‡; å¦‚æœä»»åŠ¡ç»å¸¸é˜»å¡(ä¾‹å¦‚ï¼Œå¦‚æœå®ƒä»¬æ˜¯I/Oç»‘å®šçš„)ï¼Œç³»ç»Ÿå¯èƒ½(æ¯”åˆ›å»ºæ›´å¤šçš„çº¿ç¨‹è¿è¡Œæ—¶)ä½¿ç”¨æ›´é•¿æ—¶é—´;
 * 2.ä½¿ç”¨å°é˜Ÿåˆ—é€šå¸¸éœ€è¦è¾ƒå¤§çš„æ± å¤§å°ï¼Œè¿™ä½¿å¾—cpuæ›´åŠ ç¹å¿™ï¼Œå¯èƒ½ä¼šé‡åˆ°ä¸å¯æ¥å—çš„è°ƒåº¦å¼€é”€ï¼Œè¿™ä¹Ÿä¼šé™ä½ååé‡
 *
 * &lt;li&gt;&lt;em&gt;Bounded queues.&lt;/em&gt; A bounded queue (for example, an
 * {@link ArrayBlockingQueue}) helps prevent resource exhaustion when
 * used with finite maximumPoolSizes, but can be more difficult to
 * tune and control.  Queue sizes and maximum pool sizes may be traded
 * off for each other: Using large queues and small pools minimizes
 * CPU usage, OS resources, and context-switching overhead, but can
 * lead to artificially low throughput.  If tasks frequently block (for
 * example if they are I/O bound), a system may be able to schedule
 * time for more threads than you otherwise allow. Use of small queues
 * generally requires larger pool sizes, which keeps CPUs busier but
 * may encounter unacceptable scheduling overhead, which also
 * decreases throughput.
 *
 * &lt;/ol&gt;
 *
 * &lt;/dd&gt;
 *
 * æ‹’ç»ç­–ç•¥
 *
 * &lt;dt&gt;Rejected tasks&lt;/dt&gt;
 *
 * åœ¨æ–¹æ³•execute(Runnable)ä¸­æäº¤çš„æ–°ä»»åŠ¡å°†åœ¨:
 * 1.æ‰§è¡Œå™¨å…³é—­
 * 2.æ‰§è¡Œå™¨å¯¹æœ€å¤§çº¿ç¨‹å·¥ä½œé˜Ÿåˆ—å®¹é‡ä½¿ç”¨æœ‰é™è¾¹ç•Œä¸”å·²é¥±å’Œ
 * æ—¶è¢«æ‹’ç»
 * åœ¨è¿™ä¸¤ç§æƒ…å†µä¸‹ï¼Œexecuteæ–¹æ³•éƒ½ä¼šè°ƒç”¨å…¶
 * RejectedExecutionHandlerçš„RejectedExecutionHandleræ–¹æ³•çš„RejectedExecutionHandler}
 *
 * JDKæä¾›äº†å››ä¸ªé¢„å®šä¹‰çš„å¤„ç†ç¨‹åºç­–ç•¥:
 *
 * &lt;dd&gt;New tasks submitted in method {@link #execute(Runnable)} will be
 * &lt;em&gt;rejected&lt;/em&gt; when the Executor has been shut down, and also when
 * the Executor uses finite bounds for both maximum threads and work queue
 * capacity, and is saturated.  In either case, the {@code execute} method
 * invokes the {@link
 * RejectedExecutionHandler#rejectedExecution(Runnable, ThreadPoolExecutor)}
 * method of its {@link RejectedExecutionHandler}.  Four predefined handler
 * policies are provided:
 *
 * &lt;ol&gt;
 *
 * é»˜è®¤çš„ThreadPoolExecutor.AbortPolicy:
 * å¤„ç†ç¨‹åºåœ¨æ‹’ç»æ—¶æŠ›å‡ºè¿è¡Œæ—¶RejectedExecutionException
 *
 * &lt;li&gt;In the default {@link ThreadPoolExecutor.AbortPolicy}, the handler
 * throws a runtime {@link RejectedExecutionException} upon rejection.
 *
 * ThreadPoolExecutor.CallerRunsPolicy:
 * è°ƒç”¨executeæœ¬èº«çš„çº¿ç¨‹è¿è¡Œè¯¥ä»»åŠ¡
 * è¿™æä¾›äº†ä¸€ä¸ªç®€å•çš„åé¦ˆæ§åˆ¶æœºåˆ¶ï¼Œå¯ä»¥é™ä½æäº¤æ–°ä»»åŠ¡çš„é€Ÿåº¦
 *
 * &lt;li&gt;In {@link ThreadPoolExecutor.CallerRunsPolicy}, the thread
 * that invokes {@code execute} itself runs the task. This provides a
 * simple feedback control mechanism that will slow down the rate that
 * new tasks are submitted.
 *
 * ThreadPoolExecutor.DiscardPolicy:
 * æ— æ³•æ‰§è¡Œçš„ä»»åŠ¡å°†è¢«ç®€å•åœ°åˆ é™¤
 *
 * &lt;li&gt;In {@link ThreadPoolExecutor.DiscardPolicy}, a task that
 * cannot be executed is simply dropped.
 *
 * ThreadPoolExecutor.DiscardOldestPolicy:
 * å¦‚æœæœªå…³é—­æ‰§è¡Œå™¨ï¼Œåˆ™åˆ é™¤å·¥ä½œé˜Ÿåˆ—å¤´éƒ¨çš„ä»»åŠ¡ï¼Œç„¶åé‡è¯•æ‰§è¡Œ
 * (è¿™å¯èƒ½ä¼šå†æ¬¡å¤±è´¥ï¼Œå¯¼è‡´é‡å¤æ‰§è¡Œ)
 *
 * &lt;li&gt;In {@link ThreadPoolExecutor.DiscardOldestPolicy}, if the
 * executor is not shut down, the task at the head of the work queue
 * is dropped, and then execution is retried (which can fail again,
 * causing this to be repeated.)
 *
 * &lt;/ol&gt;
 *
 * å¯ä»¥å®šä¹‰å’Œä½¿ç”¨å…¶ä»–ç±»å‹çš„RejectedExecutionHandlerç±»
 * è¿™æ ·åšéœ€è¦æ³¨æ„ï¼Œç‰¹åˆ«æ˜¯å½“ç­–ç•¥è®¾è®¡ä¸ºä»…åœ¨ç‰¹å®šå®¹é‡æˆ–æ’é˜Ÿç­–ç•¥ä¸‹å·¥ä½œæ—¶
 *
 * It is possible to define and use other kinds of {@link
 * RejectedExecutionHandler} classes. Doing so requires some care
 * especially when policies are designed to work only under particular
 * capacity or queuing policies. &lt;/dd&gt;
 *
 * é’©å­æ–¹æ³•
 *
 * &lt;dt&gt;Hook methods&lt;/dt&gt;
 *
 * æ­¤ç±»æä¾›åœ¨æ‰§è¡Œæ¯ä¸ªä»»åŠ¡ä¹‹å‰å’Œä¹‹åè°ƒç”¨çš„(protected)å¯é‡å†™çš„beforeExecuteå’ŒafterExecuteæ–¹æ³•
 * å®ƒä»¬å¯ç”¨äºæ“ä½œæ‰§è¡Œç¯å¢ƒ, ä¾‹å¦‚:
 * é‡æ–°åˆå§‹åŒ–ThreadLocalsã€æ”¶é›†ç»Ÿè®¡ä¿¡æ¯æˆ–æ·»åŠ æ—¥å¿—é¡¹
 * æ­¤å¤–ï¼Œå¯ä»¥é‡å†™æ–¹æ³•terminatedï¼Œä»¥ä¾¿åœ¨æ‰§è¡Œå™¨å®Œå…¨ç»ˆæ­¢åæ‰§è¡Œä»»ä½•éœ€è¦æ‰§è¡Œçš„ç‰¹æ®Šå¤„ç†
 *
 * &lt;dd&gt;This class provides {@code protected} overridable
 * {@link #beforeExecute(Thread, Runnable)} and
 * {@link #afterExecute(Runnable, Throwable)} methods that are called
 * before and after execution of each task.  These can be used to
 * manipulate the execution environment; for example, reinitializing
 * ThreadLocals, gathering statistics, or adding log entries.
 * Additionally, method {@link #terminated} can be overridden to perform
 * any special processing that needs to be done once the Executor has
 * fully terminated.
 *
 * å¦‚æœhookã€callbackæˆ–BlockingQueueæ–¹æ³•æŠ›å‡ºå¼‚å¸¸
 * åˆ™å†…éƒ¨å·¥ä½œçº¿ç¨‹å¯èƒ½ä¼šä¾æ¬¡å¤±è´¥ã€çªç„¶ç»ˆæ­¢å¹¶å¯èƒ½è¢«æ›¿æ¢
 *
 * &lt;p&gt;If hook, callback, or BlockingQueue methods throw exceptions,
 * internal worker threads may in turn fail, abruptly terminate, and
 * possibly be replaced.&lt;/dd&gt;
 *
 * é˜Ÿåˆ—ç»´æŠ¤
 *
 * &lt;dt&gt;Queue maintenance&lt;/dt&gt;
 *
 * æ–¹æ³•getQueue()å…è®¸è®¿é—®å·¥ä½œé˜Ÿåˆ—ä»¥è¿›è¡Œç›‘è§†å’Œè°ƒè¯•
 * å¼ºçƒˆå»ºè®®ä¸è¦å°†æ­¤æ–¹æ³•ç”¨äºä»»ä½•å…¶ä»–ç›®çš„
 * æä¾›çš„ä¸¤ä¸ªæ–¹æ³•removeå’Œpurgeå¯ç”¨äºåœ¨å–æ¶ˆå¤§é‡æ’é˜Ÿä»»åŠ¡æ—¶ååŠ©å­˜å‚¨å›æ”¶
 *
 * &lt;dd&gt;Method {@link #getQueue()} allows access to the work queue
 * for purposes of monitoring and debugging.  Use of this method for
 * any other purpose is strongly discouraged.  Two supplied methods,
 * {@link #remove(Runnable)} and {@link #purge} are available to
 * assist in storage reclamation when large numbers of queued tasks
 * become cancelled.&lt;/dd&gt;
 *
 * å›æ”¶
 *
 * &lt;dt&gt;Reclamation&lt;/dt&gt;
 *
 * ç¨‹åºä¸­ä¸å†å¼•ç”¨ä¸”æ²¡æœ‰å‰©ä½™çº¿ç¨‹çš„æ± å¯ä»¥åœ¨ä¸æ˜¾å¼å…³é—­çš„æƒ…å†µä¸‹å›æ”¶(åƒåœ¾å›æ”¶)
 * é€šè¿‡è®¾ç½®é€‚å½“çš„ä¿æŒæ´»åŠ¨æ—¶é—´ã€ä½¿ç”¨é›¶æ ¸å¿ƒçº¿ç¨‹çš„ä¸‹é™å’Œ/æˆ–è®¾ç½®allowCoreThreadTimeOut(true)
 * å¯ä»¥å°†æ± é…ç½®ä¸ºå…è®¸æ‰€æœ‰æœªä½¿ç”¨çš„çº¿ç¨‹æœ€ç»ˆæ¶ˆäº¡
 *
 * &lt;dd&gt;A pool that is no longer referenced in a program &lt;em&gt;AND&lt;/em&gt;
 * has no remaining threads may be reclaimed (garbage collected)
 * without being explicitly shutdown. You can configure a pool to
 * allow all unused threads to eventually die by setting appropriate
 * keep-alive times, using a lower bound of zero core threads and/or
 * setting {@link #allowCoreThreadTimeOut(boolean)}.  &lt;/dd&gt;
 *
 * &lt;/dl&gt;
 *
 * æ‰©å±•ä¾‹å­: 
 * è¿™ä¸ªç±»çš„å¤§å¤šæ•°æ‰©å±•é‡å†™äº†ä¸€ä¸ªæˆ–å¤šä¸ªå—ä¿æŠ¤çš„é’©å­æ–¹æ³•
 * ä¾‹å¦‚ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªå­ç±»ï¼Œå®ƒæ·»åŠ äº†ä¸€ä¸ªç®€å•çš„æš‚åœ/æ¢å¤åŠŸèƒ½ï¼š
 *
 * &lt;p&gt;&lt;b&gt;Extension example&lt;/b&gt;. Most extensions of this class
 * override one or more of the protected hook methods. For example,
 * here is a subclass that adds a simple pause/resume feature:
 *
 * &lt;pre&gt; {@code
 * class PausableThreadPoolExecutor extends ThreadPoolExecutor {
 *   private boolean isPaused;
 *   private ReentrantLock pauseLock = new ReentrantLock();
 *   private Condition unpaused = pauseLock.newCondition();
 *
 *   public PausableThreadPoolExecutor(...) { super(...); }
 *   // é‡å†™æ‰§è¡Œå‰æ–¹æ³•
 *   protected void beforeExecute(Thread t, Runnable r) {
 *     super.beforeExecute(t, r);
 *     pauseLock.lock();
 *     try {
 *       while (isPaused) unpaused.await();
 *     } catch (InterruptedException ie) {
 *       t.interrupt();
 *     } finally {
 *       pauseLock.unlock();
 *     }
 *   }
 *   // åœæ­¢
 *   public void pause() {
 *     pauseLock.lock();
 *     try {
 *       isPaused = true;
 *     } finally {
 *       pauseLock.unlock();
 *     }
 *   }
 *   // æ¢å¤
 *   public void resume() {
 *     pauseLock.lock();
 *     try {
 *       isPaused = false;
 *       unpaused.signalAll();
 *     } finally {
 *       pauseLock.unlock();
 *     }
 *   }
 * }}&lt;/pre&gt;
 *
 * @since 1.5
 * @author Doug Lea
 */
public class ThreadPoolExecutor extends AbstractExecutorService {
    /**
     * ä¸»æ± æ§åˆ¶çŠ¶æ€ctlå±æ€§æ˜¯ä¸€ä¸ªåŸå­æ•´æ•°, åŒ…å«ä¸¤ä¸ªæ¦‚å¿µå­—æ®µ:
     * 1.workerCount: æŒ‡ç¤ºçº¿ç¨‹çš„æœ‰æ•ˆè¿è¡ŒçŠ¶æ€æ•°;
     * 2.runState: æŒ‡ç¤ºæ˜¯å¦æ­£åœ¨è¿è¡Œã€æ­£åœ¨å…³é—­ç­‰;
     * 
     * The main pool control state, ctl, is an atomic integer packing
     * two conceptual fields
     *   workerCount, indicating the effective number of threads
     *   runState,    indicating whether running, shutting down etc
     *
     * ä¸ºäº†å°†å®ƒä»¬æ‰“åŒ…æˆä¸€ä¸ªint
     * æˆ‘ä»¬å°†workerCounté™åˆ¶ä¸º(2^29)-1[å¤§çº¦5äº¿]çº¿ç¨‹ï¼Œè€Œä¸æ˜¯(2^31)-1[20äº¿]çº¿ç¨‹
     * å¦‚æœå°†æ¥å‡ºç°è¿™ç§æƒ…å†µ(çº¿ç¨‹æ•°è¶…è¿‡5äº¿):
     * å¯ä»¥å°†å˜é‡æ›´æ”¹ä¸ºAtomicLong, å¹¶è°ƒæ•´ä¸‹é¢çš„shift/maskå¸¸é‡
     * ä½†æ˜¯åœ¨éœ€è¦è¿™æ ·æ”¹å˜ä¹‹å‰ï¼Œä½¿ç”¨intä»£ç ä¼šæ›´å¿«æ›´ç®€å•
     *
     * In order to pack them into one int, we limit workerCount to
     * (2^29)-1 (about 500 million) threads rather than (2^31)-1 (2
     * billion) otherwise representable. If this is ever an issue in
     * the future, the variable can be changed to be an AtomicLong,
     * and the shift/mask constants below adjusted. But until the need
     * arises, this code is a bit faster and simpler using an int.
     *
     * workerCountæ˜¯å…è®¸å¯åŠ¨å’Œä¸å…è®¸åœæ­¢çš„å·¥äººæ•°
     * è¯¥å€¼å¯èƒ½æš‚æ—¶ä¸åŒäºæ´»åŠ¨çº¿ç¨‹çš„å®é™…æ•°é‡, ä¾‹å¦‚:
     * 1.å½“çº¿ç¨‹å·¥å‚åœ¨è¢«è¯·æ±‚æ—¶æ— æ³•åˆ›å»ºçº¿ç¨‹
     * 2.å½“é€€å‡ºçš„çº¿ç¨‹åœ¨ç»ˆæ­¢å‰ä»åœ¨æ‰§è¡Œè®°å¸(ä»ç„¶åœ¨æ•°é‡ä¸Š, æœªè¢«å‡ä¸€)æ—¶
     * ç”¨æˆ·å¯è§æ± å¤§å°ä¸ºå·¥ä½œé›†çš„å½“å‰å¤§å°
     *
     * The workerCount is the number of workers that have been
     * permitted to start and not permitted to stop.  The value may be
     * transiently different from the actual number of live threads,
     * for example when a ThreadFactory fails to create a thread when
     * asked, and when exiting threads are still performing
     * bookkeeping before terminating. The user-visible pool size is
     * reported as the current size of the workers set.
     *
     * è¿è¡ŒçŠ¶æ€æä¾›ä¸»ç”Ÿå‘½å‘¨æœŸæ§åˆ¶ï¼Œå…·æœ‰ä»¥ä¸‹å€¼:
     *
     *   RUNNING:  æ¥å—æ–°ä»»åŠ¡å¹¶å¤„ç†æ’é˜Ÿçš„ä»»åŠ¡
     *   SHUTDOWN: ä¸æ¥å—æ–°ä»»åŠ¡ï¼Œä½†å¤„ç†æ’é˜Ÿçš„ä»»åŠ¡
     *   STOP: ä¸æ¥å—æ–°ä»»åŠ¡ã€ä¸å¤„ç†æ’é˜Ÿçš„ä»»åŠ¡å’Œä¸­æ–­æ­£åœ¨è¿›è¡Œçš„ä»»åŠ¡
     *   TIDYING: æ‰€æœ‰ä»»åŠ¡éƒ½å·²ç»ˆæ­¢ï¼ŒworkerCountä¸ºé›¶, çŠ¶æ€è½¬æ¢ä¸ºtidingçš„çº¿ç¨‹å°†è¿è¡Œterminated()é’©å­æ–¹æ³•
     *   TERMINATED: terminated()æ–¹æ³•å·²å®Œæˆ
     *
     * The runState provides the main lifecycle control, taking on values:
     *
     *   RUNNING:  Accept new tasks and process queued tasks
     *   SHUTDOWN: Don&#39;t accept new tasks, but process queued tasks
     *   STOP:     Don&#39;t accept new tasks, don&#39;t process queued tasks,
     *             and interrupt in-progress tasks
     *   TIDYING:  All tasks have terminated, workerCount is zero,
     *             the thread transitioning to state TIDYING
     *             will run the terminated() hook method
     *   TERMINATED: terminated() has completed
     *
     * è¿™äº›å€¼ä¹‹é—´çš„æ•°å­—é¡ºåºå¾ˆé‡è¦ï¼Œä»¥ä¾¿è¿›è¡Œæœ‰åºæ¯”è¾ƒ
     * è¿è¡ŒçŠ¶æ€éšæ—¶é—´å•è°ƒåœ°å¢åŠ ï¼Œä½†ä¸å¿…å‘½ä¸­æ¯ä¸ªçŠ¶æ€, çŠ¶æ€è¿‡æ¸¡æ˜¯:
     *
     * RUNNING -&gt; SHUTDOWN: è°ƒç”¨shutdown()æ–¹æ³•æ—¶
     *    
     * (RUNNING or SHUTDOWN) -&gt; STOP: åœ¨è°ƒç”¨shutdownNow()æ–¹æ³•æ—¶
     *    
     * SHUTDOWN -&gt; TIDYING: å½“é˜Ÿåˆ—å’Œæ± éƒ½ä¸ºç©ºæ—¶
     *    
     * STOP -&gt; TIDYING: å½“æ± ä¸ºç©ºæ—¶
     *    
     * TIDYING -&gt; TERMINATED: å½“terminated()é’©å­æ–¹æ³•å®Œæˆæ—¶
     *
     * The numerical order among these values matters, to allow
     * ordered comparisons. The runState monotonically increases over
     * time, but need not hit each state. The transitions are:
     *
     * RUNNING -&gt; SHUTDOWN
     *    On invocation of shutdown()
     * (RUNNING or SHUTDOWN) -&gt; STOP
     *    On invocation of shutdownNow()
     * SHUTDOWN -&gt; TIDYING
     *    When both queue and pool are empty
     * STOP -&gt; TIDYING
     *    When pool is empty
     * TIDYING -&gt; TERMINATED
     *    When the terminated() hook method has completed
     *
     * ç­‰å¾…awaitTermination()çš„çº¿ç¨‹å°†åœ¨çŠ¶æ€è¾¾åˆ°TERMINATEDæ—¶è¿”å›
     *
     * Threads waiting in awaitTermination() will return when the
     * state reaches TERMINATED.
     *
     * æ£€æµ‹ä»SHUTDOWNåˆ°TIDYINGçš„è½¬æ¢æ¯”æƒ³è±¡çš„è¦ç®€å•å¾—å¤š
     * å› ä¸ºé˜Ÿåˆ—åœ¨(æ­£å¸¸å·¥ä½œ)éç©ºä¹‹åå¯èƒ½å˜ç©ºï¼Œåœ¨SHUTDOWNçŠ¶æ€ä¸‹ä¹Ÿå¯èƒ½å˜ç©º
     * ä½†æˆ‘ä»¬åªåœ¨çœ‹åˆ°å®ƒä¸ºç©ºä¹‹ååˆçœ‹åˆ°workerCountä¸º0(æœ‰æ—¶éœ€è¦é‡æ–°æ£€æŸ¥â€”â€”è§ä¸‹æ–‡)æ—¶ç»ˆæ­¢
     *
     * Detecting the transition from SHUTDOWN to TIDYING is less
     * straightforward than you&#39;d like because the queue may become
     * empty after non-empty and vice versa during SHUTDOWN state, but
     * we can only terminate if, after seeing that it is empty, we see
     * that workerCount is 0 (which sometimes entails a recheck -- see
     * below).
     */
    private final AtomicInteger ctl = new AtomicInteger(ctlOf(RUNNING, 0));
    private static final int COUNT_BITS = Integer.SIZE - 3;
    private static final int COUNT_MASK = (1 &lt;&lt; COUNT_BITS) - 1;

    // runStateå­˜å‚¨åœ¨é«˜é˜¶ä½ä¸­
    private static final int RUNNING    = -1 &lt;&lt; COUNT_BITS;
    private static final int SHUTDOWN   =  0 &lt;&lt; COUNT_BITS;
    private static final int STOP       =  1 &lt;&lt; COUNT_BITS;
    private static final int TIDYING    =  2 &lt;&lt; COUNT_BITS;
    private static final int TERMINATED =  3 &lt;&lt; COUNT_BITS;

    // æ‰“åŒ…å’Œè§£åŒ…ctl(çº¿ç¨‹æ± ç”Ÿå‘½å‘¨æœŸå±æ€§)
    private static int runStateOf(int c)     { return c &amp; ~COUNT_MASK; }
    private static int workerCountOf(int c)  { return c &amp; COUNT_MASK; }
    // å‚æ•°rsè¡¨ç¤ºrunState
    // å‚æ•°wcè¡¨ç¤ºworkerCount
    // å³æ ¹æ®runStateå’ŒworkerCountæ‰“åŒ…åˆå¹¶æˆctl
    private static int ctlOf(int rs, int wc) { return rs | wc; }

    // ä¸éœ€è¦è§£åŒ…ctlçš„ä½å­—æ®µè®¿é—®å™¨
    // è¿™å–å†³äºbitçš„layoutå’ŒworkerCountæ°¸ä¸ä¸ºè´Ÿ
    private static boolean runStateLessThan(int c, int s) {
        return c &lt; s;
    }
    private static boolean runStateAtLeast(int c, int s) {
        return c &gt;= s;
    }
    private static boolean isRunning(int c) {
        return c &lt; SHUTDOWN;
    }

    /**
     * å°è¯•CASé€’å¢ctlçš„workerCountå­—æ®µ(å¢åŠ å·¥ä½œçº¿ç¨‹)
     */
    private boolean compareAndIncrementWorkerCount(int expect) {
        return ctl.compareAndSet(expect, expect + 1);
    }

    /**
     * å°è¯•CASå‡å°‘ctlçš„workerCountå­—æ®µ
     */
    private boolean compareAndDecrementWorkerCount(int expect) {
        return ctl.compareAndSet(expect, expect - 1);
    }

    /**
     * é€’å‡ctlçš„workerCountå­—æ®µ
     * æ­¤æ–¹æ³•åªåœ¨çº¿ç¨‹çªç„¶ç»ˆæ­¢æ—¶è°ƒç”¨(processWorkerExitæ–¹æ³•)
     * å…¶ä»–å‡é‡åœ¨getTaskä¸­æ‰§è¡Œ
     */
    private void decrementWorkerCount() {
        ctl.addAndGet(-1);
    }

    /**
     * ç”¨äºä¿å­˜ä»»åŠ¡å¹¶å°†å…¶ä¼ é€’ç»™å·¥ä½œçº¿ç¨‹çš„é˜Ÿåˆ—
     * æˆ‘ä»¬ä¸è¦æ±‚workQueue.poll()è¿”å›ç©ºå€¼å¿…ç„¶æ„å‘³ç€workQueue.isEmpty()
     * å› æ­¤ä»…ä¾èµ–äºisEmptyæ¥æŸ¥çœ‹é˜Ÿåˆ—æ˜¯å¦ä¸ºç©º
     * ä¾‹å¦‚: åœ¨å†³å®šæ˜¯å¦ä»å…³é—­è¿‡æ¸¡åˆ°æ•´ç†æ—¶ï¼Œæˆ‘ä»¬å¿…é¡»è¿™æ ·åš
     * è¿™é€‚ç”¨äºç‰¹æ®Šç”¨é€”çš„é˜Ÿåˆ—ï¼Œä¾‹å¦‚DelayQueuesçš„poll()æ–¹æ³•å…è®¸è¿”å›ç©ºå€¼ï¼Œå³ä½¿ç¨ååœ¨å»¶è¿Ÿåˆ°æœŸæ—¶å¯èƒ½è¿”å›éç©ºå€¼
     */
    private final BlockingQueue&lt;Runnable&gt; workQueue;

    /**
     * å¯¹workers Setå’Œrelated bookkeepingçš„è®¿é—®ä¿æŒé”å®š
     *
     * è™½ç„¶æˆ‘ä»¬å¯ä»¥ä½¿ç”¨æŸç§ç±»å‹çš„å¹¶å‘é›†åˆï¼Œä½†é€šå¸¸æœ€å¥½ä½¿ç”¨é”
     * å…¶ä¸­ä¸€ä¸ªåŸå› æ˜¯ï¼Œè¿™ä¼šåºåˆ—åŒ–InterruptedWorkersï¼Œä»è€Œé¿å…ä¸å¿…è¦çš„ä¸­æ–­é£æš´
     * (ç‰¹åˆ«æ˜¯åœ¨shutdownæœŸé—´)
     * å¦åˆ™ï¼Œé€€å‡ºçš„çº¿ç¨‹å°†åŒæ—¶ä¸­æ–­é‚£äº›å°šæœªä¸­æ–­çš„çº¿ç¨‹
     * å®ƒè¿˜ç®€åŒ–äº†ä¸€äº›ä¸æœ€å¤§æ± å¤§å°ç­‰ç›¸å…³çš„ç»Ÿè®¡å·¥ä½œ
     * åœ¨shutdownå’ŒshutdownNowæ‰§è¡Œæ—¶ï¼Œè¿˜ä¼šè·å–mainLockï¼Œä»¥ç¡®ä¿åœ¨åˆ†åˆ«æ£€æŸ¥å…è®¸ä¸­æ–­å’Œå®é™…ä¸­æ–­çš„æƒ…å†µä¸‹ï¼Œworkersé›†åˆæ˜¯ç¨³å®šçš„
     */
    private final ReentrantLock mainLock = new ReentrantLock();

    /**
     * åŒ…å«æ± ä¸­æ‰€æœ‰å·¥ä½œçº¿ç¨‹çš„Seté›†åˆ, ä»…åœ¨è·å–mainLockæ—¶èƒ½å¤Ÿè®¿é—®
     */
    private final HashSet&lt;Worker&gt; workers = new HashSet&lt;&gt;();

    /**
     * æä¾›ç»™awaitTerminationæ–¹æ³•çš„ç­‰å¾…æ¡ä»¶
     */
    private final Condition termination = mainLock.newCondition();

    /**
     * è·Ÿè¸ªæœ€å¤§çš„å·²è¾¾åˆ°æ± å¤§å°, ä»…åœ¨è·å–mainLockæ—¶èƒ½å¤Ÿè®¿é—®
     */
    private int largestPoolSize;

    /**
     * å·²å®Œæˆä»»åŠ¡çš„è®¡æ•°å™¨, ä»…åœ¨å·¥ä½œçº¿ç¨‹ç»ˆæ­¢æ—¶æ›´æ–°, ä»…åœ¨è·å–mainLockæ—¶èƒ½å¤Ÿè®¿é—®
     */
    private long completedTaskCount;

    /*
     * æ‰€æœ‰ç”¨æˆ·æ§åˆ¶å‚æ•°éƒ½å£°æ˜ä¸ºvolatile
     * å› æ­¤æ­£åœ¨è¿›è¡Œçš„æ“ä½œæ€»æ˜¯åŸºäºæœ€æ–°çš„å€¼ï¼Œä½†ä¸éœ€è¦é”å®š
     * å› ä¸ºç›¸å¯¹äºå…¶ä»–æ“ä½œçš„åŒæ­¥æ›´æ”¹æ¥è¯´, æ²¡æœ‰å†…éƒ¨å¸¸é‡ä¾èµ–äºå®ƒä»¬
     */

    /**
     * çº¿ç¨‹å·¥å‚: æ‰€æœ‰çº¿ç¨‹éƒ½æ˜¯ä½¿ç”¨æ­¤å·¥å‚(é€šè¿‡addWorkeræ–¹æ³•)
     * æ‰€æœ‰è°ƒç”¨æ–¹éƒ½å¿…é¡»ä¸ºaddWorkerå¤±è´¥åšå¥½å‡†å¤‡
     * è¿™åæ˜ äº†ç³»ç»Ÿæˆ–ç”¨æˆ·é™åˆ¶çº¿ç¨‹æ•°çš„ç­–ç•¥
     * å³ä½¿ä¸å°†å…¶è§†ä¸ºé”™è¯¯ï¼Œåˆ›å»ºçº¿ç¨‹å¤±è´¥ä¹Ÿå¯èƒ½å¯¼è‡´æ–°ä»»åŠ¡è¢«æ‹’ç»æˆ–ç°æœ‰ä»»åŠ¡ä»æ»ç•™åœ¨é˜Ÿåˆ—ä¸­
     *
     * æˆ‘ä»¬è¿›ä¸€æ­¥ä¿ç•™çº¿ç¨‹æ± æ± å˜é‡é…ç½®,è€Œç»§ç»­åˆ›å»ºThread, å¯èƒ½ä¼šé‡åˆ°OutOfMemoryErrorä¹‹ç±»çš„é”™è¯¯
     * (ç”±äºåˆ›å»ºçº¿ç¨‹éœ€è¦åœ¨Thread.startä¸­åˆ†é…æœ¬æœºå †æ ˆï¼Œå› æ­¤æ­¤ç±»é”™è¯¯ç›¸å½“å¸¸è§)
     * æ­¤æ—¶ç”¨æˆ·å°†å¸Œæœ›æ‰§è¡Œæ¸…ç†æ± å…³é—­ä»¥è¿›è¡Œæ¸…ç†
     * å¦‚æœæœ‰è¶³å¤Ÿçš„å†…å­˜ä¾›æ¸…ç†ä»£ç å®Œæˆï¼Œæ­¤æ—¶åˆ™ä¸ä¼šé‡åˆ°å¦ä¸€ä¸ªOutOfMemoryé”™è¯¯
     */
    private volatile ThreadFactory threadFactory;

    /**
     * åœ¨æ‰§è¡Œä¸­çº¿ç¨‹æ± é¥±å’Œæˆ–çº¿ç¨‹æ± å…³é—­æ—¶è°ƒç”¨çš„æ‹’ç»ç­–ç•¥æ–¹æ³•
     */
    private volatile RejectedExecutionHandler handler;

    /**
     * ç­‰å¾…å·¥ä½œçš„ç©ºé—²çº¿ç¨‹è¶…æ—¶æ—¶é—´(ä»¥çº³ç§’ä¸ºå•ä½)
     * å½“å­˜åœ¨è¶…è¿‡corePoolSizeæ•°é‡çš„çº¿ç¨‹å­˜åœ¨æˆ–è®¾ç½®äº†allowCoreThreadTimeOutæ—¶ä½¿ç”¨æ­¤è¶…æ—¶
     * å¦åˆ™ä»–ä»¬ä¼šæ°¸è¿œç­‰å¾…æ–°çš„å·¥ä½œ
     */
    private volatile long keepAliveTime;

    /**
     * å¦‚æœä¸ºfalse(é»˜è®¤å€¼), åˆ™æ ¸å¿ƒçº¿ç¨‹å³ä½¿å¤„äºç©ºé—²çŠ¶æ€ä¹Ÿä¸ä¼šè¢«å›æ”¶
     * å¦‚æœä¸ºtrueï¼Œåˆ™æ ¸å¿ƒçº¿ç¨‹ä½¿ç”¨keepAliveTimeè¶…æ—¶å›æ”¶
     */
    private volatile boolean allowCoreThreadTimeOut;

    /**
     * corePoolSizeæ˜¯è¦ä¿æŒæ´»åŠ¨çŠ¶æ€(å¹¶ä¸”ä¸å…è®¸è¶…æ—¶ç­‰)çš„æœ€å°å·¥ä½œçº¿ç¨‹æ•°
     * é™¤éè®¾ç½®allowCoreThreadTimeOut(åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæœ€å°å€¼ä¸ºé›¶)
     *
     * ç”±äºworker countå®é™…ä¸Šå­˜å‚¨åœ¨COUNT_BITSä¸­
     * å› æ­¤çœŸæ­£çš„é™åˆ¶æ•°æ˜¯: corePoolSize &amp; COUNT_MASK
     */
    private volatile int corePoolSize;

    /**
     * æœ€å¤§æ± å¤§å°ã€‚
     *
     * ç”±äºworker countå®é™…ä¸Šå­˜å‚¨åœ¨COUNT_BITSä¸­
     * å› æ­¤çœŸæ­£çš„é™åˆ¶æ•°æ˜¯: maximumPoolSize &amp; COUNT_MASK
     */
    private volatile int maximumPoolSize;

    /**
     * é»˜è®¤çš„æ‹’ç»æ‰§è¡Œå¤„ç†å™¨(é»˜è®¤ä¸ºAbortPolicy, å³æŠ›å‡ºå¼‚å¸¸)
     */
    private static final RejectedExecutionHandler defaultHandler =
        new AbortPolicy();

    /**
     * å…³é—­å’Œç«‹å³å…³é—­çš„è°ƒç”¨æ–¹æ‰€éœ€çš„æƒé™
     * æˆ‘ä»¬è¿˜è¦æ±‚(è§checkShutdownAccessæ–¹æ³•)è°ƒç”¨è€…æœ‰æƒå®é™…ä¸­æ–­(actually interrupt)workeré›†åˆä¸­çš„çº¿ç¨‹
     * (ç”±Thread.interrupt()æ§åˆ¶, ThreadGroup.checkAccessä¾èµ–, è€ŒThreadGroup.checkAccessåˆä¾èµ–äºSecurityManager.checkAccess)
     * åªæœ‰å½“è¿™äº›æ£€æŸ¥é€šè¿‡æ—¶ï¼Œæ‰ä¼šå°è¯•å…³é—­
     *
     * æ‰€æœ‰å¯¹Thread.interruptçš„å®é™…è°ƒç”¨(è¯·å‚é˜…interruptdleworkerså’ŒinterruptWorkers)éƒ½å¿½ç•¥äº†SecurityExceptions
     * è¿™æ„å‘³ç€å°è¯•çš„ä¸­æ–­ä¼šè‡ªåŠ¨å¤±è´¥
     * åœ¨å…³é—­çš„æƒ…å†µä¸‹ï¼Œé™¤éSecurityManageræœ‰ä¸ä¸€è‡´çš„ç­–ç•¥
     * (æœ‰æ—¶å…è®¸è®¿é—®çº¿ç¨‹ï¼Œæœ‰æ—¶ä¸å…è®¸)å¦åˆ™å®ƒä»¬ä¸åº”è¯¥å¤±è´¥
     * åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæœªèƒ½çœŸæ­£ä¸­æ–­çº¿ç¨‹å¯èƒ½ä¼šç¦ç”¨æˆ–å»¶è¿Ÿå®Œå…¨ç»ˆæ­¢
     * interruptibleworksçš„å…¶ä»–ç”¨é€”æ˜¯å»ºè®®æ€§çš„
     * è€Œæœªèƒ½çœŸæ­£ä¸­æ–­åªä¼šå»¶è¿Ÿå¯¹é…ç½®æ›´æ”¹çš„å“åº”ï¼Œå› æ­¤ä¸ä¼šè¿›è¡Œå¼‚å¸¸å¤„ç†
     */
    private static final RuntimePermission shutdownPerm =
        new RuntimePermission(&quot;modifyThread&quot;);

    /**
     * Workerç±»ä¸»è¦ç»´æŠ¤è¿è¡Œä»»åŠ¡çš„çº¿ç¨‹çš„ä¸­æ–­æ§åˆ¶çŠ¶æ€ï¼Œä»¥åŠå…¶ä»–æ¬¡è¦çš„è®°å½•è¡Œä¸º
     * è¿™ä¸ªç±»æ‰©å±•äº†AbstractQueuedSynchronizer, ä»¥ç®€åŒ–è·å–å’Œé‡Šæ”¾å›´ç»•æ¯ä¸ªä»»åŠ¡æ‰§è¡Œçš„é”çš„è¿‡ç¨‹
     * è¿™å¯ä»¥é˜²æ­¢åœ¨å”¤é†’ç­‰å¾…ä»»åŠ¡çš„å·¥ä½œçº¿ç¨‹è€Œä¸æ˜¯ä¸­æ–­æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡çš„ä¸­æ–­
     * æˆ‘ä»¬å®ç°äº†ä¸€ä¸ªç®€å•çš„ä¸å¯é‡å…¥äº’æ–¥é”ï¼Œè€Œä¸æ˜¯ä½¿ç”¨ReentrantLock
     * å› ä¸ºæˆ‘ä»¬ä¸å¸Œæœ›å·¥ä½œä»»åŠ¡åœ¨è°ƒç”¨setCorePoolSizeä¹‹ç±»çš„æ± æ§åˆ¶æ–¹æ³•æ—¶èƒ½å¤Ÿé‡æ–°è·å–é”
     * å¦å¤–ï¼Œä¸ºäº†åœ¨çº¿ç¨‹çœŸæ­£å¼€å§‹è¿è¡Œä»»åŠ¡ä¹‹å‰ç¦æ­¢ä¸­æ–­ï¼Œæˆ‘ä»¬å°†é”çŠ¶æ€åˆå§‹åŒ–ä¸ºè´Ÿå€¼ï¼Œå¹¶åœ¨å¯åŠ¨æ—¶æ¸…é™¤å®ƒï¼ˆåœ¨runWorkerä¸­ï¼‰
     */
    private final class Worker
        extends AbstractQueuedSynchronizer
        implements Runnable
    {
        /**
         * è¿™ä¸ªç±»æ°¸è¿œä¸ä¼šè¢«åºåˆ—åŒ–ï¼Œä½†æ˜¯æˆ‘ä»¬æä¾›äº†ä¸€ä¸ªserialVersionUIDæ¥ç¦æ­¢javacè­¦å‘Š
         */
        private static final long serialVersionUID = 6138294804551838833L;

        /** Workerç±»çš„å·¥ä½œçº¿ç¨‹; å¦‚æœå·¥å‚å¤±è´¥åˆ›å»ºå¤±è´¥ï¼Œåˆ™ä¸ºç©º */
        final Thread thread;
        /** è¦è¿è¡Œçš„åˆå§‹ä»»åŠ¡, å¯èƒ½ä¸ºç©º */
        Runnable firstTask;
        /** æ¯ä¸ªçº¿ç¨‹çš„ä»»åŠ¡è®¡æ•°å™¨ */
        volatile long completedTasks;

        // TODO: switch to AbstractQueuedLongSynchronizer and move
        // completedTasks into the lock word.

        /**
         * ä½¿ç”¨ç»™å®šçš„ç¬¬ä¸€ä¸ªä»»åŠ¡å’ŒThreadFactoryåˆ›å»ºçº¿ç¨‹
         * Creates with given first task and thread from ThreadFactory.
         * @param firstTask the first task (null if none)
         */
        Worker(Runnable firstTask) {
            setState(-1); // ç¦æ­¢ä¸­æ–­runWorker
            this.firstTask = firstTask;
            this.thread = getThreadFactory().newThread(this);
        }

        /** å°†æ‰§è¡Œä»»åŠ¡å§”æ‰˜ç»™å¤–éƒ¨runWorker */
        public void run() {
            runWorker(this);
        }

        // é”å®šæ–¹æ³•
        // 0è¡¨ç¤ºæœªé”å®šçŠ¶æ€
        // 1è¡¨ç¤ºé”å®šçŠ¶æ€

        // æ˜¯å¦è¢«é”å®š(åˆ¤æ–­çŠ¶æ€æ˜¯å¦ä¸ä¸º0)
        protected boolean isHeldExclusively() {
            return getState() != 0;
        }

        // é€šè¿‡CASæ“ä½œå°è¯•è·å–é”
        protected boolean tryAcquire(int unused) {
            if (compareAndSetState(0, 1)) {
                setExclusiveOwnerThread(Thread.currentThread());
                return true;
            }
            return false;
        }

        // é‡Šæ”¾é”
        protected boolean tryRelease(int unused) {
            setExclusiveOwnerThread(null);
            setState(0);
            return true;
        }

        // è·å–é”, æœªè·å¾—åˆ™ä¸€ç›´è‡ªæ—‹
        public void lock()        { acquire(1); }
        // å°è¯•è·å–é”(é€šè¿‡CAS, è·å–åˆ°è¿”å›true)
        public boolean tryLock()  { return tryAcquire(1); }
        // é‡Šæ”¾é”
        public void unlock()      { release(1); }
        // åˆ¤æ–­å½“å‰å·¥ä½œçº¿ç¨‹æ˜¯å¦è¢«é”å®š
        public boolean isLocked() { return isHeldExclusively(); }

        // å¦‚æœå½“å‰çº¿ç¨‹æ­£åœ¨å·¥ä½œ, åˆ™ä¸­æ–­
        void interruptIfStarted() {
            Thread t;
            if (getState() &gt;= 0 &amp;&amp; (t = thread) != null &amp;&amp; !t.isInterrupted()) {
                try {
                    t.interrupt();
                } catch (SecurityException ignore) {
                }
            }
        }
    }

    /*
     * æ§åˆ¶çŠ¶æ€è®¾ç½®æ–¹æ³•
     */

    /**
     * å°†è¿è¡ŒçŠ¶æ€è½¬æ¢ä¸ºç»™å®štargetï¼Œæˆ–è€…å¦‚æœå·²ç»è‡³å°‘æ˜¯ç»™å®šç›®æ ‡ï¼Œåˆ™å°†å…¶ä¿ç•™çŠ¶æ€
     *
     * @param targetState è½¬æ¢çš„ç›®æ ‡çŠ¶æ€ï¼ŒSHUTDOWN or STOP
     * (ä½†ä¸èƒ½æ˜¯TIDYING or TERMINATED --ä½¿ç”¨tryTerminateï¼‰
     */
    private void advanceRunState(int targetState) {
        // assert targetState == SHUTDOWN || targetState == STOP;
        for (;;) {
            // è·å–è¿è¡ŒçŠ¶æ€
            int c = ctl.get();
            // çŸ­è·¯è¿ç®—ç¬¦
            // å¦‚æœå½“å‰çŠ¶æ€å¤§äºtargetState(c &gt;= targetState)ç›´æ¥è¿”å›
            // å¦åˆ™CASæ“ä½œæ›´æ–°çŠ¶æ€(è‡ªæ—‹)
            // workerCountOf()æ–¹æ³•è®¡ç®—å®é™…çš„çŠ¶æ€æ•°å€¼
            if (runStateAtLeast(c, targetState) ||
                ctl.compareAndSet(c, ctlOf(targetState, workerCountOf(c))))
                break;
        }
    }

    /**
     * å¦‚æœ(SHUTDOWNçŠ¶æ€ä¸”çº¿ç¨‹æ± å’Œå·¥ä½œé˜Ÿåˆ—ä¸ºç©º)æˆ–(STOPçŠ¶æ€ä¸”çº¿ç¨‹æ± ä¸ºç©º)ï¼Œåˆ™è½¬æ¢ä¸ºTERMINATEDçŠ¶æ€
     * å¦‚æœæœ‰èµ„æ ¼ç»ˆæ­¢ï¼Œä½†workerCount(å·¥ä½œçº¿ç¨‹æ•°)ä¸ä¸ºé›¶ï¼Œåˆ™ä¸­æ–­ç©ºé—²çš„å·¥ä½œè¿›ç¨‹ä»¥ç¡®ä¿å…³é—­ä¿¡å·ä¼ æ’­
     * å¿…é¡»åœ¨å¯èƒ½å¯¼è‡´ç»ˆæ­¢çš„ä»»ä½•æ“ä½œä¹‹åè°ƒç”¨æ­¤æ–¹æ³•
     * (å‡å°‘å·¥ä½œè¿›ç¨‹è®¡æ•°æˆ–åœ¨å…³æœºæœŸé—´ä»é˜Ÿåˆ—ä¸­åˆ é™¤ä»»åŠ¡)
     * è¯¥æ–¹æ³•æ˜¯éç§æœ‰çš„ï¼Œ(ä¸ºäº†)å…è®¸åœ¨ScheduledThreadPoolExecutorè¿›è¡Œè®¿é—®
     */
    final void tryTerminate() {
        for (;;) {
            // è·å–çº¿ç¨‹æ± å½“å‰çŠ¶æ€
            int c = ctl.get();
            // å¦‚æœçº¿ç¨‹æ­£åœ¨è¿è¡Œ(æœªå…³é—­)
            // æˆ–è€…ä¸æ˜¯TIDYING(ç»ˆæ­¢å‰æ•´ç†çŠ¶æ€)
            // æˆ–è€…ä¸æ˜¯STOPçŠ¶æ€ä¸”å·¥ä½œé˜Ÿåˆ—ä¸ä¸ºç©º(ä»æœ‰çº¿ç¨‹åœ¨å·¥ä½œ)
            // ç›´æ¥è¿”å›
            if (isRunning(c) ||
                runStateAtLeast(c, TIDYING) ||
                (runStateLessThan(c, STOP) &amp;&amp; ! workQueue.isEmpty()))
                return;
            // éœ€è¦æœ‰èµ„æ ¼ç»ˆæ­¢
            if (workerCountOf(c) != 0) { // Eligible to terminate
                // ä»…ä»…åœæ­¢é—²ç½®çº¿ç¨‹
                interruptIdleWorkers(ONLY_ONE); 
                return;
            }

            // è·å–å½“å‰æ•´ä¸ªçº¿ç¨‹æ± çš„é”
            final ReentrantLock mainLock = this.mainLock;
            // é”å®š
            mainLock.lock();
            try {
                // CASè®¾ç½®çŠ¶æ€ä¸ºTIDYING(å³å®Œå…¨åœæ­¢å‰æ•´ç†çŠ¶æ€)
                if (ctl.compareAndSet(c, ctlOf(TIDYING, 0))) {
                    try {
                        // åœæ­¢
                        terminated();
                    } finally {
                        // ä»TIDYINGè½¬ä¸ºTERMINATEDçŠ¶æ€
                        ctl.set(ctlOf(TERMINATED, 0));
                        termination.signalAll();
                    }
                    return;
                }
            } finally {
                // é‡Šæ”¾é”
                mainLock.unlock();
            }
            // else retry on failed CAS
        }
    }

    /*
     * ç”¨äºæ§åˆ¶å¯¹å·¥ä½œçº¿ç¨‹çš„ä¸­æ–­çš„æ–¹æ³•
     */

    /**
     * å¦‚æœæœ‰å®‰å…¨ç®¡ç†å™¨ï¼Œè¯·ç¡®ä¿è°ƒç”¨æ–¹å…·æœ‰å…³é—­çº¿ç¨‹çš„æƒé™(è¯·å‚é˜…shutdownPerm)
     * å¦‚æœæƒé™æµ‹è¯•é€šè¿‡äº†ï¼Œå¦å¤–è¿˜è¦ç¡®ä¿å…è®¸è°ƒç”¨æ–¹ä¸­æ–­æ¯ä¸ªå·¥ä½œçº¿ç¨‹
     * å³ä½¿ç¬¬ä¸€æ¬¡æ£€æŸ¥é€šè¿‡ï¼Œå¦‚æœSecurityManagerç‰¹åˆ«å¤„ç†ä¸€äº›çº¿ç¨‹ï¼Œè¿™ä¹Ÿæœ€ç»ˆæ— æ³•é€šè¿‡
     */
    private void checkShutdownAccess() {
        // assert mainLock.isHeldByCurrentThread();
        SecurityManager security = System.getSecurityManager();
        // å­˜åœ¨å®‰å…¨ç®¡ç†å™¨
        if (security != null) {
            // æµ‹è¯•æƒé™
            security.checkPermission(shutdownPerm);
            // æµ‹è¯•çº¿ç¨‹è·å–æƒé™(ç¡®ä¿å…è®¸è°ƒç”¨æ–¹ä¸­æ–­æ¯ä¸ªå·¥ä½œçº¿ç¨‹)
            for (Worker w : workers)
                security.checkAccess(w.thread);
        }
    }

    /**
     * ä¸­æ–­æ‰€æœ‰çº¿ç¨‹ï¼Œå³ä½¿å¤„äºæ´»åŠ¨çŠ¶æ€
     * å¿½ç•¥SecurityExceptions(åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒæŸäº›çº¿ç¨‹å¯èƒ½ä¿æŒæœªè¢«ä¸­æ–­![å› ä¸ºå†…éƒ¨æ•è·äº†InterrupedExeception?])
     */
    private void interruptWorkers() {
        // assert mainLock.isHeldByCurrentThread();
        for (Worker w : workers)
            w.interruptIfStarted();
    }

    /**
     * ä¸­æ–­å¯èƒ½æ­£åœ¨ç­‰å¾…ä»»åŠ¡(é—²ç½®)çš„çº¿ç¨‹
     * ä»¥ä¾¿å®ƒä»¬å¯ä»¥æ£€æŸ¥ç»ˆæ­¢æˆ–é…ç½®æ›´æ”¹
     * å¿½ç•¥SecurityExceptions(åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒæŸäº›çº¿ç¨‹å¯èƒ½ä¿æŒæœªè¢«ä¸­æ–­
     *
     * @param onlyOne å¦‚æœæ˜¯trueï¼Œåˆ™æœ€å¤šæ‰“æ–­ä¸€ä¸ªå·¥äºº
     * åªæœ‰åœ¨è°ƒç”¨tryTerminateæ–¹æ³•ä½†ä»æœ‰å…¶ä»–å·¥ä½œè¿›ç¨‹æ—¶ï¼Œæ‰ä¼šä»tryTerminateè°ƒç”¨æ­¤å‡½æ•°;
     * åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¦‚æœæ‰€æœ‰çº¿ç¨‹å½“å‰éƒ½åœ¨ç­‰å¾…ï¼Œåˆ™æœ€å¤šä¼šä¸­æ–­ä¸€ä¸ªç­‰å¾…çš„å·¥ä½œè¿›ç¨‹æ¥ä¼ æ’­å…³é—­ä¿¡å·
     * ä¸­æ–­ä»»æ„çº¿ç¨‹å¯ç¡®ä¿è‡ªå…³æœºå¼€å§‹ä»¥æ¥æ–°åˆ°è¾¾çš„å·¥ä½œçº¿ç¨‹æœ€ç»ˆä¹Ÿå°†é€€å‡º
     * ä¸ºäº†ä¿è¯æœ€ç»ˆçš„ç»ˆæ­¢ï¼Œæ€»æ˜¯åªä¸­æ–­ä¸€ä¸ªç©ºé—²çš„å·¥ä½œçº¿ç¨‹å°±è¶³å¤Ÿäº†;
     * ä½†æ˜¯shutdown()æ–¹æ³•ä¼šä¸­æ–­æ‰€æœ‰ç©ºé—²çš„å·¥ä½œçº¿ç¨‹ï¼Œä»¥ä¾¿å†—ä½™çš„å·¥ä½œçº¿ç¨‹èƒ½å¤Ÿè¿…é€Ÿé€€å‡ºï¼Œè€Œä¸æ˜¯ç­‰å¾…ä¸€ä¸ªæ•£ä¹±çš„ä»»åŠ¡å®Œæˆ
     */
    private void interruptIdleWorkers(boolean onlyOne) {
        // è·å–ä¸»çº¿ç¨‹, å¹¶åŠ é”
        final ReentrantLock mainLock = this.mainLock;
        mainLock.lock();
        try {
            for (Worker w : workers) {
                // è·å–å·¥ä½œçº¿ç¨‹
                Thread t = w.thread;
                // å¦‚æœå·¥ä½œçº¿ç¨‹æœªè¢«ä¸­æ–­, ä¸”è·å–å½“å‰å·¥ä½œçº¿ç¨‹é”æˆåŠŸ
                if (!t.isInterrupted() &amp;&amp; w.tryLock()) {
                    try {
                        // ä¸­æ–­çº¿ç¨‹
                        t.interrupt();
                    } catch (SecurityException ignore) {
                    } finally {
                        w.unlock();
                    }
                }
                // å¦‚æœåªä¸­æ–­ä¸€ä¸ªçº¿ç¨‹, åˆ™ç›´æ¥é€€å‡º
                if (onlyOne)
                    break;
            }
        } finally {
            mainLock.unlock();
        }
    }

    /**
     * å¸¸è§å½¢å¼çš„interruptedleworkersï¼Œä»¥é¿å…è®°ä½å¸ƒå°”å‚æ•°çš„å«ä¹‰
     */
    private void interruptIdleWorkers() {
        interruptIdleWorkers(false);
    }

    // é»˜è®¤åœ¨åœæ­¢æ—¶åªä¸­æ–­ä¸€ä¸ªçº¿ç¨‹
    private static final boolean ONLY_ONE = true;

    /*
     * å…¶ä»–å®ç”¨ç¨‹åºï¼Œå…¶ä¸­å¤§éƒ¨åˆ†ä¹Ÿè¢«ScheduledThreadPoolExecutorç»§æ‰¿
     */

    /**
     * ä¸ºç»™å®šçš„å‘½ä»¤è°ƒç”¨è¢«æ‹’ç»æ—¶æ‰§è¡Œçš„å¤„ç†ç¨‹åº
     * ä¸ºScheduledThreadPoolExecutorä½¿ç”¨è€Œä½¿ç”¨é»˜è®¤å¯è§æ€§(åŒ…å¯è§)
     */
    final void reject(Runnable command) {
        handler.rejectedExecution(command, this);
    }

    /**
     * åœ¨è°ƒç”¨shutdownæ—¶æ‰§è¡Œè¿è¡ŒçŠ¶æ€è½¬æ¢ä¹‹åçš„ä»»ä½•è¿›ä¸€æ­¥æ¸…ç†
     * è¿™é‡Œæ˜¯noæ“ä½œï¼Œä½†åœ¨ScheduledThreadPoolExecutorä¸­ç”¨äºå–æ¶ˆå»¶è¿Ÿçš„ä»»åŠ¡
     */
    void onShutdown() {
    }

    /**
     * å°†ä»»åŠ¡é˜Ÿåˆ—æ’å…¥æ–°åˆ—è¡¨ï¼Œé€šå¸¸ä½¿ç”¨drainTo
     * ä½†æ˜¯ï¼Œå¦‚æœé˜Ÿåˆ—æ˜¯DelayQueueæˆ–ä»»ä½•å…¶ä»–ç±»å‹çš„é˜Ÿåˆ—,
     * è€Œpollæˆ–drainToå¯èƒ½æ— æ³•å–å‡ºæŸäº›å…ƒç´ ï¼Œåˆ™å®ƒä¼šé€ä¸ªåŠ å…¥å¹¶åˆ é™¤!
     */
    private List&lt;Runnable&gt; drainQueue() {
        // å–å‡ºå·¥ä½œé˜Ÿåˆ—
        BlockingQueue&lt;Runnable&gt; q = workQueue;
        // å¾…è¿”å›çš„ä»»åŠ¡é˜Ÿåˆ—
        ArrayList&lt;Runnable&gt; taskList = new ArrayList&lt;&gt;();
        // ä½¿ç”¨é˜»å¡é˜Ÿåˆ—çš„drainToæ–¹æ³•
        q.drainTo(taskList);
        // æ— æ³•å–å‡ºæŸäº›å…ƒç´ ï¼Œåˆ™é€ä¸ªåˆ é™¤
        if (!q.isEmpty()) {
            for (Runnable r : q.toArray(new Runnable[0])) {
                if (q.remove(r))
                    taskList.add(r);
            }
        }
        return taskList;
    }

    /*
     * åˆ›å»ºã€è¿è¡Œå’Œæ¸…ç†æ–¹æ³•
     */

    /**
     * æ£€æŸ¥æ˜¯å¦å¯ä»¥æ ¹æ®å½“å‰æ± çŠ¶æ€å’Œç»™å®šçš„å‚æ•°(æ ¸å¿ƒæˆ–æœ€å¤§å€¼)æ·»åŠ æ–°çš„å·¥ä½œè¿›ç¨‹
     * å¦‚æœå¯ä»¥æ·»åŠ ï¼Œåˆ™ç›¸åº”åœ°è°ƒæ•´å·¥ä½œè¿›ç¨‹è®¡æ•°;
     * å¦‚æœè°ƒæ•´å·¥ä½œè¿›ç¨‹è®¡æ•°æˆåŠŸï¼Œåˆ™åˆ›å»ºå¹¶å¯åŠ¨ä¸€ä¸ªæ–°çš„å·¥ä½œè¿›ç¨‹ï¼Œå°†firsttaskå‚æ•°ä½œä¸ºå…¶ç¬¬ä¸€ä¸ªä»»åŠ¡
     * å¦‚æœæ± å·²åœæ­¢æˆ–ç¬¦åˆå…³é—­æ¡ä»¶ï¼Œåˆ™æ­¤æ–¹æ³•è¿”å›false
     * å¦‚æœçº¿ç¨‹å·¥å‚åœ¨æœªèƒ½åˆ›å»ºçº¿ç¨‹ï¼Œå®ƒä¹Ÿä¼šè¿”å›false
     * å¦‚æœçº¿ç¨‹åˆ›å»ºå¤±è´¥ï¼Œæˆ–è€…æ˜¯ç”±äºçº¿ç¨‹å·¥å‚è¿”å›nullï¼Œæˆ–è€…æ˜¯ç”±äºå¼‚å¸¸(é€šå¸¸æ˜¯thread.start()ä¸­çš„OutOfMemoryErrorï¼‰ï¼Œæˆ‘ä»¬å°†å¹²å‡€åœ°å›æ»š
     *
     * @param firstTask æ–°çº¿ç¨‹åº”è¯¥é¦–å…ˆè¿è¡Œçš„ä»»åŠ¡(å¦‚æœæ²¡æœ‰ï¼Œåˆ™ä¸ºç©º)
     * åˆ›å»ºå·¥ä½œçº¿ç¨‹æ—¶ï¼Œé¦–å…ˆè¦åˆ›å»ºä¸€ä¸ªåˆå§‹ä»»åŠ¡(åœ¨execute()æ–¹æ³•ä¸­)ï¼Œä»¥ä¾¿åœ¨å°‘äºcorePoolSizeçº¿ç¨‹æ—¶ç»•è¿‡é˜Ÿåˆ—
     * (åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬æ€»æ˜¯å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹)
     * æˆ–è€…åœ¨é˜Ÿåˆ—å·²æ»¡(åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¿…é¡»ç»•è¿‡é˜Ÿåˆ—)
     * åœ¨åˆå§‹åŒ–æ—¶, ç©ºé—²çº¿ç¨‹é€šå¸¸æ˜¯é€šè¿‡prestartCoreThreadåˆ›å»ºçš„ï¼Œæˆ–è€…ç”¨æ¥æ›¿æ¢å…¶ä»–æ­£åœ¨æ­»äº¡çš„å·¥ä½œçº¿ç¨‹
     *
     * @param core å¦‚æœä¸ºtrueï¼Œåˆ™ä½¿ç”¨corePoolSizeä½œä¸ºç»‘å®šï¼Œå¦åˆ™ä½¿ç”¨maximumPoolSize
     * (æ­¤å¤„ä½¿ç”¨å¸ƒå°”æŒ‡ç¤ºç¬¦è€Œä¸æ˜¯å€¼ï¼Œä»¥ç¡®ä¿åœ¨æ£€æŸ¥å…¶ä»–çº¿ç¨‹æ± çŠ¶æ€åè¯»å–æ–°å€¼)
     * @return true if successful
     */
    private boolean addWorker(Runnable firstTask, boolean core) {
        retry:
        for (int c = ctl.get();;) {
            // ä»…åœ¨å¿…è¦æ—¶æ£€æŸ¥é˜Ÿåˆ—æ˜¯å¦ä¸ºç©º
            // å¦‚æœçº¿ç¨‹æ± çŠ¶æ€ä¸ºSHUTDOWN
            // ä¸”å¦‚æœçº¿ç¨‹æ± çŠ¶æ€ä¸ºSTOP, æˆ–è€…ä»»åŠ¡ä¸ä¸ºç©ºæˆ–è€…å·¥ä½œé˜Ÿåˆ—ä¸ºç©º
            // æ­¤æ—¶ä¸å¢åŠ 
            if (runStateAtLeast(c, SHUTDOWN)
                &amp;&amp; (runStateAtLeast(c, STOP)
                    || firstTask != null
                    || workQueue.isEmpty()))
                return false;


            for (;;) {
                // å½“å‰å·¥ä½œæ ¸å¿ƒæ•°å¤§äºå£°æ˜è¦æ±‚(æ­¤æ—¶æ— æ³•æ·»åŠ )
                if (workerCountOf(c)
                    &gt;= ((core ? corePoolSize : maximumPoolSize) &amp; COUNT_MASK))
                    return false;
                // å¦åˆ™å¦‚æœCASåˆ›å»ºå·¥ä½œçº¿ç¨‹æˆåŠŸ, ç›´æ¥break;
                if (compareAndIncrementWorkerCount(c))
                    break retry;
                // å¦åˆ™CASåˆ›å»ºçº¿ç¨‹å¤±è´¥, é‡æ–°è·å–å½“å‰çº¿ç¨‹æ± çŠ¶æ€
                c = ctl.get();  // Re-read ctl
                // å¦‚æœçŠ¶æ€ä¸ºSHUTDOWN, åˆ™é‡æ–°å¾ªç¯
                // (æ³¨æ„, ä¸‹æ¬¡çš„çŠ¶æ€&quot;å¯èƒ½&quot;ä¸ºSHUTDOWN)
                if (runStateAtLeast(c, SHUTDOWN))
                    continue retry;
                // else CAS failed due to workerCount change; retry inner loop
            }
        }

        boolean workerStarted = false;
        boolean workerAdded = false;
        Worker w = null;
        try {
            // åˆ›å»ºæ–°çš„å·¥äºº, å¹¶ä¼ å…¥ä»»åŠ¡firstTask
            w = new Worker(firstTask);
            // è·å–Workerå†…éƒ¨å®šä¹‰çš„çº¿ç¨‹(æ­¤æ—¶çº¿ç¨‹å·²ç»è¢«ThreadFactoryåˆå§‹åŒ–äº†)
            final Thread t = w.thread;
            if (t != null) {
                // é€šè¿‡çº¿ç¨‹æ± ä¸»é”åŠ é”
                final ReentrantLock mainLock = this.mainLock;
                mainLock.lock();
                try {
                    int c = ctl.get();

                    // æŒæœ‰é”æ—¶é‡æ–°æ£€æŸ¥
                    // åœ¨ThreadFactoryå¤±è´¥æˆ–è·å–é”ä¹‹å‰çº¿ç¨‹æ± è¢«shutdownæ—¶é€€å‡º
                    if (isRunning(c) ||
                        (runStateLessThan(c, STOP) &amp;&amp; firstTask == null)) {
                        if (t.isAlive()) // é¢„æ£€æŸ¥å·¥ä½œçº¿ç¨‹tå¯ä»¥è¢«å¯åŠ¨(startable)
                            throw new IllegalThreadStateException();

                        // åŠ å…¥å·¥ä½œé˜Ÿåˆ—
                        workers.add(w);
                        int s = workers.size();
                        // æ›´æ–°æ± å¤§å°
                        if (s &gt; largestPoolSize)
                            largestPoolSize = s;
                        workerAdded = true;
                    }
                } finally {
                    mainLock.unlock();
                }
                // å¦‚æœæˆåŠŸæ·»åŠ äº†workeråˆ°å·¥äººé˜Ÿåˆ—
                if (workerAdded) {
                    t.start();
                    workerStarted = true;
                }
            }
        } finally {
            // å¦‚æœæ·»åŠ å¤±è´¥, å›æ»š
            if (! workerStarted)
                addWorkerFailed(w);
        }
        return workerStarted;
    }

    /**
     * å›æ»šå·¥ä½œçº¿ç¨‹åˆ›å»º
     * -ä»å·¥äººé˜Ÿåˆ—ä¸­ç§»é™¤å·¥äººï¼ˆå¦‚æœå­˜åœ¨ï¼‰
     * -å‡å°‘å·¥äººæ•°é‡
     * -é‡æ–°æ£€æŸ¥æ˜¯å¦ç»ˆæ­¢ï¼Œä»¥é˜²è¯¥å‘˜å·¥çš„å­˜åœ¨å¯¼è‡´ç»ˆæ­¢
     */
    private void addWorkerFailed(Worker w) {
        final ReentrantLock mainLock = this.mainLock;
        mainLock.lock();
        try {
            // ä»å·¥äººé˜Ÿåˆ—ä¸­ç§»é™¤å·¥äººï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if (w != null)
                workers.remove(w);
            // å‡å°‘å·¥äººæ•°é‡
            decrementWorkerCount();
            // é‡æ–°æ£€æŸ¥æ˜¯å¦ç»ˆæ­¢ï¼Œä»¥é˜²è¯¥å‘˜å·¥çš„å­˜åœ¨å¯¼è‡´ç»ˆæ­¢
            tryTerminate();
        } finally {
            mainLock.unlock();
        }
    }

    /**
     * å¯¹å¾…æ¸…é™¤çš„å·¥äººè¿›è¡Œæ¸…ç†å’Œè®°å½•, ä»…ä»å·¥ä½œçº¿ç¨‹è°ƒç”¨
     * é™¤éè®¾ç½®ä¸º&quot;completedAbruptly&quot;ï¼Œå¦åˆ™å‡å®šworkerCountå·²è°ƒæ•´ä¸ºé€€å‡ºçŠ¶æ€
     * æ­¤æ–¹æ³•å°†çº¿ç¨‹ä»å·¥ä½œé›†åˆsetä¸­ç§»é™¤;
     * å¦‚æœå·¥ä½œé›†åˆsetç”±äºç”¨æˆ·ä»»åŠ¡å¼‚å¸¸è€Œé€€å‡º,
     * æˆ–è€…å¦‚æœè¿è¡Œçš„å·¥ä½œé›†å°‘äºcorePoolSize,
     * æˆ–è€…é˜Ÿåˆ—ä¸ºéç©ºä½†å·¥ä½œé›†åˆsetä¸ºç©º, åˆ™å¯èƒ½ç»ˆæ­¢æ± æˆ–æ›¿æ¢å·¥äºº(worker)
     *
     * @param w the worker
     * @param completedAbruptly å¦‚æœå…è®¸å·¥ä½œè¿›ç¨‹ç”±äºç”¨æˆ·å¼‚å¸¸è€Œæ­»äº¡
     */
    private void processWorkerExit(Worker w, boolean completedAbruptly) {
        if (completedAbruptly) // completedAbruptlyï¼Œåˆ™æœªè°ƒæ•´workerCount
            decrementWorkerCount();

        final ReentrantLock mainLock = this.mainLock;
        mainLock.lock();
        try {
            // æ›´æ–°å·²ç»å®Œæˆçš„ä»»åŠ¡æ•°è®°å½•
            // å¹¶ç§»é™¤å·¥äºº
            completedTaskCount += w.completedTasks;
            workers.remove(w);
        } finally {
            mainLock.unlock();
        }

        tryTerminate();

        int c = ctl.get();
        if (runStateLessThan(c, STOP)) {
            if (!completedAbruptly) {
                int min = allowCoreThreadTimeOut ? 0 : corePoolSize;
                if (min == 0 &amp;&amp; ! workQueue.isEmpty())
                    min = 1;
                if (workerCountOf(c) &gt;= min)
                    return; // replacement not needed
            }
            addWorker(null, false);
        }
    }

    /**
     * æ ¹æ®å½“å‰é…ç½®, è·å–ä»»åŠ¡(å¯èƒ½ä¼šé€ æˆé˜»å¡æˆ–å®šæ—¶ç­‰å¾…);
     * å¦‚æœæ­¤å·¥ä½œè¿›ç¨‹ç”±äºä»¥ä¸‹åŸå› å¿…é¡»é€€å‡ºï¼Œåˆ™è¿”å›null:
     * 1.æœ‰å¤šäºmaximumPoolSizeä¸ªå·¥ä½œçº¿ç¨‹(ç”±äºè°ƒç”¨äº†setMaximumPoolSize)
     * 2.çº¿ç¨‹æ± å·²åœæ­¢;
     * 3.çº¿ç¨‹æ± å·²å…³é—­ï¼Œé˜Ÿåˆ—ä¸ºç©º;
     * 4.è¿™ä¸ªå·¥äººåœ¨ç­‰å¾…ä»»åŠ¡æ—¶è¶…æ—¶ï¼Œå¹¶ä¸”è¶…æ—¶çš„å·¥ä½œçº¿ç¨‹åœ¨è¶…æ—¶ç­‰å¾…ä¹‹å‰å’Œä¹‹åéƒ½å°†è¢«ç»ˆæ­¢
     * (å³allowCoreThreadTimeOut | | workerCount&gt;corePoolSize)
     * [å¦‚æœé˜Ÿåˆ—éç©ºï¼Œåˆ™æ­¤å·¥ä½œçº¿ç¨‹ä¸æ˜¯çº¿ç¨‹æ± ä¸­çš„æœ€åä¸€ä¸ªçº¿ç¨‹]
     *
     * @return ä»»åŠ¡, æˆ–è€…å¦‚æœå·¥äººå°†è¦é€€å‡º(åœæ­¢)ï¼Œåˆ™ä¸ºç©º(åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå°†é€’å‡workerCount)
     */
    private Runnable getTask() {
        boolean timedOut = false; // ä¸Šæ¬¡poll()è¶…æ—¶äº†å—ï¼Ÿ

        for (;;) {
            int c = ctl.get();

            // Check if queue empty only if necessary.
            if (runStateAtLeast(c, SHUTDOWN)
                &amp;&amp; (runStateAtLeast(c, STOP) || workQueue.isEmpty())) {
                decrementWorkerCount();
                return null;
            }

            int wc = workerCountOf(c);

            // å·¥äººä¼šè¢«æ·˜æ±°å—ï¼Ÿ
            // é€šè¿‡åˆ¤æ–­å…è®¸æ ¸å¿ƒå·¥äººè¶…æœŸæˆ–å·¥äººæ•°è¶…è¿‡æ ¸å¿ƒå·¥äººæ•°
            boolean timed = allowCoreThreadTimeOut || wc &gt; corePoolSize;

            // å¦‚æœ:
            // 1.æœ‰å¤šäºmaximumPoolSizeä¸ªå·¥ä½œçº¿ç¨‹(ç”±äºè°ƒç”¨äº†setMaximumPoolSize)
            // 2.çº¿ç¨‹æ± å·²åœæ­¢;
            // 3.çº¿ç¨‹æ± å·²å…³é—­ï¼Œé˜Ÿåˆ—ä¸ºç©º;
            // 4.è¿™ä¸ªå·¥äººåœ¨ç­‰å¾…ä»»åŠ¡æ—¶è¶…æ—¶ï¼Œå¹¶ä¸”è¶…æ—¶çš„å·¥ä½œçº¿ç¨‹åœ¨è¶…æ—¶ç­‰å¾…ä¹‹å‰å’Œä¹‹åéƒ½å°†è¢«ç»ˆæ­¢
            // è¿”å›null
            if ((wc &gt; maximumPoolSize || (timed &amp;&amp; timedOut))
                &amp;&amp; (wc &gt; 1 || workQueue.isEmpty())) {
                if (compareAndDecrementWorkerCount(c))
                    return null;
                continue;
            }

            try {
                // æ ¹æ®ä»»åŠ¡ç±»å‹è·å–ä»»åŠ¡
                Runnable r = timed ?
                    workQueue.poll(keepAliveTime, TimeUnit.NANOSECONDS) :
                    workQueue.take();
                if (r != null)
                    return r;
                timedOut = true;
            } catch (InterruptedException retry) {
                timedOut = false;
            }
        }
    }

    /**
     * å·¥äººè¿›ç¨‹è¿è¡Œä¸»loop
     * ä»é˜Ÿåˆ—ä¸­é‡å¤è·å–ä»»åŠ¡å¹¶æ‰§è¡Œå®ƒä»¬ï¼ŒåŒæ—¶å¤„ç†è®¸å¤šé—®é¢˜:
     *
     * 1.æˆ‘ä»¬å¯ä»¥ä»ä¸€ä¸ªåˆå§‹ä»»åŠ¡å¼€å§‹ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¸éœ€è¦å¾—åˆ°(é˜Ÿåˆ—ä¸­çš„)ç¬¬ä¸€ä¸ªä»»åŠ¡;
     * å¦åˆ™ï¼Œåªè¦çº¿ç¨‹æ± æ­£åœ¨è¿è¡Œï¼Œæˆ‘ä»¬å°±ä»getTaskæ–¹æ³•è·å–ä»»åŠ¡;
     * å¦‚æœgetTaskæ–¹æ³•è¿”å›nullï¼Œåˆ™å·¥ä½œè¿›ç¨‹å°†ç”±äºçº¿ç¨‹æ± çŠ¶æ€æˆ–é…ç½®çš„æ›´æ”¹è€Œé€€å‡º;
     * å…¶ä»–çš„é€€å‡ºæ˜¯ç”±å¤–éƒ¨ä»£ç ä¸­çš„å¼‚å¸¸å¼•å‘çš„ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹completedAbruptlyä¼šä¿æŒ, è¿™é€šå¸¸ä¼šå¯¼è‡´processWorkerExitæ›¿æ¢æ­¤çº¿ç¨‹
     *
     * 2.åœ¨è¿è¡Œä»»ä½•ä»»åŠ¡ä¹‹å‰ï¼Œè·å–é”æ˜¯ä¸ºäº†é˜²æ­¢ä»»åŠ¡æ‰§è¡Œæ—¶å…¶ä»–çº¿ç¨‹æ± ä¸­æ–­;
     * ç„¶åæˆ‘ä»¬ç¡®ä¿é™¤éæ± åœæ­¢ï¼Œå¦åˆ™æ­¤çº¿ç¨‹æ²¡æœ‰è¢«è®¾ç½®ä¸­æ–­
     *
     * 3.æ¯ä¸ªä»»åŠ¡è¿è¡Œä¹‹å‰éƒ½ä¼šè°ƒç”¨beforexecuteæ–¹æ³•ï¼Œè¿™å¯èƒ½ä¼šå¼•å‘å¼‚å¸¸;
     * åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¼šä½¿çº¿ç¨‹åœ¨ä¸å¤„ç†ä»»åŠ¡çš„æƒ…å†µä¸‹æ­»äº¡
     * (ä»¥completedAbruptly=trueä¸­æ–­å¾ªç¯)
     *
     * 4.å‡è®¾beforexecuteæ­£å¸¸å®Œæˆï¼Œæˆ‘ä»¬è¿è¡Œè¯¥ä»»åŠ¡ï¼Œæ”¶é›†å…¶æŠ›å‡ºçš„ä»»ä½•å¼‚å¸¸ä»¥å‘é€åˆ°afterExecuteæ–¹æ³•
     * æˆ‘ä»¬åˆ†åˆ«å¤„ç†RuntimeException, Error(è¿™ä¸¤ä¸ªè§„èŒƒéƒ½ä¿è¯æˆ‘ä»¬æ•è·)å’Œä»»æ„Throwables
     * å› ä¸ºæˆ‘ä»¬ä¸èƒ½åœ¨Runnable.runä¸­é‡æ–°æŠ›å‡ºThrowablesï¼Œæ‰€ä»¥åœ¨é€€å‡ºæ—¶å°†å®ƒä»¬åŒ…è£…åœ¨Errorsä¸­
     * (å·¥ä½œçº¿ç¨‹çš„UncaughtExceptionHandler)
     * ä»»ä½•æŠ›å‡ºçš„å¼‚å¸¸ä¹Ÿä¼šä¿å®ˆåœ°å¯¼è‡´çº¿ç¨‹æ­»äº¡
     *
     * 5.åœ¨task.runæ–¹æ³•å®Œæˆåï¼Œæˆ‘ä»¬è°ƒç”¨afterExecute, è¿™ä¹Ÿå¯èƒ½å¼•å‘å¼‚å¸¸ï¼Œè¿™ä¹Ÿä¼šå¯¼è‡´çº¿ç¨‹æ­»äº¡
     * æ ¹æ®JLS Sec 14.20ï¼Œå³ä½¿task.runæŠ›å‡ºå¼‚å¸¸ï¼Œè¿™ä¸ªå½±å“(å¯¼è‡´çº¿ç¨‹æ­»äº¡)ä¹Ÿæ˜¯æœ‰æ•ˆçš„
     *
     * å¼‚å¸¸æœºåˆ¶çš„ç»“æœæ˜¯:
     * afterExecuteå’Œçº¿ç¨‹çš„UncaughtExceptionHandlerä½¿æˆ‘ä»¬å¯ä»¥æä¾›
     * å…³äºç”¨æˆ·ä»£ç é‡åˆ°çš„ä»»ä½•é—®é¢˜çš„å‡†ç¡®ä¿¡æ¯
     *
     * @param w the worker
     */
    final void runWorker(Worker w) {
        Thread wt = Thread.currentThread();
        // å–å‡ºä»»åŠ¡
        Runnable task = w.firstTask;
        w.firstTask = null;
        // å…è®¸å·¥ä½œçº¿ç¨‹è¢«ä¸­æ–­
        w.unlock(); 
        boolean completedAbruptly = true;
        try {
            // firstTaskä¸ºç©ºæ—¶, é€šè¿‡getTaskæ–¹æ³•è·å–ä»»åŠ¡
            while (task != null || (task = getTask()) != null) {
                // å·¥äººåŠ é”, é˜²æ­¢å¤–éƒ¨ä¿®æ”¹çŠ¶æ€
                w.lock();
                // å¦‚æœæ± æ­£åœ¨åœæ­¢ï¼Œç¡®ä¿çº¿ç¨‹è¢«ä¸­æ–­ï¼›
                // å¦‚æœæ²¡æœ‰ï¼Œè¯·ç¡®ä¿çº¿ç¨‹æ²¡æœ‰ä¸­æ–­
                // åœ¨ç¬¬äºŒç§æƒ…å†µä¸‹éœ€è¦é‡æ–°æ£€æŸ¥ï¼Œä»¥åœ¨æ¸…é™¤ä¸­æ–­æ—¶å¤„ç†shutdownNowæƒ…å†µ
                if ((runStateAtLeast(ctl.get(), STOP) ||
                     (Thread.interrupted() &amp;&amp;
                      runStateAtLeast(ctl.get(), STOP))) &amp;&amp;
                    !wt.isInterrupted())
                    wt.interrupt();
                try {
                    // æ‰§è¡ŒbeforeExecute
                    beforeExecute(wt, task);
                    try {
                        // æ‰§è¡Œä»»åŠ¡
                        task.run();
                        // æ‰§è¡ŒafterExecute
                        afterExecute(task, null);
                    } catch (Throwable ex) {
                        // afterExecuteå¤„ç†å¯èƒ½å‡ºç°çš„å¼‚å¸¸
                        afterExecute(task, ex);
                        throw ex;
                    }
                } finally {
                    // æœ€å:
                    // 1.ä»»åŠ¡ç½®ä¸ºnull(å¸®åŠ©GC)
                    // 2.ä»»åŠ¡å®Œæˆæ•°+1
                    // 3.ä»»åŠ¡è§£é”çº¿ç¨‹
                    task = null;
                    w.completedTasks++;
                    w.unlock();
                }
            }
            completedAbruptly = false;
        } finally {
            processWorkerExit(w, completedAbruptly);
        }
    }

    // pubilc æ„é€ æ–¹æ³•å’Œæ–¹æ³•

    public ThreadPoolExecutor(int corePoolSize,
                              int maximumPoolSize,
                              long keepAliveTime,
                              TimeUnit unit,
                              BlockingQueue&lt;Runnable&gt; workQueue) {
        this(corePoolSize, maximumPoolSize, keepAliveTime, unit, workQueue,
             Executors.defaultThreadFactory(), defaultHandler);
    }

    public ThreadPoolExecutor(int corePoolSize,
                              int maximumPoolSize,
                              long keepAliveTime,
                              TimeUnit unit,
                              BlockingQueue&lt;Runnable&gt; workQueue,
                              ThreadFactory threadFactory) {
        this(corePoolSize, maximumPoolSize, keepAliveTime, unit, workQueue,
             threadFactory, defaultHandler);
    }

    public ThreadPoolExecutor(int corePoolSize,
                              int maximumPoolSize,
                              long keepAliveTime,
                              TimeUnit unit,
                              BlockingQueue&lt;Runnable&gt; workQueue,
                              RejectedExecutionHandler handler) {
        this(corePoolSize, maximumPoolSize, keepAliveTime, unit, workQueue,
             Executors.defaultThreadFactory(), handler);
    }

    /**
     * ä½¿ç”¨ç»™å®šçš„åˆå§‹å‚æ•°åˆ›å»ºæ–°çš„ThreadPoolExecutor
     *
     * @param corePoolSize è¦ä¿ç•™åœ¨æ± ä¸­çš„çº¿ç¨‹æ•°ï¼Œå³ä½¿å®ƒä»¬å¤„äºç©ºé—²çŠ¶æ€
     * (é™¤éè®¾ç½®äº† allowCoreThreadTimeOut)
     *
     * @param maximumPoolSize çº¿ç¨‹æ± ä¸­å…è®¸çš„æœ€å¤§çº¿ç¨‹æ•°
     * @param keepAliveTime å½“çº¿ç¨‹æ•°å¤§äºæ ¸å¿ƒæ—¶ï¼Œè¿™æ˜¯å¤šä½™ç©ºé—²çº¿ç¨‹åœ¨ç»ˆæ­¢å‰ç­‰å¾…æ–°ä»»åŠ¡çš„æœ€é•¿æ—¶é—´
     * @param unit æ—¶é—´å•ä½
     * @param workQueue åœ¨æ‰§è¡Œä»»åŠ¡ä¹‹å‰ç”¨äºä¿å­˜ä»»åŠ¡çš„é˜Ÿåˆ—
     * (æ­¤é˜Ÿåˆ—å°†ä»…åŒ…å«ç”±executeæ–¹æ³•æäº¤çš„Runnableä»»åŠ¡
     * @param threadFactory æ‰§è¡Œå™¨åˆ›å»ºæ–°çº¿ç¨‹æ—¶ä½¿ç”¨çš„å·¥å‚
     * @param handler ç”±äºè¾¾åˆ°çº¿ç¨‹è¾¹ç•Œå’Œé˜Ÿåˆ—å®¹é‡è€Œé˜»æ­¢æ‰§è¡Œæ—¶è¦ä½¿ç”¨çš„å¤„ç†ç¨‹åº(æ‹’ç»ç­–ç•¥)
     * @throws IllegalArgumentException å¦‚æœä¸‹åˆ—æ¡ä»¶ä¹‹ä¸€æˆç«‹:
     *         {@code corePoolSize &lt; 0}&lt;br&gt;
     *         {@code keepAliveTime &lt; 0}&lt;br&gt;
     *         {@code maximumPoolSize &lt;= 0}&lt;br&gt;
     *         {@code maximumPoolSize &lt; corePoolSize}
     * @throws NullPointerException å¦‚æœworkQueueæˆ–threadFactoryæˆ–handlerä¸ºç©º
     */
    public ThreadPoolExecutor(int corePoolSize,
                              int maximumPoolSize,
                              long keepAliveTime,
                              TimeUnit unit,
                              BlockingQueue&lt;Runnable&gt; workQueue,
                              ThreadFactory threadFactory,
                              RejectedExecutionHandler handler) {
        if (corePoolSize &lt; 0 ||
            maximumPoolSize &lt;= 0 ||
            maximumPoolSize &lt; corePoolSize ||
            keepAliveTime &lt; 0)
            throw new IllegalArgumentException();
        if (workQueue == null || threadFactory == null || handler == null)
            throw new NullPointerException();
        this.corePoolSize = corePoolSize;
        this.maximumPoolSize = maximumPoolSize;
        this.workQueue = workQueue;
        this.keepAliveTime = unit.toNanos(keepAliveTime);
        this.threadFactory = threadFactory;
        this.handler = handler;
    }

    /**
     * åœ¨å°†æ¥çš„æŸä¸ªæ—¶å€™æ‰§è¡Œç»™å®šçš„ä»»åŠ¡, ä»»åŠ¡å¯ä»¥åœ¨æ–°çº¿ç¨‹æˆ–ç°æœ‰æ± çº¿ç¨‹ä¸­æ‰§è¡Œ
     *
     * å¦‚æœç”±äºè¯¥æ‰§è¡Œå™¨å·²å…³é—­æˆ–å·²è¾¾åˆ°å…¶å®¹é‡è€Œæ— æ³•æäº¤ä»»åŠ¡ä»¥ä¾›æ‰§è¡Œ,
     * åˆ™ç”±å½“å‰çš„RejectedExecutionHandlerå¤„ç†è¯¥ä»»åŠ¡
     *
     * @param command the task to execute
     * @throws RejectedExecutionException at discretion of
     *         {@code RejectedExecutionHandler}, if the task
     *         cannot be accepted for execution
     * @throws NullPointerException if {@code command} is null
     */
    public void execute(Runnable command) {
        // å¦‚æœä»»åŠ¡ä¸ºnull, ç›´æ¥æŠ¥NullPointerExceptionå¼‚å¸¸
        if (command == null)
            throw new NullPointerException();
        /*
         * Proceed in 3 steps:
         *
         * 1.å¦‚æœè¿è¡Œçš„çº¿ç¨‹å°‘äºcorePoolSizeï¼Œå°è¯•ä»¥ç»™å®šçš„å‘½ä»¤ä½œä¸ºç¬¬ä¸€ä¸ªä»»åŠ¡å¯åŠ¨æ–°çº¿ç¨‹æ‰§è¡Œ
         * å¯¹addWorkerçš„è°ƒç”¨ä»¥åŸå­æ–¹å¼æ£€æŸ¥runStateå’ŒworkerCount,
         * å› æ­¤å¯ä»¥é€šè¿‡è¿”å›falseæ¥é˜²æ­¢åœ¨ä¸åº”è¯¥æ·»åŠ çº¿ç¨‹æ—¶å‡ºç°çš„é”™è¯¯è­¦æŠ¥
         *
         * 2.å¦‚æœä»»åŠ¡å¯ä»¥æˆåŠŸæ’é˜Ÿï¼Œé‚£ä¹ˆæˆ‘ä»¬ä»ç„¶éœ€è¦å†æ¬¡æ£€æŸ¥æ˜¯å¦åº”è¯¥æ·»åŠ çº¿ç¨‹
         * (å› ä¸ºè‡ªä¸Šæ¬¡æ£€æŸ¥ä»¥æ¥å¯èƒ½å·²æœ‰çº¿ç¨‹æ­»äº¡)
         * æˆ–è€…æ± æ˜¯å¦åœ¨è¿›å…¥æ­¤æ–¹æ³•åå…³é—­!
         * å› æ­¤ï¼Œæˆ‘ä»¬é‡æ–°æ£€æŸ¥çŠ¶æ€:
         * å¦‚æœåœæ­¢ï¼Œåˆ™å›æ»šæ’é˜Ÿ; å¦‚æœæ²¡æœ‰ï¼Œåˆ™å¯åŠ¨æ–°çº¿ç¨‹
         *
         * 3. å¦‚æœæ— æ³•å°†ä»»åŠ¡æ’é˜Ÿï¼Œåˆ™å°è¯•æ·»åŠ æ–°çº¿ç¨‹;
         * å¦‚æœå¤±è´¥äº†ï¼Œåˆ™è¯´æ˜çº¿ç¨‹æ± æ­£åœ¨è¢«å…³é—­æˆ–çº¿ç¨‹æ± é¥±å’Œï¼Œæ‰€ä»¥æ‹’ç»ä»»åŠ¡;
         */
        // è·å–çŠ¶æ€
        int c = ctl.get();
        // å¦‚æœç°æœ‰å·¥ä½œçº¿ç¨‹æ•°å°äºcorePoolSize
        if (workerCountOf(c) &lt; corePoolSizecorePoolSize) {
            // åˆ™é€šè¿‡æ–°åŠ å…¥ä¸€ä¸ªworkeræ¥æ‰§è¡Œæ–°ä»»åŠ¡(æ­¤æ—¶ä»»åŠ¡åœ¨æ–°çº¿ç¨‹æ‰§è¡Œ)
            if (addWorker(command, true))
                return;
            // æ— æ³•è·å–æ–°å·¥äºº, æ›´æ–°çº¿ç¨‹æ± çŠ¶æ€
            c = ctl.get();
        }
        // å¦‚æœçº¿ç¨‹æ± åœ¨è¿è¡Œ, ä¸”åŠ å…¥ä»»åŠ¡æˆåŠŸ
        if (isRunning(c) &amp;&amp; workQueue.offer(command)) {
            // æ›´æ–°çº¿ç¨‹æ± çŠ¶æ€
            int recheck = ctl.get();
            // å¦‚æœçº¿ç¨‹æ± æ²¡åœ¨è¿è¡Œ, ä¸”åˆ é™¤ä»»åŠ¡æˆåŠŸ
            if (! isRunning(recheck) &amp;&amp; remove(command))
                // æ‹’ç»
                reject(command);
            // å¦‚æœçº¿ç¨‹æ± çŠ¶æ€ä¸­å·¥äººå˜ä¸º0ä¸ª
            else if (workerCountOf(recheck) == 0)
                // æ·»åŠ å·¥äºº
                addWorker(null, false);
        }
        // å¦åˆ™, çº¿ç¨‹æ± æœªåœ¨è¿è¡Œæˆ–ä»»åŠ¡æœªæˆåŠŸåŠ å…¥
        // é€šè¿‡æ–°åŠ å…¥ä¸€ä¸ªworkeræ¥æ‰§è¡Œæ–°ä»»åŠ¡(æ­¤æ—¶ä»»åŠ¡åœ¨æ–°çº¿ç¨‹æ‰§è¡Œ)
        else if (!addWorker(command, false))
            // åŠ å…¥å·¥äººå¤±è´¥, æ‹’ç»
            reject(command);
    }

    /**
     * å¯åŠ¨æœ‰åºå…³é—­ï¼Œåœ¨è¯¥å…³é—­å‰æ‰§è¡Œä»¥å‰æäº¤çš„ä»»åŠ¡ï¼Œä½†ä¸æ¥å—æ–°ä»»åŠ¡
     * å¦‚æœå·²å…³é—­ï¼Œåˆ™è°ƒç”¨æ²¡æœ‰æ•ˆæœ
     *
     * æ­¤æ–¹æ³•ä¸ä¼šæ°¸ä¹…ç­‰å¾…ä»¥å‰æäº¤çš„ä»»åŠ¡å®Œæˆæ‰§è¡Œ, (ä½¿ç”¨awaitTerminationæ‰§è¡Œæ­¤æ“ä½œ)
     *
     * @throws SecurityException {@inheritDoc}
     */
    public void shutdown() {
        final ReentrantLock mainLock = this.mainLock;
        mainLock.lock();
        try {
            // æ£€æŸ¥åœæ­¢æƒé™
            checkShutdownAccess();
            // æ›´æ–°çŠ¶æ€
            advanceRunState(SHUTDOWN);
            // åœæ­¢é—²ç½®worker
            interruptIdleWorkers();
            // hook for ScheduledThreadPoolExecutor
            onShutdown(); 
        } finally {
            mainLock.unlock();
        }
        tryTerminate();
    }

    /**
     * å°è¯•åœæ­¢æ‰€æœ‰æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡ï¼Œåœæ­¢å¤„ç†ç­‰å¾…ä¸­çš„ä»»åŠ¡ï¼Œå¹¶è¿”å›ç­‰å¾…æ‰§è¡Œçš„ä»»åŠ¡åˆ—è¡¨;
     * ä»è¯¥æ–¹æ³•è¿”å›æ—¶ï¼Œè¿™äº›ä»»åŠ¡å°†ä»ä»»åŠ¡é˜Ÿåˆ—ä¸­ç§»é™¤
     *
     * æ­¤æ–¹æ³•ä¸ä¼šæ°¸ä¹…ç­‰å¾…ä»¥å‰æäº¤çš„ä»»åŠ¡å®Œæˆæ‰§è¡Œ, (ä½¿ç”¨awaitTerminationæ–¹æ³•æ‰§è¡Œæ­¤æ“ä½œ)
     *
     * é™¤äº†å°½æœ€å¤§åŠªåŠ›å°è¯•åœæ­¢å¤„ç†æ­£åœ¨ç§¯ææ‰§è¡Œçš„ä»»åŠ¡ä¹‹å¤–ï¼Œæ²¡æœ‰ä»»ä½•ä¿è¯;
     * æ­¤å®ç°é€šè¿‡Thread.interruptæ–¹æ³•ä¸­æ–­ä»»åŠ¡ï¼›
     * ä»»ä½•æœªèƒ½å“åº”ä¸­æ–­çš„ä»»åŠ¡éƒ½å¯èƒ½æ°¸è¿œä¸ä¼šç»ˆæ­¢!
     *
     * @throws SecurityException {@inheritDoc}
     */
    public List&lt;Runnable&gt; shutdownNow() {
        // åœæ­¢çš„ä»»åŠ¡åˆ—è¡¨
        List&lt;Runnable&gt; tasks;
        final ReentrantLock mainLock = this.mainLock;
        mainLock.lock();
        try {
            // æ£€æŸ¥åœæ­¢æƒé™
            checkShutdownAccess();
            // æ›´æ–°çŠ¶æ€ä¸ºSTOP
            advanceRunState(STOP);
            // (å°½æœ€å¤§åŠªåŠ›å°è¯•)åœæ­¢æ­£åœ¨æ‰§è¡Œä¸­çš„ä»»åŠ¡!
            interruptWorkers();
            tasks = drainQueue();
        } finally {
            mainLock.unlock();
        }
        tryTerminate();
        return tasks;
    }

    // çº¿ç¨‹æ± æ˜¯å¦åœæ­¢
    public boolean isShutdown() {
        return runStateAtLeast(ctl.get(), SHUTDOWN);
    }

    /** Used by ScheduledThreadPoolExecutor. */
    boolean isStopped() {
        return runStateAtLeast(ctl.get(), STOP);
    }

    /**
     * å¦‚æœæ­¤æ‰§è¡Œå™¨æ­£åœ¨æ‰§è¡Œshutdownæˆ–shutdownNowï¼Œä½†å°šæœªå®Œå…¨ç»ˆæ­¢ï¼Œåˆ™è¿”å›true
     * (æ­¤æ–¹æ³•å¯èƒ½å¯¹è°ƒè¯•æœ‰ç”¨)
     * å¦‚æœè¿”å›trueç»è¿‡äº†ä¸€å®šçš„æ—¶é—´æ®µï¼Œåˆ™å¯èƒ½è¡¨ç¤ºæäº¤çš„ä»»åŠ¡å·²å¿½ç•¥æˆ–æŠ‘åˆ¶ä¸­æ–­ï¼Œä»è€Œå¯¼è‡´æ­¤æ‰§è¡Œå™¨æ— æ³•æ­£ç¡®ç»ˆæ­¢
     *
     * @return {@code true} if terminating but not yet terminated
     */
    public boolean isTerminating() {
        int c = ctl.get();
        return runStateAtLeast(c, SHUTDOWN) &amp;&amp; runStateLessThan(c, TERMINATED);
    }

    // çº¿ç¨‹æ± å·²ç»ç»ˆæ­¢
    public boolean isTerminated() {
        return runStateAtLeast(ctl.get(), TERMINATED);
    }

    // çº¿ç¨‹æ± åœæ­¢æ—¶(ç­‰å¾…ä»»åŠ¡ç»“æŸ)
    public boolean awaitTermination(long timeout, TimeUnit unit)
        throws InterruptedException {
        long nanos = unit.toNanos(timeout);
        final ReentrantLock mainLock = this.mainLock;
        mainLock.lock();
        try {
            // è¿˜æœªå®Œå…¨åœæ­¢æ—¶, ç­‰å¾…
            while (runStateLessThan(ctl.get(), TERMINATED)) {
                // æ—¶é—´åˆ°æœªåœæ­¢, è¿”å›false
                if (nanos &lt;= 0L)
                    return false;
                nanos = termination.awaitNanos(nanos);
            }
            // æ—¶é—´åˆ°ä¹‹å‰åœæ­¢
            return true;
        } finally {
            mainLock.unlock();
        }
    }

    // ä¸ä½¿ç”¨Throwableé‡å†™ä»¥ä¸å­ç±»å…¼å®¹
    // å…¶finalizeæ–¹æ³•è°ƒç”¨super.finalizeæ–¹æ³•(å¦‚å»ºè®®çš„é‚£æ ·)
    // åœ¨JDK11ä¹‹å‰ï¼Œfinalize()æœ‰ä¸€ä¸ªéç©ºçš„æ–¹æ³•ä½“

    /**
     * @implNote è¿™ä¸ªç±»ä»¥å‰çš„ç‰ˆæœ¬æœ‰ä¸€ä¸ªfinalizeæ–¹æ³•å…³é—­è¿™ä¸ªæ‰§è¡Œå™¨
     * ä½†æ˜¯åœ¨è¿™ä¸ªç‰ˆæœ¬ä¸­ï¼Œfinalizeä»€ä¹ˆä¹Ÿä¸åš
     */
    @Deprecated(since=&quot;9&quot;)
    protected void finalize() {}

    /**
     * è®¾ç½®ç”¨äºåˆ›å»ºæ–°çº¿ç¨‹çš„çº¿ç¨‹å·¥å‚
     *
     * @param threadFactory the new thread factory
     * @throws NullPointerException if threadFactory is null
     * @see #getThreadFactory
     */
    public void setThreadFactory(ThreadFactory threadFactory) {
        if (threadFactory == null)
            throw new NullPointerException();
        this.threadFactory = threadFactory;
    }

    /**
     * Returns the thread factory used to create new threads.
     *
     * @return the current thread factory
     * @see #setThreadFactory(ThreadFactory)
     */
    public ThreadFactory getThreadFactory() {
        return threadFactory;
    }

    /**
     * ä¸ºä¸å¯æ‰§è¡Œçš„ä»»åŠ¡è®¾ç½®æ–°çš„å¤„ç†ç¨‹åº(æ‹’ç»ç­–ç•¥)
     *
     * @param handler the new handler
     * @throws NullPointerException if handler is null
     * @see #getRejectedExecutionHandler
     */
    public void setRejectedExecutionHandler(RejectedExecutionHandler handler) {
        if (handler == null)
            throw new NullPointerException();
        this.handler = handler;
    }

    /**
     * Returns the current handler for unexecutable tasks.
     *
     * @return the current handler
     * @see #setRejectedExecutionHandler(RejectedExecutionHandler)
     */
    public RejectedExecutionHandler getRejectedExecutionHandler() {
        return handler;
    }

    /**
     * è®¾ç½®çº¿ç¨‹æ± çš„æ ¸å¿ƒæ•°, è¿™å°†é‡å†™æ„é€ å‡½æ•°ä¸­è®¾ç½®çš„å€¼
     * å¦‚æœæ–°å€¼å°äºå½“å‰å€¼ï¼Œåˆ™å¤šä½™çš„ç°æœ‰çº¿ç¨‹å°†åœ¨ä¸‹æ¬¡å˜ä¸ºç©ºé—²æ—¶è€Œç»ˆæ­¢
     * å¦‚æœæ›´å¤§ï¼Œå¦‚æœæœ‰æ–°ä»»åŠ¡éœ€è¦ï¼Œå°†å¯åŠ¨æ–°çº¿ç¨‹æ¥æ‰§è¡Œä»»ä½•æ’é˜Ÿçš„ä»»åŠ¡
     *
     * @param corePoolSize the new core size
     * @throws IllegalArgumentException if {@code corePoolSize &lt; 0}
     *         or {@code corePoolSize} is greater than the {@linkplain
     *         #getMaximumPoolSize() maximum pool size}
     * @see #getCorePoolSize
     */
    public void setCorePoolSize(int corePoolSize) {
        // å¦‚æœcorePoolSize&lt;0æˆ–è€…corePoolSizeå¤§äºçº¿ç¨‹æ± æœ€å¤§å€¼
        if (corePoolSize &lt; 0 || maximumPoolSize &lt; corePoolSize)
            throw new IllegalArgumentException();
        // å¢é‡delta
        int delta = corePoolSize - this.corePoolSize;
        // æ›´æ–°corePoolSize
        this.corePoolSize = corePoolSize;
        // ç°æœ‰çš„å·¥äººæ•°å¤§äºcorePoolSize(å³æ•°é‡å‡å°‘)
        if (workerCountOf(ctl.get()) &gt; corePoolSize)
            interruptIdleWorkers();
        // ç°æœ‰çš„å·¥äººæ•°å°äºcorePoolSize(æ•°é‡è¦å¢åŠ )
        else if (delta &gt; 0) {
            // æˆ‘ä»¬çœŸçš„ä¸çŸ¥é“â€œéœ€è¦â€å¤šå°‘ä¸ªæ–°çº¿ç¨‹
            // ä½œä¸ºä¸€ç§å¯å‘å¼æ–¹æ³•ï¼Œé¢„å…ˆå¯åŠ¨è¶³å¤Ÿå¤šçš„æ–°å·¥ä½œçº¿ç¨‹(æœ€å¤šæ–°çš„æ ¸å¿ƒå¤§å°)
            // æ¥å¤„ç†é˜Ÿåˆ—ä¸­å½“å‰æ•°é‡çš„ä»»åŠ¡ï¼Œä½†åœ¨æ‰§è¡Œæ­¤æ“ä½œæ—¶ï¼Œå¦‚æœé˜Ÿåˆ—å˜ä¸ºç©ºï¼Œåˆ™åœæ­¢
            int k = Math.min(delta, workQueue.size());
            while (k-- &gt; 0 &amp;&amp; addWorker(null, true)) {
                if (workQueue.isEmpty())
                    break;
            }
        }
    }

    /**
     * è¿”å›çº¿ç¨‹æ± çš„æ ¸å¿ƒæ•°
     *
     * @return the core number of threads
     * @see #setCorePoolSize
     */
    public int getCorePoolSize() {
        return corePoolSize;
    }

    /**
     * æå‰å¯åŠ¨&quot;ä¸€ä¸ª&quot;æ ¸å¿ƒçº¿ç¨‹ï¼Œè®©å®ƒç©ºé—²åœ°ç­‰å¾…å·¥ä½œ
     * è¿™å°†è¦†ç›–ä»…åœ¨æ‰§è¡Œæ–°ä»»åŠ¡æ—¶å¯åŠ¨æ ¸å¿ƒçº¿ç¨‹çš„é»˜è®¤ç­–ç•¥
     * å¦‚æœæ‰€æœ‰æ ¸å¿ƒçº¿ç¨‹éƒ½å·²å¯åŠ¨ï¼Œåˆ™æ­¤æ–¹æ³•å°†è¿”å›false
     *
     * @return {@code true} if a thread was started
     */
    public boolean prestartCoreThread() {
        return workerCountOf(ctl.get()) &lt; corePoolSize &amp;&amp;
            addWorker(null, true);
    }

    /**
     * ä¸prestartCoreThreadç›¸åŒï¼Œä¸åŒä¹‹å¤„åœ¨äº:
     * å³ä½¿corePoolSizeä¸º0, ä¹Ÿä¼šå®‰æ’è‡³å°‘å¯åŠ¨&quot;ä¸€ä¸ªçº¿ç¨‹&quot;!
     */
    void ensurePrestart() {
        int wc = workerCountOf(ctl.get());
        if (wc &lt; corePoolSize)
            addWorker(null, true);
        else if (wc == 0)
            addWorker(null, false);
    }

    /**
     * æå‰å¯åŠ¨æ‰€æœ‰æ ¸å¿ƒçº¿ç¨‹ï¼Œè®©å®ƒä»¬ç©ºé—²åœ°ç­‰å¾…å·¥ä½œ
     * è¿™å°†è¦†ç›–ä»…åœ¨æ‰§è¡Œæ–°ä»»åŠ¡æ—¶å¯åŠ¨æ ¸å¿ƒçº¿ç¨‹çš„é»˜è®¤ç­–ç•¥
     *
     * @return the number of threads started
     */
    public int prestartAllCoreThreads() {
        int n = 0;
        while (addWorker(null, true))
            ++n;
        return n;
    }

    /**
     * å¦‚æœæ­¤æ± å…è®¸æ ¸å¿ƒçº¿ç¨‹è¶…æ—¶ï¼Œåˆ™è¿”å›true;
     * å¦‚æœåœ¨keepAliveæ—¶é—´å†…æ²¡æœ‰ä»»åŠ¡åˆ°è¾¾ï¼Œçº¿ç¨‹terminate;
     * å¦‚æœéœ€è¦ï¼Œåˆ™åœ¨æ–°ä»»åŠ¡åˆ°è¾¾æ—¶æ›¿æ¢;
     * å¦‚æœä¸ºtrueï¼Œåˆ™åº”ç”¨äºéæ ¸å¿ƒçº¿ç¨‹çš„ç›¸åŒä¿æŒæ´»åŠ¨ç­–ç•¥ä¹Ÿé€‚ç”¨äºæ ¸å¿ƒçº¿ç¨‹
     * å¦‚æœä¸ºfalseï¼ˆé»˜è®¤å€¼ï¼‰ï¼Œåˆ™ä¸ä¼šç”±äºç¼ºå°‘ä¼ å…¥ä»»åŠ¡è€Œç»ˆæ­¢æ ¸å¿ƒçº¿ç¨‹
     *
     * @return {@code true} if core threads are allowed to time out,
     *         else {@code false}
     *
     * @since 1.6
     */
    public boolean allowsCoreThreadTimeOut() {
        return allowCoreThreadTimeOut;
    }

    /**
     * è®¾ç½®æ§åˆ¶&quot;æ ¸å¿ƒçº¿ç¨‹&quot;æ˜¯å¦å¯ä»¥è¶…æ—¶çš„ç­–ç•¥
     * å¦‚æœåœ¨ä¿æŒæ´»åŠ¨æ—¶é—´å†…æ²¡æœ‰ä»»åŠ¡åˆ°è¾¾ï¼Œåˆ™è¯¥ç­–ç•¥å°†åœ¨æ–°ä»»åŠ¡åˆ°è¾¾æ—¶æ ¹æ®éœ€è¦è¢«æ›¿æ¢
     * å¦‚æœä¸ºfalseï¼Œåˆ™ä¸ä¼šç”±äºç¼ºå°‘ä¼ å…¥ä»»åŠ¡è€Œç»ˆæ­¢æ ¸å¿ƒçº¿ç¨‹;
     * å¦‚æœä¸ºtrueï¼Œåˆ™åº”ç”¨äºéæ ¸å¿ƒçº¿ç¨‹çš„ç›¸åŒä¿æŒæ´»åŠ¨ç­–ç•¥ä¹Ÿé€‚ç”¨äºæ ¸å¿ƒçº¿ç¨‹;
     * ä¸ºäº†é¿å…è¿ç»­çš„çº¿ç¨‹æ›¿æ¢ï¼Œåœ¨è®¾ç½®trueæ—¶keepAliveTimeå¿…é¡»å¤§äºé›¶
     * é€šå¸¸åº”è¯¥åœ¨&quot;çº¿ç¨‹æ± è¢«æ¿€æ´»ä¹‹å‰è°ƒç”¨æ­¤æ–¹æ³•&quot;
     *
     * @param value {@code true} if should time out, else {@code false}
     * @throws IllegalArgumentException if value is {@code true}
     *         and the current keep-alive time is not greater than zero
     *
     * @since 1.6
     */
    public void allowCoreThreadTimeOut(boolean value) {
        // è¶…æ—¶æ—¶é—´åº”å½“å¤§äºé›¶
        if (value &amp;&amp; keepAliveTime &lt;= 0)
            throw new IllegalArgumentException(&quot;Core threads must have nonzero keep alive times&quot;);
        // æ›´æ–°è¶…æ—¶çŠ¶æ€æ ‡å¿—
        if (value != allowCoreThreadTimeOut) {
            allowCoreThreadTimeOut = value;
            if (value)
                interruptIdleWorkers();
        }
    }

    /**
     * è®¾ç½®å…è®¸çš„æœ€å¤§çº¿ç¨‹æ•°, è¿™å°†é‡å†™æ„é€ å‡½æ•°ä¸­è®¾ç½®çš„å€¼
     * å¦‚æœæ–°å€¼å°äºå½“å‰å€¼ï¼Œåˆ™å¤šä½™çš„ç°æœ‰çº¿ç¨‹å°†åœ¨ä¸‹æ¬¡å˜ä¸ºç©ºé—²æ—¶ç»ˆæ­¢
     *
     * @param maximumPoolSize the new maximum
     * @throws IllegalArgumentException if the new maximum is
     *         less than or equal to zero, or
     *         less than the {@linkplain #getCorePoolSize core pool size}
     * @see #getMaximumPoolSize
     */
    public void setMaximumPoolSize(int maximumPoolSize) {
        if (maximumPoolSize &lt;= 0 || maximumPoolSize &lt; corePoolSize)
            throw new IllegalArgumentException();
        this.maximumPoolSize = maximumPoolSize;
        // å¦‚æœæ–°å€¼å°äºå½“å‰å€¼ï¼Œåˆ™æ£€æµ‹ä¸€æ¬¡ç©ºé—²çº¿ç¨‹
        if (workerCountOf(ctl.get()) &gt; maximumPoolSize)
            interruptIdleWorkers();
    }

    /**
     * Returns the maximum allowed number of threads.
     *
     * @return the maximum allowed number of threads
     * @see #setMaximumPoolSize
     */
    public int getMaximumPoolSize() {
        return maximumPoolSize;
    }

    /**
     * è®¾ç½®çº¿ç¨‹keepAliveTimeï¼Œå³çº¿ç¨‹åœ¨ç»ˆæ­¢ä¹‹å‰å¯ä»¥ä¿æŒç©ºé—²çš„æ—¶é—´é‡
     * å¦‚æœæ± ä¸­å½“å‰çš„çº¿ç¨‹æ•°è¶…è¿‡æ ¸å¿ƒçº¿ç¨‹æ•°;
     * æˆ–è€…å¦‚æœæ­¤æ± allowsCoreThreadTimeOutå…è®¸æ ¸å¿ƒçº¿ç¨‹è¶…æ—¶,
     * åˆ™åˆ°æ­¤æ—¶é—´è€Œç©ºé—²çš„çº¿ç¨‹å°†è¢«ç»ˆæ­¢
     * è¿™å°†é‡å†™æ„é€ å‡½æ•°ä¸­è®¾ç½®çš„å€¼
     *
     * @param time æ—¶é—´å€¼ä¸ºé›¶å°†å¯¼è‡´&quot;å¤šä½™çš„çº¿ç¨‹&quot;åœ¨æ‰§è¡Œä»»åŠ¡å&quot;ç«‹å³ç»ˆæ­¢&quot;
     * å…è®¸allowsCoreThreadTimeOutæ—¶, ä¸å¯è®¾ç½®ä¸º0
     * @param unit the time unit of the {@code time} argument
     * @throws IllegalArgumentException if {@code time} less than zero or
     *         if {@code time} is zero and {@code allowsCoreThreadTimeOut}
     * @see #getKeepAliveTime(TimeUnit)
     */
    public void setKeepAliveTime(long time, TimeUnit unit) {
        if (time &lt; 0)
            throw new IllegalArgumentException();
        // å…è®¸allowsCoreThreadTimeOutæ—¶, ä¸å¯è®¾ç½®ä¸º0
        if (time == 0 &amp;&amp; allowsCoreThreadTimeOut())
            throw new IllegalArgumentException(&quot;Core threads must have nonzero keep alive times&quot;);
        // è®¾ç½®æ—¶é—´
        long keepAliveTime = unit.toNanos(time);
        long delta = keepAliveTime - this.keepAliveTime;
        this.keepAliveTime = keepAliveTime;
        // å¦‚æœç­‰å¾…æ—¶é—´å‡å°‘, æ¸…é™¤ä¸€æ¬¡ç©ºé—²çº¿ç¨‹
        if (delta &lt; 0)
            interruptIdleWorkers();
    }

    /**
     * è¿”å›çº¿ç¨‹ä¿æŒæ´»åŠ¨æ—¶é—´ï¼Œå³çº¿ç¨‹åœ¨ç»ˆæ­¢ä¹‹å‰å¯èƒ½ä¿æŒç©ºé—²çš„æ—¶é—´é‡
     *
     * @param unit the desired time unit of the result
     * @return the time limit
     * @see #setKeepAliveTime(long, TimeUnit)
     */
    public long getKeepAliveTime(TimeUnit unit) {
        return unit.convert(keepAliveTime, TimeUnit.NANOSECONDS);
    }

    /* é¢å‘ç”¨æˆ·çš„é˜Ÿåˆ—å®ç”¨æ–¹æ³• */

    /**
     * è¿”å›æ­¤æ‰§è¡Œå™¨ä½¿ç”¨çš„ä»»åŠ¡é˜Ÿåˆ—, å¯¹ä»»åŠ¡é˜Ÿåˆ—çš„è®¿é—®ä¸»è¦ç”¨äºè°ƒè¯•å’Œç›‘è§†
     * æ­¤é˜Ÿåˆ—å¯èƒ½æ­£åœ¨ä½¿ç”¨ä¸­, éå†ä»»åŠ¡é˜Ÿåˆ—&quot;ä¸ä¼šé˜»æ­¢æ’é˜Ÿçš„ä»»åŠ¡æ‰§è¡Œ&quot;
     *
     * @return the task queue
     */
    public BlockingQueue&lt;Runnable&gt; getQueue() {
        return workQueue;
    }

    /**
     * ä»æ‰§è¡Œå™¨çš„å†…éƒ¨é˜Ÿåˆ—ä¸­ç§»é™¤æ­¤ä»»åŠ¡ï¼ˆå¦‚æœå­˜åœ¨ï¼‰ï¼Œä»è€Œå¯¼è‡´å®ƒåœ¨å°šæœªå¯åŠ¨æ—¶ä¸å†è¿è¡Œ
     *
     * æ­¤æ–¹æ³•å¯ä½œä¸ºå–æ¶ˆä»»åŠ¡çš„ä¸€ä¸€ç§æ–¹æ³•ä½¿ç”¨
     * ä½†å®ƒå¯èƒ½æ— æ³•åˆ é™¤åœ¨æ”¾å…¥å†…éƒ¨é˜Ÿåˆ—ä¹‹å‰å·²è½¬æ¢ä¸ºå…¶ä»–å½¢å¼çš„ä»»åŠ¡:
     * ä¾‹å¦‚ï¼Œä½¿ç”¨submitè¾“å…¥çš„ä»»åŠ¡å¯èƒ½ä¼šè½¬æ¢ä¸ºç»´æŠ¤FutureçŠ¶æ€çš„è¡¨å•
     * ä½†æ˜¯ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¯ä»¥ä½¿ç”¨purgeæ–¹æ³•åˆ é™¤é‚£äº›å·²è¢«å–æ¶ˆçš„Futureå¯¹è±¡
     *
     * @param task the task to remove
     * @return {@code true} if the task was removed
     */
    public boolean remove(Runnable task) {
        boolean removed = workQueue.remove(task);
        tryTerminate(); // åœ¨SHUTDOWNçŠ¶æ€å¹¶ä¸”é˜Ÿåˆ—ä¸ºç©º(ä¿è¯SHUTDOWN)
        return removed;
    }

    /**
     * å°è¯•ä»å·¥ä½œé˜Ÿåˆ—ä¸­åˆ é™¤æ‰€æœ‰å·²å–æ¶ˆçš„Futureä»»åŠ¡
     * (æ­¤æ–¹æ³•å¯ä»¥ç”¨ä½œå¯¹å…¶ä»–æ–¹æ³•æ²¡æœ‰å…¶ä»–å½±å“çš„ä¸€ç§å­˜å‚¨å›æ”¶æ“ä½œ)
     * [å–æ¶ˆçš„ä»»åŠ¡æ°¸è¿œä¸ä¼šæ‰§è¡Œï¼Œä½†å¯èƒ½ä¼šç´¯ç§¯åœ¨å·¥ä½œé˜Ÿåˆ—ä¸­ï¼Œç›´åˆ°å·¥ä½œçº¿ç¨‹å¯ä»¥ä¸»åŠ¨åˆ é™¤å®ƒä»¬]
     * ç›¸åï¼Œè°ƒç”¨æ­¤æ–¹æ³•ä¼šå°è¯•&quot;ç«‹å³åˆ é™¤&quot;å®ƒä»¬
     * ä½†æ˜¯ï¼Œåœ¨å…¶ä»–çº¿ç¨‹çš„å¹²æ‰°ä¸‹ï¼Œæ­¤æ–¹æ³•å¯èƒ½æ— æ³•åˆ é™¤ä»»åŠ¡
     */
    public void purge() {
        final BlockingQueue&lt;Runnable&gt; q = workQueue;
        try {
            Iterator&lt;Runnable&gt; it = q.iterator();
            while (it.hasNext()) {
                Runnable r = it.next();
                // å¦‚æœä»»åŠ¡æ˜¯Futureç±»å‹, å¹¶ä¸”å·²ç»è¢«æ’¤é”€, åˆ™æ¸…é™¤ä»»åŠ¡
                if (r instanceof Future&lt;?&gt; &amp;&amp; ((Future&lt;?&gt;)r).isCancelled())
                    it.remove();
            }
        } catch (ConcurrentModificationException fallThrough) {
            // å¦‚æœåœ¨éå†è¿‡ç¨‹ä¸­é‡åˆ°å¹²æ‰°ï¼Œé€‰æ‹©æ…¢éå†æ–¹æ³•
            // ä¸ºéå†åˆ›å»ºarrayå‰¯æœ¬ï¼Œå¹¶ä¸ºå–æ¶ˆçš„æ¡ç›®è°ƒç”¨remove
            // æ…¢éå†çš„æ—¶é—´å¤æ‚åº¦æ›´å¯èƒ½æ˜¯Oï¼ˆN*Nï¼‰
            for (Object r : q.toArray())
                if (r instanceof Future&lt;?&gt; &amp;&amp; ((Future&lt;?&gt;)r).isCancelled())
                    q.remove(r);
        }

        tryTerminate(); // In case SHUTDOWN and now empty
    }

    /* çº¿ç¨‹æ± æ•°æ®ç»Ÿè®¡ */

    /**
     * è¿”å›æ± ä¸­å½“å‰å·¥ä½œçº¿ç¨‹æ•°
     *
     * @return the number of threads
     */
    public int getPoolSize() {
        final ReentrantLock mainLock = this.mainLock;
        mainLock.lock();
        try {
            // æ’é™¤isTerminatedè¿”å›trueå¹¶ä¸”getPoolSize()&gt;0çš„æƒ…å†µ
            return runStateAtLeast(ctl.get(), TIDYING) ? 0
                : workers.size();
        } finally {
            mainLock.unlock();
        }
    }

    /**
     * è¿”å›æ­£åœ¨ç§¯ææ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹çš„å¤§æ¦‚æ•°é‡(æ ¹æ®workerè¢«é”æ¥åˆ¤æ–­)
     *
     * @return the number of threads
     */
    public int getActiveCount() {
        final ReentrantLock mainLock = this.mainLock;
        mainLock.lock();
        try {
            int n = 0;
            for (Worker w : workers)
                // æ ¹æ®workerè¢«é”æ¥åˆ¤æ–­
                if (w.isLocked())
                    ++n;
            return n;
        } finally {
            mainLock.unlock();
        }
    }

    /**
     * è¿”å›æ± ä¸­åŒæ—¶å­˜åœ¨çš„æœ€å¤§çº¿ç¨‹æ•°
     *
     * @return the number of threads
     */
    public int getLargestPoolSize() {
        final ReentrantLock mainLock = this.mainLock;
        mainLock.lock();
        try {
            return largestPoolSize;
        } finally {
            mainLock.unlock();
        }
    }

    /**
     * è¿”å›è®¡åˆ’æ‰§è¡Œå’Œå·²æ‰§è¡Œçš„ä»»åŠ¡çš„å¤§è‡´æ€»æ•°
     * ç”±äºä»»åŠ¡å’Œçº¿ç¨‹çš„çŠ¶æ€åœ¨è®¡ç®—æœŸé—´å¯èƒ½ä¼šåŠ¨æ€å˜åŒ–ï¼Œå› æ­¤è¿”å›çš„å€¼åªæ˜¯ä¸€ä¸ªè¿‘ä¼¼å€¼
     *
     * @return the number of tasks
     */
    public long getTaskCount() {
        final ReentrantLock mainLock = this.mainLock;
        mainLock.lock();
        try {
            // å½“å‰ç»Ÿè®¡å®Œæˆçš„ä»»åŠ¡æ•°
            long n = completedTaskCount;
            // éå†çš„åŸå› æ˜¯åªæœ‰workerè¢«æ¸…é™¤æ—¶æ‰å°†ä»–çš„æ•°æ®åŠ å…¥completedTaskCountå±æ€§ä¸­;
            for (Worker w : workers) {
                // ä¸å½“å‰å·¥ä½œçº¿ç¨‹çš„ä»»åŠ¡æ•°ç›¸åŠ 
                n += w.completedTasks;
                // å¦‚æœå½“å‰çº¿ç¨‹è¢«é”, åˆ™å†åŠ ä¸€
                if (w.isLocked())
                    ++n;
            }
            // æœ€ååŠ ä¸Šä»»åŠ¡é˜Ÿåˆ—é•¿åº¦(è®¡åˆ’æ‰§è¡Œä»»åŠ¡æ•°)
            return n + workQueue.size();
        } finally {
            mainLock.unlock();
        }
    }

    /**
     * è¿”å›å·²å®Œæˆæ‰§è¡Œçš„ä»»åŠ¡çš„å¤§è‡´æ€»æ•°
     * ç”±äºä»»åŠ¡å’Œçº¿ç¨‹çš„çŠ¶æ€åœ¨è®¡ç®—è¿‡ç¨‹ä¸­å¯èƒ½ä¼šåŠ¨æ€å˜åŒ–ï¼Œå› æ­¤è¿”å›çš„å€¼åªæ˜¯ä¸€ä¸ªè¿‘ä¼¼å€¼
     * ä½†åœ¨è¿ç»­çš„è°ƒç”¨ä¸­æ­¤å€¼ä¸€å®šä¸ä¼šå‡å°‘
     *
     * @return the number of tasks
     */
    public long getCompletedTaskCount() {
        final ReentrantLock mainLock = this.mainLock;
        mainLock.lock();
        try {
            long n = completedTaskCount;
            for (Worker w : workers)
                n += w.completedTasks;
            return n;
        } finally {
            mainLock.unlock();
        }
    }

    /**
     * Returns a string identifying this pool, as well as its state,
     * including indications of run state and estimated worker and
     * task counts.
     *
     * @return a string identifying this pool, as well as its state
     */
    public String toString() {
        long ncompleted;
        int nworkers, nactive;
        final ReentrantLock mainLock = this.mainLock;
        mainLock.lock();
        try {
            ncompleted = completedTaskCount;
            nactive = 0;
            nworkers = workers.size();
            for (Worker w : workers) {
                ncompleted += w.completedTasks;
                if (w.isLocked())
                    ++nactive;
            }
        } finally {
            mainLock.unlock();
        }
        int c = ctl.get();
        String runState =
            isRunning(c) ? &quot;Running&quot; :
            runStateAtLeast(c, TERMINATED) ? &quot;Terminated&quot; :
            &quot;Shutting down&quot;;
        return super.toString() +
            &quot;[&quot; + runState +
            &quot;, pool size = &quot; + nworkers +
            &quot;, active threads = &quot; + nactive +
            &quot;, queued tasks = &quot; + workQueue.size() +
            &quot;, completed tasks = &quot; + ncompleted +
            &quot;]&quot;;
    }

    /* æ‰©å±•çš„é’©å­æ–¹æ³• */

    /**
     * åœ¨ç»™å®šçº¿ç¨‹ä¸­æ‰§è¡Œç»™å®šRunnableä¹‹å‰è°ƒç”¨çš„æ–¹æ³•
     * æ­¤æ–¹æ³•ç”±æ‰§è¡Œä»»åŠ¡rçš„çº¿ç¨‹tè°ƒç”¨ï¼Œå¯ç”¨äºé‡æ–°åˆå§‹åŒ–çº¿ç¨‹å±€éƒ¨å˜é‡æˆ–æ‰§è¡Œæ—¥å¿—è®°å½•
     *
     * è¿™ä¸ªå®ç°ä»€ä¹ˆä¹Ÿä¸åšï¼Œä½†æ˜¯å¯ä»¥&quot;åœ¨å­ç±»ä¸­å®šåˆ¶&quot;
     * æ³¨æ„ï¼šä¸ºäº†æ­£ç¡®åœ°åµŒå¥—å¤šä¸ªé‡å†™,å­ç±»é€šå¸¸åº”è¯¥åœ¨è¿™ä¸ª&quot;æ–¹æ³•çš„æœ«å°¾&quot;è°ƒç”¨super.beforeExecute
     *
     * @param t the thread that will run task {@code r}
     * @param r the task that will be executed
     */
    protected void beforeExecute(Thread t, Runnable r) { }

    /**
     * åœ¨æ‰§è¡Œå®Œç»™å®šçš„å¯è¿è¡Œç¨‹åºåè°ƒç”¨çš„æ–¹æ³•, æ­¤æ–¹æ³•ç”±æ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹è°ƒç”¨
     * å¦‚æœå¼‚å¸¸éç©ºï¼Œåˆ™æŠ›å‡ºçš„æ˜¯å¯¼è‡´æ‰§è¡Œçº¿ç¨‹çªç„¶ç»ˆæ­¢çš„æœªæ•è·çš„RuntimeExceptionæˆ–Error
     *
     * è¿™ä¸ªå®ç°ä»€ä¹ˆä¹Ÿä¸åšï¼Œä½†æ˜¯å¯ä»¥åœ¨å­ç±»ä¸­å®šåˆ¶
     * æ³¨æ„: ä¸ºäº†æ­£ç¡®åœ°åµŒå¥—å¤šä¸ªé‡å†™, å­ç±»é€šå¸¸åº”è¯¥åœ¨&quot;è¿™ä¸ªæ–¹æ³•çš„å¼€å¤´&quot;è°ƒç”¨super.afterExecute
     *
     * æ³¨æ„: å½“æ“ä½œæ˜¾å¼åœ°æˆ–é€šè¿‡æ–¹æ³•(å¦‚submit)åŒ…å«åœ¨ä»»åŠ¡(å¦‚FutureTask)ä¸­æ—¶:
     * ç”±è¿™äº›ä»»åŠ¡å¯¹è±¡æ•è·å¹¶ç»´æŠ¤è®¡ç®—å¼‚å¸¸ï¼Œå› æ­¤å®ƒä»¬ä¸ä¼šå¯¼è‡´çªç„¶ç»ˆæ­¢ï¼Œå¹¶ä¸”å†…éƒ¨å¼‚å¸¸ä¸ä¼šä¼ é€’ç»™æ­¤æ–¹æ³•;
     *
     * å¦‚æœä½ å¸Œæœ›åœ¨æ­¤æ–¹æ³•ä¸­æ•è·è¿™ä¸¤ç§ç±»å‹çš„å¼‚å¸¸ï¼Œåˆ™å¯ä»¥å‚è€ƒä¸‹é¢è¿™ä¸ªä¾‹å­;
     *
     * åœ¨æ­¤ç¤ºä¾‹å­ç±»ä¸­ï¼Œå¦‚æœä»»åŠ¡å·²ä¸­æ­¢ï¼Œåˆ™æ‰“å°ç›´æ¥åŸå› æˆ–åŸºç¡€å¼‚å¸¸:
     *
     * &lt;pre&gt; {@code
     * class ExtendedExecutor extends ThreadPoolExecutor {
     *   // ...
     *   protected void afterExecute(Runnable r, Throwable t) {
     *     super.afterExecute(r, t);
     *     if (t == null
     *         &amp;&amp; r instanceof Future&lt;?&gt;
     *         &amp;&amp; ((Future&lt;?&gt;)r).isDone()) {
     *       try {
     *         Object result = ((Future&lt;?&gt;) r).get();
     *       } catch (CancellationException ce) {
     *         t = ce;
     *       } catch (ExecutionException ee) {
     *         t = ee.getCause();
     *       } catch (InterruptedException ie) {
     *         // ignore/reset
     *         Thread.currentThread().interrupt();
     *       }
     *     }
     *     if (t != null)
     *       System.out.println(t);
     *   }
     * }}&lt;/pre&gt;
     *
     * @param r the runnable that has completed
     * @param t the exception that caused termination, or null if
     * execution completed normally
     */
    protected void afterExecute(Runnable r, Throwable t) { }

    /**
     * æ‰§è¡Œå™¨ç»ˆæ­¢æ—¶è°ƒç”¨çš„æ–¹æ³•, é»˜è®¤å®ç°ä»€ä¹ˆä¹Ÿä¸åš
     * æ³¨æ„: ä¸ºäº†æ­£ç¡®åœ°åµŒå¥—å¤šä¸ªé‡å†™, å­ç±»é€šå¸¸åº”è¯¥åœ¨è¿™ä¸ªæ–¹æ³•ä¸­è°ƒç”¨super.terminated
     */
    protected void terminated() { }

    /* é¢„å®šä¹‰çš„RejectedExecutionHandlers(æ‹’ç»ç­–ç•¥) */

    /**
     * æ‹’ç»ç­–ç•¥: CallerRunsPolicy
     * å®ƒç›´æ¥åœ¨executeæ–¹æ³•çš„è°ƒç”¨çº¿ç¨‹(æäº¤ä»»åŠ¡çš„çº¿ç¨‹)ä¸­è¿è¡Œè¢«æ‹’ç»çš„ä»»åŠ¡;
     * é™¤éæ‰§è¡Œç¨‹åºå·²å…³é—­ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè¯¥ä»»åŠ¡å°†è¢«ä¸¢å¼ƒ
     */
    public static class CallerRunsPolicy implements RejectedExecutionHandler {
        /**
         * Creates a {@code CallerRunsPolicy}.
         */
        public CallerRunsPolicy() { }

        /**
         * åœ¨è°ƒç”¨æ–¹çº¿ç¨‹ä¸­æ‰§è¡Œä»»åŠ¡rï¼Œé™¤éå·²å…³é—­æ‰§è¡Œå™¨ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå°†ä¸¢å¼ƒè¯¥ä»»åŠ¡
         *
         * @param r the runnable task requested to be executed
         * @param e the executor attempting to execute this task
         */
        public void rejectedExecution(Runnable r, ThreadPoolExecutor e) {
            if (!e.isShutdown()) {
                r.run();
            }
        }
    }

    /**
     * æ‹’ç»ç­–ç•¥: AbortPolicy(é»˜è®¤)
     * ç›´æ¥æŠ›å‡ºRejectedExecutionException
     *
     * è¿™æ˜¯ThreadPoolExecutorå’ŒScheduledThreadPoolExecutorçš„é»˜è®¤å¤„ç†ç¨‹åº
     */
    public static class AbortPolicy implements RejectedExecutionHandler {
        /**
         * Creates an {@code AbortPolicy}.
         */
        public AbortPolicy() { }

        /**
         * Always throws RejectedExecutionException.
         *
         * @param r the runnable task requested to be executed
         * @param e the executor attempting to execute this task
         * @throws RejectedExecutionException always
         */
        public void rejectedExecution(Runnable r, ThreadPoolExecutor e) {
            throw new RejectedExecutionException(&quot;Task &quot; + r.toString() +
                                                 &quot; rejected from &quot; +
                                                 e.toString());
        }
    }

    /**
     * æ‹’ç»ç­–ç•¥: DiscardPolicy
     * è‡ªåŠ¨æ”¾å¼ƒè¢«æ‹’ç»çš„ä»»åŠ¡
     */
    public static class DiscardPolicy implements RejectedExecutionHandler {
        /**
         * Creates a {@code DiscardPolicy}.
         */
        public DiscardPolicy() { }

        /**
         * ä¸æ‰§è¡Œä»»ä½•æ“ä½œï¼Œç›´æ¥ä¸¢å¼ƒä»»åŠ¡r
         *
         * @param r the runnable task requested to be executed
         * @param e the executor attempting to execute this task
         */
        public void rejectedExecution(Runnable r, ThreadPoolExecutor e) {
        }
    }

    /**
     * æ‹’ç»ç­–ç•¥: DiscardOldestPolicy
     * ä¸¢å¼ƒæœ€æ—§çš„æœªå¤„ç†è¯·æ±‚ï¼Œç„¶åé‡è¯•executeï¼Œé™¤éè¯¥æ‰§è¡Œç¨‹åºå…³é—­ï¼Œå¦åˆ™è¯¥ä»»åŠ¡å°†è¢«ä¸¢å¼ƒ
     */
    public static class DiscardOldestPolicy implements RejectedExecutionHandler {
        /**
         * Creates a {@code DiscardOldestPolicy} for the given executor.
         */
        public DiscardOldestPolicy() { }

        /**
         * è·å–å¹¶å¿½ç•¥æ‰§è¡Œå™¨å°†è¦æ‰§è¡Œçš„ä¸‹ä¸€ä¸ªä»»åŠ¡(å¦‚æœè¯¥ä»»åŠ¡ç«‹å³å¯ç”¨)
         * ç„¶åé‡è¯•æ‰§è¡Œä»»åŠ¡rï¼Œé™¤éæ‰§è¡Œå™¨å…³é—­ï¼Œå¦åˆ™å°†æ”¾å¼ƒä»»åŠ¡r
         *
         * @param r the runnable task requested to be executed
         * @param e the executor attempting to execute this task
         */
        public void rejectedExecution(Runnable r, ThreadPoolExecutor e) {
            if (!e.isShutdown()) {
                e.getQueue().poll();
                e.execute(r);
            }
        }
    }
}</code></pre>
<p>å‘¼å‘¼~ ç»ˆäºç¿»è¯‘å®Œäº†2100å¤šè¡Œçš„ç¨‹åº, ä¸‹é¢æ¥åšä¸€ä¸‹æ€»ç»“å§!</p>
<h3 id="ä¸€-ctlå±æ€§"><a href="#ä¸€-ctlå±æ€§" class="headerlink" title="ä¸€.ctlå±æ€§"></a>ä¸€.ctlå±æ€§</h3><p>åœ¨ThreadLocalExecutoræºç ä¸­ç¬¬ä¸€ä¸ªå±æ€§ä¾¿æ˜¯ä¸€ä¸ª<code>AtomicInteger</code>ç±»å‹çš„<code>ctl</code>, ç”¨æ¥<strong>æè¿°çº¿ç¨‹æ± çš„çŠ¶æ€(pool control state)</strong></p>
<p>ä¸ctlçš„ç›¸å…³ä»£ç å¦‚ä¸‹:</p>
<pre><code class="java">private final AtomicInteger ctl = new AtomicInteger(ctlOf(RUNNING, 0));
private static final int COUNT_BITS = Integer.SIZE - 3;
private static final int COUNT_MASK = (1 &lt;&lt; COUNT_BITS) - 1;

// runStateå­˜å‚¨åœ¨é«˜é˜¶ä½ä¸­
private static final int RUNNING    = -1 &lt;&lt; COUNT_BITS;
private static final int SHUTDOWN   =  0 &lt;&lt; COUNT_BITS;
private static final int STOP       =  1 &lt;&lt; COUNT_BITS;
private static final int TIDYING    =  2 &lt;&lt; COUNT_BITS;
private static final int TERMINATED =  3 &lt;&lt; COUNT_BITS;

// æ‰“åŒ…å’Œè§£åŒ…ctl(çº¿ç¨‹æ± ç”Ÿå‘½å‘¨æœŸå±æ€§)
private static int runStateOf(int c)     { return c &amp; ~COUNT_MASK; }
private static int workerCountOf(int c)  { return c &amp; COUNT_MASK; }
// å‚æ•°rsè¡¨ç¤ºrunState
// å‚æ•°wcè¡¨ç¤ºworkerCount
// å³æ ¹æ®runStateå’ŒworkerCountæ‰“åŒ…åˆå¹¶æˆctl
private static int ctlOf(int rs, int wc) { return rs | wc; }

// ä¸éœ€è¦è§£åŒ…ctlçš„ä½å­—æ®µè®¿é—®å™¨
// è¿™å–å†³äºbitçš„layoutå’ŒworkerCountæ°¸ä¸ä¸ºè´Ÿ
private static boolean runStateLessThan(int c, int s) {
    return c &lt; s;
}
private static boolean runStateAtLeast(int c, int s) {
    return c &gt;= s;
}
private static boolean isRunning(int c) {
    return c &lt; SHUTDOWN;
}</code></pre>
<p>ä¸‹é¢æ˜¯æ³¨é‡Šä¸­å¯¹ctlçš„æè¿°:</p>
<blockquote>
<br>

<p>ä¸»æ± æ§åˆ¶çŠ¶æ€ctlå±æ€§æ˜¯ä¸€ä¸ªåŸå­æ•´æ•°, åŒ…å«ä¸¤ä¸ªæ¦‚å¿µå­—æ®µ:</p>
<ul>
<li>workerCount: æœ‰æ•ˆçº¿ç¨‹çš„è¿è¡Œæ•°;</li>
<li>runState: æŒ‡ç¤ºæ˜¯å¦æ­£åœ¨è¿è¡Œã€æ­£åœ¨å…³é—­ç­‰;</li>
</ul>
<p><strong>â‘  workerCount</strong></p>
<p><strong>ä¸ºäº†å°†å®ƒä»¬æ‰“åŒ…æˆä¸€ä¸ªint, æˆ‘ä»¬å°†workerCounté™åˆ¶ä¸º<code>(2^29)-1[å¤§çº¦5äº¿]</code>ä¸ªçº¿ç¨‹ï¼Œè€Œä¸æ˜¯<code>(2^31)-1[20äº¿]</code>ä¸ªçº¿ç¨‹</strong></p>
<p>å¦‚æœå°†æ¥å‡ºç°è¿™ç§æƒ…å†µ(çº¿ç¨‹æ•°è¶…è¿‡5äº¿):</p>
<p><strong>å¯ä»¥å°†å˜é‡æ›´æ”¹ä¸ºAtomicLong, å¹¶è°ƒæ•´ä¸‹é¢çš„shift/maskå¸¸é‡</strong></p>
<p><strong>ä½†æ˜¯åœ¨éœ€è¦è¿™æ ·æ”¹å˜ä¹‹å‰ï¼Œä½¿ç”¨intä»£ç ä¼šæ›´å¿«æ›´ç®€å•</strong></p>
<p>workerCountæ˜¯å…è®¸å¯åŠ¨å’Œä¸å…è®¸åœæ­¢çš„å·¥äººæ•°</p>
<p>è¯¥å€¼å¯èƒ½æš‚æ—¶ä¸åŒäºæ´»åŠ¨çº¿ç¨‹çš„å®é™…æ•°é‡, ä¾‹å¦‚:</p>
<ul>
<li>å½“çº¿ç¨‹å·¥å‚åœ¨è¢«è¯·æ±‚æ—¶æ— æ³•åˆ›å»ºçº¿ç¨‹</li>
<li>å½“é€€å‡ºçš„çº¿ç¨‹åœ¨ç»ˆæ­¢å‰ä»åœ¨æ‰§è¡Œè®°å¸(ä»ç„¶åœ¨æ•°é‡ä¸Š, æœªè¢«å‡ä¸€)æ—¶</li>
</ul>
<p>ç”¨æˆ·å¯è§æ± å¤§å°ä¸ºå·¥ä½œé›†çš„å½“å‰å¤§å°</p>
<hr>
<p>runStateæä¾›çº¿ç¨‹æ± ç”Ÿå‘½å‘¨æœŸæ§åˆ¶ï¼Œå…·æœ‰ä»¥ä¸‹å€¼:</p>
<ul>
<li><strong>RUNNING:</strong>  æ¥å—æ–°ä»»åŠ¡å¹¶å¤„ç†æ’é˜Ÿçš„ä»»åŠ¡</li>
<li><strong>SHUTDOWN:</strong> ä¸æ¥å—æ–°ä»»åŠ¡ï¼Œä½†å¤„ç†æ’é˜Ÿçš„ä»»åŠ¡</li>
<li><strong>STOP:</strong> ä¸æ¥å—æ–°ä»»åŠ¡ã€ä¸å¤„ç†æ’é˜Ÿçš„ä»»åŠ¡å’Œä¸­æ–­æ­£åœ¨è¿›è¡Œçš„ä»»åŠ¡</li>
<li><strong>TIDYING:</strong> æ‰€æœ‰ä»»åŠ¡éƒ½å·²ç»ˆæ­¢ï¼ŒworkerCountä¸ºé›¶, çŠ¶æ€è½¬æ¢ä¸ºtidingçš„çº¿ç¨‹å°†è¿è¡Œterminated()é’©å­æ–¹æ³•</li>
<li><strong>TERMINATED:</strong> terminated()æ–¹æ³•å·²å®Œæˆ</li>
</ul>
<p><font color="#f00"><strong>è¿™äº›å€¼ä¹‹é—´çš„æ•°å­—é¡ºåºå¾ˆé‡è¦ï¼Œä»¥ä¾¿è¿›è¡Œæœ‰åºæ¯”è¾ƒ</strong></font></p>
<p><strong>è¿è¡ŒçŠ¶æ€éšæ—¶é—´å•è°ƒåœ°å¢åŠ ï¼Œä½†ä¸å¿…å‘½ä¸­æ¯ä¸ªçŠ¶æ€, çŠ¶æ€è¿‡æ¸¡æ˜¯:</strong></p>
<ul>
<li><strong>RUNNING -&gt; SHUTDOWN:</strong> è°ƒç”¨shutdown()æ–¹æ³•æ—¶</li>
<li><strong>(RUNNING or SHUTDOWN) -&gt; STOP:</strong> åœ¨è°ƒç”¨shutdownNow()æ–¹æ³•æ—¶</li>
<li><strong>SHUTDOWN -&gt; TIDYING:</strong> å½“é˜Ÿåˆ—å’Œæ± éƒ½ä¸ºç©ºæ—¶</li>
<li><strong>STOP -&gt; TIDYING:</strong> å½“æ± ä¸ºç©ºæ—¶</li>
<li><strong>TIDYING -&gt; TERMINATED:</strong> å½“terminated()é’©å­æ–¹æ³•å®Œæˆæ—¶</li>
</ul>
<p><strong>ç­‰å¾…awaitTermination()çš„çº¿ç¨‹å°†åœ¨çŠ¶æ€è¾¾åˆ°TERMINATEDæ—¶è¿”å›</strong></p>
<hr>
<p>æ£€æµ‹ä»SHUTDOWNåˆ°TIDYINGçš„è½¬æ¢æ¯”æƒ³è±¡çš„è¦ç®€å•å¾—å¤š:</p>
<p><strong>å› ä¸ºé˜Ÿåˆ—åœ¨(æ­£å¸¸å·¥ä½œ)éç©ºä¹‹åå¯èƒ½å˜ç©ºï¼Œåœ¨SHUTDOWNçŠ¶æ€ä¸‹ä¹Ÿå¯èƒ½å˜ç©º</strong></p>
<p><strong>ä½†æˆ‘ä»¬åªåœ¨çœ‹åˆ°å®ƒä¸ºç©ºä¹‹ååˆçœ‹åˆ°workerCountä¸º0(æœ‰æ—¶éœ€è¦é‡æ–°æ£€æŸ¥â€”â€”è§ä¸‹æ–‡)æ—¶ç»ˆæ­¢</strong></p>
</blockquote>
<p>è€Œé’ˆå¯¹ctlçš„æ“ä½œå¤§éƒ¨åˆ†æ˜¯ä½è¿ç®—, æ³¨é‡Šä¹Ÿè¯´äº†: æŠŠè¿™ä¸ªintå˜é‡æ‹†æˆä¸¤éƒ¨åˆ†æ¥ç”¨:</p>
<table>
<thead>
<tr>
<th align="center">å‰ä¸‰ä½</th>
<th align="center">å29ä½</th>
</tr>
</thead>
<tbody><tr>
<td align="center">çŠ¶æ€: runState</td>
<td align="center">å½“å‰å·¥ä½œçº¿ç¨‹æ•°: workerCount</td>
</tr>
</tbody></table>
<p><strong>æ‰€ä»¥ï¼Œå·¥ä½œçº¿ç¨‹æ•°é‡æœ€å¤§ä¸èƒ½è¶…è¿‡ 2^29-1</strong></p>
<p>æ‰€ä»¥æ¥çœ‹ä¸€ä¸‹ctlå®šä¹‰çš„çŠ¶æ€çš„æ•°å€¼:</p>
<pre><code class="java">private static final int COUNT_BITS = Integer.SIZE - 3;      // 29
private static final int CAPACITY   = (1 &lt;&lt; COUNT_BITS) - 1; // 000-11111 ... ... 11111111

// çŠ¶æ€åœ¨é«˜ä½å­˜å‚¨
private static final int RUNNING    = -1 &lt;&lt; COUNT_BITS;      // 111-00000 ... ... 00000000
private static final int SHUTDOWN   =  0 &lt;&lt; COUNT_BITS;      // 000-00000 ... ... 00000000
private static final int STOP       =  1 &lt;&lt; COUNT_BITS;      // 001-00000 ... ... 00000000
private static final int TIDYING    =  2 &lt;&lt; COUNT_BITS;      // 010-00000 ... ... 00000000
private static final int TERMINATED =  3 &lt;&lt; COUNT_BITS;      // 011-00000 ... ... 00000000</code></pre>
<p>æœ€åçœ‹ä¸€ä¸‹ä¸ctlç›¸å…³çš„æ“ä½œæ–¹æ³•:</p>
<p><strong>â‘  runStateOf()æ–¹æ³•</strong></p>
<p>c &amp; é«˜3ä½ä¸º1ï¼Œä½29ä½ä¸º0çš„~COUNT_MASKï¼Œç”¨äº<strong>è·å–é«˜3ä½ä¿å­˜çš„çº¿ç¨‹æ± çŠ¶æ€;</strong></p>
<hr>
<p><strong>â‘¡ workerCountOf()æ–¹æ³•</strong></p>
<p>c &amp; é«˜3ä½ä¸º0ï¼Œä½29ä½ä¸º1çš„COUNT_MASKï¼Œç”¨äº<strong>è·å–ä½29ä½çš„çº¿ç¨‹æ•°é‡;</strong></p>
<hr>
<p><strong>â‘¢ ctlOf()æ–¹æ³•</strong></p>
<p>å‚æ•°rsè¡¨ç¤ºrunState, å‚æ•°wcè¡¨ç¤ºworkerCount(ç”±äºå°äº<code>2^29-1</code>æ‰€ä»¥æœ€é«˜ä½å…¨ä¸º0)</p>
<p>å³<strong>æ ¹æ®runStateå’ŒworkerCountæ‰“åŒ…åˆå¹¶æˆctl</strong></p>
<hr>
<p><strong>â‘£ å…¶ä»–çŠ¶æ€æ¯”è¾ƒæ–¹æ³•</strong></p>
<p>é€šè¿‡ä¸Šé¢äº”ç§çŠ¶æ€çš„å¤§å°å¯ä»¥çœ‹å‡º, <strong>çŠ¶æ€é€æ¸é€’å¢(å› ä¸ºçŠ¶æ€åœ¨é«˜ä¸‰ä½!)</strong></p>
<p>æ‰€ä»¥æ¯”è¾ƒçŠ¶æ€åªéœ€è¦æ¯”è¾ƒctlçš„å¤§å°å³å¯!</p>
<br>

<h3 id="äºŒ-å…¶ä»–å±æ€§"><a href="#äºŒ-å…¶ä»–å±æ€§" class="headerlink" title="äºŒ.å…¶ä»–å±æ€§"></a>äºŒ.å…¶ä»–å±æ€§</h3><p><strong>â‘  çº¿ç¨‹æ± é›†åˆå±æ€§</strong></p>
<ul>
<li><code>final BlockingQueue&lt;Runnable&gt; workQueue</code>: ç”¨äºä¿å­˜ä»»åŠ¡å¹¶å°†å…¶ä¼ é€’ç»™å·¥ä½œçº¿ç¨‹çš„é˜Ÿåˆ—</li>
</ul>
<p>æˆ‘ä»¬ä¸è¦æ±‚workQueue.poll()è¿”å›ç©ºå€¼å¿…ç„¶æ„å‘³ç€workQueue.isEmpty(), ä»…ä¾èµ–äºisEmptyæ¥æŸ¥çœ‹é˜Ÿåˆ—æ˜¯å¦ä¸ºç©º</p>
<p>ä¾‹å¦‚: åœ¨å†³å®šæ˜¯å¦ä»å…³é—­è¿‡æ¸¡åˆ°æ•´ç†æ—¶ï¼Œæˆ‘ä»¬å¿…é¡»è¿™æ ·åš</p>
<p>è¿™é€‚ç”¨äºç‰¹æ®Šç”¨é€”çš„é˜Ÿåˆ—ï¼Œä¾‹å¦‚DelayQueuesçš„poll()æ–¹æ³•å…è®¸è¿”å›ç©ºå€¼ï¼Œå³ä½¿ç¨ååœ¨å»¶è¿Ÿåˆ°æœŸæ—¶å¯èƒ½è¿”å›éç©ºå€¼</p>
<ul>
<li><code>final HashSet&lt;Worker&gt; workers</code>: åŒ…å«æ± ä¸­æ‰€æœ‰å·¥ä½œçº¿ç¨‹çš„Seté›†åˆ, ä»…åœ¨è·å–mainLockæ—¶èƒ½å¤Ÿè®¿é—®</li>
</ul>
<hr>
<p><strong>â‘¡ çº¿ç¨‹æ± é”ç›¸å…³</strong></p>
<ul>
<li><code>final ReentrantLock mainLock</code>: å¯¹workers Setå’Œrelated bookkeepingçš„è®¿é—®ä¿æŒé”å®š</li>
</ul>
<p>è™½ç„¶æˆ‘ä»¬å¯ä»¥ä½¿ç”¨æŸç§ç±»å‹çš„å¹¶å‘é›†åˆï¼Œä½†é€šå¸¸æœ€å¥½ä½¿ç”¨é”, å…¶ä¸­ä¸€ä¸ªåŸå› æ˜¯:</p>
<p>è¿™ä¼šåºåˆ—åŒ–InterruptedWorkersï¼Œä»è€Œé¿å…ä¸å¿…è¦çš„ä¸­æ–­é£æš´(ç‰¹åˆ«æ˜¯åœ¨shutdownæœŸé—´)</p>
<p>å¦åˆ™ï¼Œé€€å‡ºçš„çº¿ç¨‹å°†åŒæ—¶ä¸­æ–­é‚£äº›å°šæœªä¸­æ–­çš„çº¿ç¨‹</p>
<p>å®ƒè¿˜ç®€åŒ–äº†ä¸€äº›ä¸æœ€å¤§æ± å¤§å°ç­‰ç›¸å…³çš„ç»Ÿè®¡å·¥ä½œ, åœ¨shutdownå’ŒshutdownNowæ‰§è¡Œæ—¶ï¼Œè¿˜ä¼šè·å–mainLockï¼Œä»¥ç¡®ä¿åœ¨åˆ†åˆ«æ£€æŸ¥å…è®¸ä¸­æ–­å’Œå®é™…ä¸­æ–­çš„æƒ…å†µä¸‹ï¼Œworkersé›†åˆæ˜¯ç¨³å®šçš„</p>
<ul>
<li><code>final Condition termination</code>: æä¾›ç»™awaitTerminationæ–¹æ³•çš„ç­‰å¾…æ¡ä»¶</li>
</ul>
<hr>
<p><strong>â‘¢ çº¿ç¨‹æ± æ•°æ®ç›¸å…³å±æ€§</strong></p>
<ul>
<li><code>int largestPoolSize</code>: è·Ÿè¸ªæœ€å¤§çš„å·²è¾¾åˆ°æ± å¤§å°, ä»…åœ¨è·å–mainLockæ—¶èƒ½å¤Ÿè®¿é—®</li>
<li><code>long completedTaskCount</code>: å·²å®Œæˆä»»åŠ¡çš„è®¡æ•°å™¨, ä»…åœ¨å·¥ä½œçº¿ç¨‹ç»ˆæ­¢æ—¶æ›´æ–°, ä»…åœ¨è·å–mainLockæ—¶èƒ½å¤Ÿè®¿é—®</li>
<li><code>volatile long keepAliveTime</code>: ç­‰å¾…å·¥ä½œçš„ç©ºé—²çº¿ç¨‹è¶…æ—¶æ—¶é—´(ä»¥çº³ç§’ä¸ºå•ä½)<ul>
<li>å½“å­˜åœ¨è¶…è¿‡corePoolSizeæ•°é‡çš„çº¿ç¨‹å­˜åœ¨æˆ–è®¾ç½®äº†allowCoreThreadTimeOutæ—¶ä½¿ç”¨æ­¤è¶…æ—¶</li>
<li>å¦åˆ™ä»–ä»¬ä¼šæ°¸è¿œç­‰å¾…æ–°çš„å·¥ä½œ</li>
</ul>
</li>
<li><code>volatile boolean allowCoreThreadTimeOut</code>: æ ¸å¿ƒå·¥äººæ•°é—²ç½®æ”¶å›<ul>
<li>å¦‚æœä¸ºfalse(é»˜è®¤å€¼), åˆ™æ ¸å¿ƒçº¿ç¨‹å³ä½¿å¤„äºç©ºé—²çŠ¶æ€ä¹Ÿä¸ä¼šè¢«å›æ”¶</li>
<li>å¦‚æœä¸ºtrueï¼Œåˆ™æ ¸å¿ƒçº¿ç¨‹ä½¿ç”¨keepAliveTimeè¶…æ—¶å›æ”¶</li>
</ul>
</li>
<li><code>volatile int corePoolSize</code>: corePoolSizeæ˜¯è¦ä¿æŒæ´»åŠ¨çŠ¶æ€(å¹¶ä¸”ä¸å…è®¸è¶…æ—¶ç­‰)çš„æœ€å°å·¥ä½œçº¿ç¨‹æ•°<ul>
<li>é™¤éè®¾ç½®allowCoreThreadTimeOut(åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæœ€å°å€¼ä¸ºé›¶)</li>
<li>ç”±äºworker countå®é™…ä¸Šå­˜å‚¨åœ¨COUNT_BITSä¸­</li>
<li>å› æ­¤çœŸæ­£çš„é™åˆ¶æ•°æ˜¯: corePoolSize &amp; COUNT_MASK</li>
</ul>
</li>
<li><code>volatile int maximumPoolSize</code>: æœ€å¤§æ± å¤§å°<ul>
<li>ç”±äºworker countå®é™…ä¸Šå­˜å‚¨åœ¨COUNT_BITSä¸­</li>
<li>å› æ­¤çœŸæ­£çš„é™åˆ¶æ•°æ˜¯: maximumPoolSize &amp; COUNT_MASK</li>
</ul>
</li>
</ul>
<blockquote>
  <br>

<p>  <strong>è¯´æ˜: æ‰€æœ‰ç”¨æˆ·æ§åˆ¶å‚æ•°éƒ½å£°æ˜ä¸ºvolatile</strong></p>
<p>  å› æ­¤æ­£åœ¨è¿›è¡Œçš„æ“ä½œæ€»æ˜¯åŸºäºæœ€æ–°çš„å€¼ï¼Œä½†ä¸éœ€è¦é”å®š</p>
</blockquote>
<hr>
<p><strong>â‘£ çº¿ç¨‹æ± æƒé™ç›¸å…³</strong></p>
<p><code>static final RuntimePermission shutdownPerm =   new RuntimePermission(&quot;modifyThread&quot;)</code>: å…³é—­å’Œç«‹å³å…³é—­çš„è°ƒç”¨æ–¹æ‰€éœ€çš„æƒé™</p>
<p>æˆ‘ä»¬è¿˜è¦æ±‚(è§checkShutdownAccessæ–¹æ³•)è°ƒç”¨è€…æœ‰æƒå®é™…ä¸­æ–­(actually interrupt)workeré›†åˆä¸­çš„çº¿ç¨‹(ç”±Thread.interrupt()æ§åˆ¶, ThreadGroup.checkAccessä¾èµ–, è€ŒThreadGroup.checkAccessåˆä¾èµ–äºSecurityManager.checkAccess)</p>
<p><strong>åªæœ‰å½“è¿™äº›æ£€æŸ¥é€šè¿‡æ—¶ï¼Œæ‰ä¼šå°è¯•å…³é—­</strong></p>
<p>æ‰€æœ‰å¯¹Thread.interruptçš„å®é™…è°ƒç”¨(è¯·å‚é˜…interruptdleworkerså’ŒinterruptWorkers)éƒ½å¿½ç•¥äº†SecurityExceptions, è¿™æ„å‘³ç€å°è¯•çš„ä¸­æ–­ä¼šè‡ªåŠ¨å¤±è´¥</p>
<p>åœ¨å…³é—­çš„æƒ…å†µä¸‹ï¼Œé™¤éSecurityManageræœ‰ä¸ä¸€è‡´çš„ç­–ç•¥, (æœ‰æ—¶å…è®¸è®¿é—®çº¿ç¨‹ï¼Œæœ‰æ—¶ä¸å…è®¸)å¦åˆ™å®ƒä»¬ä¸åº”è¯¥å¤±è´¥</p>
<p>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæœªèƒ½çœŸæ­£ä¸­æ–­çº¿ç¨‹å¯èƒ½ä¼šç¦ç”¨æˆ–å»¶è¿Ÿå®Œå…¨ç»ˆæ­¢</p>
<p>interruptibleworksçš„å…¶ä»–ç”¨é€”æ˜¯å»ºè®®æ€§çš„, è€Œæœªèƒ½çœŸæ­£ä¸­æ–­åªä¼šå»¶è¿Ÿå¯¹é…ç½®æ›´æ”¹çš„å“åº”ï¼Œå› æ­¤ä¸ä¼šè¿›è¡Œå¼‚å¸¸å¤„ç†</p>
<hr>
<p><strong>â‘¤ çº¿ç¨‹å·¥å‚</strong></p>
<p><code>volatile ThreadFactory threadFactory</code>: æ‰€æœ‰çº¿ç¨‹éƒ½æ˜¯ä½¿ç”¨æ­¤å·¥å‚(é€šè¿‡addWorkeræ–¹æ³•)åˆ›å»º</p>
<p>æ‰€æœ‰è°ƒç”¨æ–¹éƒ½å¿…é¡»ä¸ºaddWorkerå¤±è´¥åšå¥½å‡†å¤‡, è¿™åæ˜ äº†ç³»ç»Ÿæˆ–ç”¨æˆ·é™åˆ¶çº¿ç¨‹æ•°çš„ç­–ç•¥</p>
<p>å³ä½¿ä¸å°†å…¶è§†ä¸ºé”™è¯¯ï¼Œåˆ›å»ºçº¿ç¨‹å¤±è´¥ä¹Ÿå¯èƒ½å¯¼è‡´æ–°ä»»åŠ¡è¢«æ‹’ç»æˆ–ç°æœ‰ä»»åŠ¡ä»æ»ç•™åœ¨é˜Ÿåˆ—ä¸­</p>
<p>æˆ‘ä»¬è¿›ä¸€æ­¥ä¿ç•™çº¿ç¨‹æ± æ± å˜é‡é…ç½®,è€Œç»§ç»­åˆ›å»ºThread, å¯èƒ½ä¼šé‡åˆ°OutOfMemoryErrorä¹‹ç±»çš„é”™è¯¯(ç”±äºåˆ›å»ºçº¿ç¨‹éœ€è¦åœ¨Thread.startä¸­åˆ†é…æœ¬æœºå †æ ˆï¼Œå› æ­¤æ­¤ç±»é”™è¯¯ç›¸å½“å¸¸è§)</p>
<p>æ­¤æ—¶ç”¨æˆ·å°†å¸Œæœ›æ‰§è¡Œæ¸…ç†æ± å…³é—­ä»¥è¿›è¡Œæ¸…ç†, å¦‚æœæœ‰è¶³å¤Ÿçš„å†…å­˜ä¾›æ¸…ç†ä»£ç å®Œæˆï¼Œæ­¤æ—¶åˆ™ä¸ä¼šé‡åˆ°å¦ä¸€ä¸ªOutOfMemoryé”™è¯¯</p>
<hr>
<p><strong>â‘¥ æ‹’ç»ç­–ç•¥ç›¸å…³å±æ€§</strong></p>
<ul>
<li><code>RejectedExecutionHandler handler</code>: åœ¨æ‰§è¡Œä¸­çº¿ç¨‹æ± é¥±å’Œæˆ–çº¿ç¨‹æ± å…³é—­æ—¶è°ƒç”¨çš„æ‹’ç»ç­–ç•¥æ–¹æ³•</li>
<li><code>RejectedExecutionHandler defaultHandler = new AbortPolicy()</code>: é»˜è®¤çš„æ‹’ç»æ‰§è¡Œå¤„ç†å™¨(é»˜è®¤ä¸ºAbortPolicy, å³æŠ›å‡ºå¼‚å¸¸)</li>
</ul>
<p>æ›´å¤šå’Œå±æ€§ç›¸å…³çš„æ“ä½œè§æºç æ³¨é‡Š~</p>
<br>

<h3 id="ä¸‰-ä»»åŠ¡æäº¤å†…éƒ¨åŸç†"><a href="#ä¸‰-ä»»åŠ¡æäº¤å†…éƒ¨åŸç†" class="headerlink" title="ä¸‰.ä»»åŠ¡æäº¤å†…éƒ¨åŸç†"></a>ä¸‰.ä»»åŠ¡æäº¤å†…éƒ¨åŸç†</h3><p><strong>â‘  execute(Runnable command)æäº¤ä»»åŠ¡</strong></p>
<p><img src="https://images2015.cnblogs.com/blog/677054/201704/677054-20170408210905472-1864459025.png" alt="execute.png"></p>
<p><strong>å‚æ•°:</strong>  command  æäº¤æ‰§è¡Œçš„ä»»åŠ¡ï¼Œä¸èƒ½ä¸ºç©º</p>
<p><strong>æ‰§è¡Œæµç¨‹:</strong></p>
<ul>
<li><p><strong>å¦‚æœçº¿ç¨‹æ± å½“å‰çº¿ç¨‹æ•°é‡å°‘äºcorePoolSize:</strong> åˆ™é€šè¿‡addWorker(command, true)åˆ›å»ºæ–°workerçº¿ç¨‹</p>
<ul>
<li>å¦‚åˆ›å»ºæˆåŠŸè¿”å›;</li>
<li>å¦‚æ²¡åˆ›å»ºæˆåŠŸï¼Œåˆ™æ‰§è¡Œåç»­æ­¥éª¤;</li>
</ul>
<blockquote>
  <br>

<p>  <strong>addWorker(command, true)å¤±è´¥çš„åŸå› å¯èƒ½æ˜¯:</strong></p>
<ul>
<li><strong>çº¿ç¨‹æ± å·²ç»shutdownï¼Œshutdownçš„çº¿ç¨‹æ± ä¸å†æ¥æ”¶æ–°ä»»åŠ¡;</strong></li>
<li>workerCountOf(c) &lt; corePoolSize åˆ¤æ–­åï¼Œç”±äºå¹¶å‘ï¼Œåˆ«çš„çº¿ç¨‹å…ˆåˆ›å»ºäº†workerçº¿ç¨‹ï¼Œå¯¼è‡´workerCount &gt;= corePoolSize</li>
</ul>
</blockquote>
</li>
<li><p>å¦‚æœçº¿ç¨‹æ± è¿˜åœ¨runningçŠ¶æ€ï¼Œå°†taskåŠ å…¥workQueueé˜»å¡é˜Ÿåˆ—ä¸­</p>
<ul>
<li>å¦‚æœåŠ å…¥æˆåŠŸï¼Œè¿›è¡Œdouble-check;</li>
<li>å¦‚æœåŠ å…¥å¤±è´¥ï¼ˆå¯èƒ½æ˜¯é˜Ÿåˆ—å·²æ»¡ï¼‰ï¼Œåˆ™æ‰§è¡Œåç»­æ­¥éª¤;</li>
</ul>
<blockquote>
  <br>

<p>  double-checkä¸»è¦ç›®çš„æ˜¯<strong>åˆ¤æ–­åˆšåŠ å…¥workQueueé˜»å¡é˜Ÿåˆ—çš„taskæ˜¯å¦èƒ½è¢«æ‰§è¡Œ</strong></p>
<ul>
<li>å¦‚æœçº¿ç¨‹æ± å·²ç»ä¸æ˜¯runningçŠ¶æ€äº†ï¼Œåº”è¯¥æ‹’ç»æ·»åŠ æ–°ä»»åŠ¡ï¼Œä»workQueueä¸­åˆ é™¤ä»»åŠ¡;</li>
<li>å¦‚æœçº¿ç¨‹æ± æ˜¯è¿è¡ŒçŠ¶æ€ï¼Œæˆ–è€…ä»workQueueä¸­åˆ é™¤ä»»åŠ¡å¤±è´¥ï¼ˆåˆšå¥½æœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œå®Œæ¯•ï¼Œå¹¶æ¶ˆè€—äº†è¿™ä¸ªä»»åŠ¡ï¼‰ï¼Œç¡®ä¿è¿˜æœ‰çº¿ç¨‹æ‰§è¡Œä»»åŠ¡ï¼ˆåªè¦æœ‰ä¸€ä¸ªå°±å¤Ÿäº†ï¼‰</li>
</ul>
</blockquote>
</li>
<li><p><strong>å¦‚æœçº¿ç¨‹æ± ä¸æ˜¯runningçŠ¶æ€æˆ–è€…æ— æ³•å…¥é˜Ÿåˆ—ï¼Œå°è¯•å¼€å¯æ–°çº¿ç¨‹ï¼Œæ‰©å®¹è‡³maxPoolSizeï¼Œå¦‚æœaddWork(command, false)å¤±è´¥äº†ï¼Œæ‹’ç»å½“å‰command</strong></p>
</li>
</ul>
<hr>
<p><strong>â‘¡ addWorker()</strong></p>
<p>æ·»åŠ workerçº¿ç¨‹æµç¨‹å›¾å¦‚ä¸‹:</p>
<p><img src="https://images2015.cnblogs.com/blog/677054/201704/677054-20170408211358816-1277836615.png" alt="addWorker.png"></p>
<p><strong>addWorker(Runnable firstTask, boolean core)</strong></p>
<p><strong>å‚æ•°:</strong></p>
<ul>
<li>firstTask:  workerçº¿ç¨‹çš„åˆå§‹ä»»åŠ¡ï¼Œå¯ä»¥ä¸ºç©º</li>
<li>core: <ul>
<li>true: å°†corePoolSizeä½œä¸ºä¸Šé™</li>
<li>false: å°†maximumPoolSizeä½œä¸ºä¸Šé™</li>
</ul>
</li>
</ul>
<p><strong>addWorkeræ–¹æ³•æœ‰4ç§ä¼ å‚çš„æ–¹å¼ï¼š</strong></p>
<ul>
<li>addWorker(command, true)</li>
<li>addWorker(command, false)</li>
<li>addWorker(null, false)</li>
<li>addWorker(null, true)</li>
</ul>
<p>åœ¨executeæ–¹æ³•ä¸­å°±ä½¿ç”¨äº†å‰3ç§ï¼Œç»“åˆè¿™ä¸ªæ ¸å¿ƒæ–¹æ³•è¿›è¡Œä»¥ä¸‹åˆ†æ</p>
<ul>
<li>ç¬¬ä¸€ä¸ªï¼šçº¿ç¨‹æ•°å°äºcorePoolSizeæ—¶ï¼Œæ”¾ä¸€ä¸ªéœ€è¦å¤„ç†çš„taskè¿›Workers Set; å¦‚æœWorkers Seté•¿åº¦è¶…è¿‡corePoolSizeï¼Œå°±è¿”å›false</li>
<li>ç¬¬äºŒä¸ªï¼šå½“é˜Ÿåˆ—è¢«æ”¾æ»¡æ—¶ï¼Œå°±å°è¯•å°†è¿™ä¸ªæ–°æ¥çš„taskç›´æ¥æ”¾å…¥Workers Setï¼Œè€Œæ­¤æ—¶Workers Setçš„é•¿åº¦é™åˆ¶æ˜¯maximumPoolSize, å¦‚æœçº¿ç¨‹æ± ä¹Ÿæ»¡äº†çš„è¯å°±è¿”å›false</li>
<li>ç¬¬ä¸‰ä¸ªï¼šæ”¾å…¥ä¸€ä¸ªç©ºçš„taskè¿›workers Setï¼Œé•¿åº¦é™åˆ¶æ˜¯maximumPoolSize, è¿™æ ·ä¸€ä¸ªtaskä¸ºç©ºçš„workeråœ¨çº¿ç¨‹æ‰§è¡Œçš„æ—¶å€™ä¼šå»ä»»åŠ¡é˜Ÿåˆ—é‡Œæ‹¿ä»»åŠ¡ï¼Œè¿™æ ·å°±ç›¸å½“äºåˆ›å»ºäº†ä¸€ä¸ªæ–°çš„çº¿ç¨‹ï¼Œåªæ˜¯æ²¡æœ‰é©¬ä¸Šåˆ†é…ä»»åŠ¡</li>
<li>ç¬¬å››ä¸ªï¼šè¿™ä¸ªæ–¹æ³•å°±æ˜¯æ”¾ä¸€ä¸ªnullçš„taskè¿›Workers  Setï¼Œè€Œä¸”æ˜¯åœ¨å°äºcorePoolSizeæ—¶ï¼Œå¦‚æœæ­¤æ—¶Setä¸­çš„æ•°é‡å·²ç»è¾¾åˆ°corePoolSizeé‚£å°±è¿”å›falseï¼Œä»€ä¹ˆä¹Ÿä¸å¹²ã€‚å®é™…ä½¿ç”¨ä¸­æ˜¯åœ¨prestartAllCoreThreads()æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ç”¨æ¥ä¸ºçº¿ç¨‹æ± é¢„å…ˆå¯åŠ¨corePoolSizeä¸ªworkerç­‰å¾…ä»workQueueä¸­è·å–ä»»åŠ¡æ‰§è¡Œ</li>
</ul>
<p><strong>æ‰§è¡Œæµç¨‹ï¼š</strong></p>
<ul>
<li><p>åˆ¤æ–­çº¿ç¨‹æ± å½“å‰æ˜¯å¦ä¸ºå¯ä»¥æ·»åŠ workerçº¿ç¨‹çš„çŠ¶æ€</p>
<ul>
<li>å¯ä»¥åˆ™ç»§ç»­ä¸‹ä¸€æ­¥</li>
<li>ä¸å¯ä»¥return false;</li>
</ul>
<p><strong>A.çº¿ç¨‹æ± çŠ¶æ€&gt;shutdown:</strong> å¯èƒ½ä¸ºstopã€tidyingã€terminatedï¼Œä¸èƒ½æ·»åŠ workerçº¿ç¨‹</p>
<p><strong>B.çº¿ç¨‹æ± çŠ¶æ€==shutdown:</strong> firstTaskä¸ä¸ºç©ºï¼Œä¸èƒ½æ·»åŠ workerçº¿ç¨‹ï¼Œå› ä¸ºshutdownçŠ¶æ€çš„çº¿ç¨‹æ± ä¸æ¥æ”¶æ–°ä»»åŠ¡</p>
<p><strong>C.çº¿ç¨‹æ± çŠ¶æ€==shutdown, firstTask == null, workQueueä¸ºç©º:</strong> ä¸èƒ½æ·»åŠ workerçº¿ç¨‹ï¼Œå› ä¸ºfirstTaskä¸ºç©ºæ˜¯ä¸ºäº†æ·»åŠ ä¸€ä¸ªæ²¡æœ‰ä»»åŠ¡çš„çº¿ç¨‹å†ä»workQueueè·å–taskï¼Œè€ŒworkQueueä¸ºç©ºï¼Œè¯´æ˜æ·»åŠ æ— ä»»åŠ¡çº¿ç¨‹å·²ç»æ²¡æœ‰æ„ä¹‰</p>
</li>
<li><p>çº¿ç¨‹æ± å½“å‰çº¿ç¨‹æ•°é‡æ˜¯å¦è¶…è¿‡ä¸Šé™ï¼ˆcorePoolSize æˆ– maximumPoolSize)</p>
<ul>
<li>è¶…è¿‡äº†return false</li>
<li>æ²¡è¶…è¿‡åˆ™å¯¹workerCount+1ï¼Œç»§ç»­ä¸‹ä¸€æ­¥</li>
</ul>
</li>
<li><p>åœ¨çº¿ç¨‹æ± çš„ReentrantLockä¿è¯ä¸‹ï¼Œå‘WorkersSetä¸­æ·»åŠ æ–°åˆ›å»ºçš„workerå®ä¾‹ï¼Œæ·»åŠ å®Œæˆåè§£é”ï¼Œå¹¶å¯åŠ¨workerçº¿ç¨‹</p>
<ul>
<li>å¦‚æœè¿™ä¸€åˆ‡éƒ½æˆåŠŸäº†ï¼Œreturn  true;</li>
<li>å¦‚æœæ·»åŠ workerå…¥Setå¤±è´¥æˆ–å¯åŠ¨å¤±è´¥ï¼Œè°ƒç”¨addWorkerFailed()é€»è¾‘, è¿›è¡Œå›æ»š</li>
</ul>
</li>
</ul>
<br>

<h3 id="å››-å†…éƒ¨ç±»Worker"><a href="#å››-å†…éƒ¨ç±»Worker" class="headerlink" title="å››.å†…éƒ¨ç±»Worker"></a>å››.å†…éƒ¨ç±»Worker</h3><p>Workerç±»æœ¬èº«æ—¢å®ç°äº†Runnableï¼Œåˆç»§æ‰¿äº†AbstractQueuedSynchronizerï¼Œæ‰€ä»¥å…¶æ—¢æ˜¯ä¸€ä¸ªå¯æ‰§è¡Œçš„ä»»åŠ¡ï¼Œåˆå¯ä»¥è¾¾åˆ°é”çš„æ•ˆæœ</p>
<p><strong>â‘  new Worker()</strong></p>
<ul>
<li>å°†AQSçš„stateç½®ä¸º-1ï¼Œåœ¨runWoker()å‰ä¸å…è®¸ä¸­æ–­</li>
<li>å¾…æ‰§è¡Œçš„ä»»åŠ¡ä¼šä»¥å‚æ•°ä¼ å…¥ï¼Œå¹¶èµ‹äºˆfirstTask</li>
<li>ç”¨Workerè¿™ä¸ªRunnableåˆ›å»ºThread</li>
</ul>
<p>ä¹‹æ‰€ä»¥Workerè‡ªå·±å®ç°Runnableï¼Œå¹¶åˆ›å»ºThreadï¼Œåœ¨firstTaskå¤–åŒ…ä¸€å±‚ï¼Œæ˜¯å› ä¸º:</p>
<p><font color="#f00"><strong>è¦é€šè¿‡Workeræ§åˆ¶å·¥ä½œçº¿ç¨‹ä¸­æ–­ï¼Œè€ŒfirstTaskè¿™ä¸ªå·¥ä½œä»»åŠ¡åªæ˜¯è´Ÿè´£æ‰§è¡Œä¸šåŠ¡</strong></font></p>
<hr>
<p><strong>â‘¡ Workeræ§åˆ¶ä¸­æ–­ä¸»è¦æœ‰ä»¥ä¸‹å‡ æ–¹é¢:</strong></p>
<ol>
<li><p>åˆå§‹AQSçŠ¶æ€ä¸º-1ï¼Œæ­¤æ—¶ä¸å…è®¸ä¸­æ–­interrupt()ï¼Œåªæœ‰åœ¨workerçº¿ç¨‹å¯åŠ¨äº†ï¼Œæ‰§è¡Œäº†runWoker()ï¼Œå°†stateç½®ä¸º0ï¼Œæ‰èƒ½ä¸­æ–­;</p>
<blockquote>
<br>

<p><strong>ä¸å…è®¸ä¸­æ–­ä½“ç°åœ¨ï¼š</strong></p>
<ul>
<li><strong>shutdown()çº¿ç¨‹æ± æ—¶ï¼Œä¼šå¯¹æ¯ä¸ªworker  tryLock()ä¸Šé”ï¼Œè€ŒWorkerç±»è¿™ä¸ªAQSçš„tryAcquire()æ–¹æ³•æ˜¯å›ºå®šå°†stateä»0-&gt;1ï¼Œæ•…åˆå§‹çŠ¶æ€state==-1æ—¶tryLock()å¤±è´¥ï¼Œæ²¡å‘interrupt();</strong></li>
<li><strong>shutdownNow()çº¿ç¨‹æ± æ—¶ï¼Œä¸ç”¨tryLock()ä¸Šé”ï¼Œä½†è°ƒç”¨worker.interruptIfStarted()ç»ˆæ­¢workerï¼ŒinterruptIfStarted()ä¹Ÿæœ‰state&gt;0æ‰èƒ½interruptçš„é€»è¾‘</strong></li>
</ul>
</blockquote>
</li>
<li><p>ä¸ºäº†é˜²æ­¢æŸç§æƒ…å†µä¸‹ï¼Œåœ¨è¿è¡Œä¸­çš„workerè¢«ä¸­æ–­ï¼ŒrunWorker()æ¯æ¬¡è¿è¡Œä»»åŠ¡æ—¶éƒ½ä¼šlock()ä¸Šé”ï¼Œè€Œshutdown()è¿™ç±»å¯èƒ½ä¼šç»ˆæ­¢workerçš„æ“ä½œéœ€è¦å…ˆè·å–workerçš„é”ï¼Œè¿™æ ·å°±é˜²æ­¢äº†ä¸­æ–­æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹</p>
</li>
</ol>
<p><font color="#f00"><strong>Workerå®ç°çš„AQSä¸ºä¸å¯é‡å…¥é”ï¼Œä¸ºäº†æ˜¯åœ¨è·å¾—workeré”çš„æƒ…å†µä¸‹å†è¿›å…¥å…¶å®ƒä¸€äº›éœ€è¦åŠ é”çš„æ–¹æ³•</strong></font></p>
<hr>
<p><strong>â‘¢ Workerå’ŒTaskçš„åŒºåˆ«</strong></p>
<p><font color="#f00"><strong>Workeræ˜¯çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹ï¼Œè€ŒTaskè™½ç„¶æ˜¯runnableï¼Œä½†æ˜¯å¹¶æ²¡æœ‰çœŸæ­£å¯åŠ¨çº¿ç¨‹æ‰§è¡Œï¼Œåªæ˜¯è¢«Workerè°ƒç”¨äº†runæ–¹æ³•!!!!</strong></font></p>
<br>

<h4 id="runWorker-æ‰§è¡Œä»»åŠ¡"><a href="#runWorker-æ‰§è¡Œä»»åŠ¡" class="headerlink" title="runWorker()æ‰§è¡Œä»»åŠ¡"></a><strong>runWorker()æ‰§è¡Œä»»åŠ¡</strong></h4><p><img src="https://images2015.cnblogs.com/blog/677054/201704/677054-20170408211458878-1033038857.png" alt="runWorker.png"></p>
<p><strong>æ‰§è¡Œæµç¨‹ï¼š</strong></p>
<p>1ã€Workerçº¿ç¨‹å¯åŠ¨åï¼Œé€šè¿‡Workerç±»çš„run()æ–¹æ³•è°ƒç”¨runWorker(this)</p>
<p>2ã€æ‰§è¡Œä»»åŠ¡ä¹‹å‰ï¼Œé¦–å…ˆworker.unlock()ï¼Œå°†AQSçš„stateç½®ä¸º0ï¼Œå…è®¸ä¸­æ–­å½“å‰workerçº¿ç¨‹</p>
<p>3ã€å¼€å§‹æ‰§è¡ŒfirstTaskï¼Œè°ƒç”¨task.run()ï¼Œåœ¨æ‰§è¡Œä»»åŠ¡å‰ä¼šä¸Šé”wroker.lock()ï¼Œåœ¨æ‰§è¡Œå®Œä»»åŠ¡åä¼šè§£é”ï¼Œä¸ºäº†é˜²æ­¢åœ¨ä»»åŠ¡è¿è¡Œæ—¶è¢«çº¿ç¨‹æ± ä¸€äº›ä¸­æ–­æ“ä½œä¸­æ–­</p>
<p>4ã€åœ¨ä»»åŠ¡æ‰§è¡Œå‰åï¼Œå¯ä»¥æ ¹æ®ä¸šåŠ¡åœºæ™¯è‡ªå®šä¹‰beforeExecute() å’Œ afterExecute()æ–¹æ³•</p>
<p>5ã€æ— è®ºåœ¨beforeExecute()ã€task.run()ã€afterExecute()å‘ç”Ÿå¼‚å¸¸ä¸ŠæŠ›ï¼Œéƒ½ä¼šå¯¼è‡´workerçº¿ç¨‹ç»ˆæ­¢ï¼Œè¿›å…¥processWorkerExit()å¤„ç†workeré€€å‡ºçš„æµç¨‹</p>
<p>6ã€å¦‚æ­£å¸¸æ‰§è¡Œå®Œå½“å‰taskåï¼Œä¼šé€šè¿‡getTask()ä»é˜»å¡é˜Ÿåˆ—ä¸­è·å–æ–°ä»»åŠ¡ï¼Œå½“é˜Ÿåˆ—ä¸­æ²¡æœ‰ä»»åŠ¡ï¼Œä¸”è·å–ä»»åŠ¡è¶…æ—¶ï¼Œé‚£ä¹ˆå½“å‰workerä¹Ÿä¼šè¿›å…¥é€€å‡ºæµç¨‹</p>
<br>

<h4 id="getTask-è·å–ä»»åŠ¡"><a href="#getTask-è·å–ä»»åŠ¡" class="headerlink" title="getTask()è·å–ä»»åŠ¡"></a><strong>getTask()è·å–ä»»åŠ¡</strong></h4><p><img src="https://images2015.cnblogs.com/blog/677054/201704/677054-20170408211632300-254189763.png" alt="getTask.png"></p>
<p><strong>æ‰§è¡Œæµç¨‹ï¼š</strong></p>
<p>1ã€é¦–å…ˆåˆ¤æ–­æ˜¯å¦å¯ä»¥æ»¡è¶³ä»workQueueä¸­è·å–ä»»åŠ¡çš„æ¡ä»¶ï¼Œä¸æ»¡è¶³return null</p>
<ul>
<li><p>çº¿ç¨‹æ± çŠ¶æ€æ˜¯å¦æ»¡è¶³ï¼š</p>
<ul>
<li>shutdownçŠ¶æ€ + workQueueä¸ºç©º æˆ– stopçŠ¶æ€ï¼Œéƒ½ä¸æ»¡è¶³ï¼Œå› ä¸ºè¢«shutdownåè¿˜æ˜¯è¦æ‰§è¡ŒworkQueueå‰©ä½™çš„ä»»åŠ¡ï¼Œä½†workQueueä¹Ÿä¸ºç©ºï¼Œå°±å¯ä»¥é€€å‡ºäº†</li>
<li>stopçŠ¶æ€ï¼ŒshutdownNow()æ“ä½œä¼šä½¿çº¿ç¨‹æ± è¿›å…¥stopï¼Œæ­¤æ—¶ä¸æ¥å—æ–°ä»»åŠ¡ï¼Œä¸­æ–­æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡ï¼ŒworkQueueä¸­çš„ä»»åŠ¡ä¹Ÿä¸æ‰§è¡Œäº†ï¼Œæ•…return nullè¿”å›</li>
</ul>
</li>
<li><p>çº¿ç¨‹æ•°é‡æ˜¯å¦è¶…è¿‡maximumPoolSize æˆ– è·å–ä»»åŠ¡æ˜¯å¦è¶…æ—¶</p>
<ul>
<li>çº¿ç¨‹æ•°é‡è¶…è¿‡maximumPoolSizeå¯èƒ½æ˜¯çº¿ç¨‹æ± åœ¨è¿è¡Œæ—¶è¢«è°ƒç”¨äº†setMaximumPoolSize()è¢«æ”¹å˜äº†å¤§å°ï¼Œå¦åˆ™å·²ç»addWorker()æˆåŠŸä¸ä¼šè¶…è¿‡maximumPoolSize</li>
<li>å¦‚æœ å½“å‰çº¿ç¨‹æ•°é‡&gt;corePoolSizeï¼Œæ‰ä¼šæ£€æŸ¥æ˜¯å¦è·å–ä»»åŠ¡è¶…æ—¶ï¼Œè¿™ä¹Ÿä½“ç°äº†å½“çº¿ç¨‹æ•°é‡è¾¾åˆ°maximumPoolSizeåï¼Œå¦‚æœä¸€ç›´æ²¡æœ‰æ–°ä»»åŠ¡ï¼Œä¼šé€æ¸ç»ˆæ­¢workerçº¿ç¨‹ç›´åˆ°corePoolSize</li>
</ul>
</li>
</ul>
<p>2ã€å¦‚æœæ»¡è¶³è·å–ä»»åŠ¡æ¡ä»¶ï¼Œæ ¹æ®æ˜¯å¦éœ€è¦å®šæ—¶è·å–è°ƒç”¨ä¸åŒæ–¹æ³•ï¼š</p>
<ul>
<li>workQueue.poll()ï¼šå¦‚æœåœ¨keepAliveTimeæ—¶é—´å†…ï¼Œé˜»å¡é˜Ÿåˆ—è¿˜æ˜¯æ²¡æœ‰ä»»åŠ¡ï¼Œè¿”å›null</li>
<li>workQueue.take()ï¼šå¦‚æœé˜»å¡é˜Ÿåˆ—ä¸ºç©ºï¼Œå½“å‰çº¿ç¨‹ä¼šè¢«æŒ‚èµ·ç­‰å¾…ï¼›å½“é˜Ÿåˆ—ä¸­æœ‰ä»»åŠ¡åŠ å…¥æ—¶ï¼Œçº¿ç¨‹è¢«å”¤é†’ï¼Œtakeæ–¹æ³•è¿”å›ä»»åŠ¡</li>
</ul>
<p>3ã€åœ¨é˜»å¡ä»workQueueä¸­è·å–ä»»åŠ¡æ—¶ï¼Œå¯ä»¥è¢«interrupt()ä¸­æ–­ï¼Œä»£ç ä¸­æ•è·äº†InterruptedExceptionï¼Œé‡ç½®timedOutä¸ºåˆå§‹å€¼falseï¼Œå†æ¬¡æ‰§è¡Œç¬¬1æ­¥ä¸­çš„åˆ¤æ–­ï¼Œæ»¡è¶³å°±ç»§ç»­è·å–ä»»åŠ¡ï¼Œä¸æ»¡è¶³return nullï¼Œä¼šè¿›å…¥workeré€€å‡ºçš„æµç¨‹</p>
<br>

<h4 id="processWorkerExit-workerçº¿ç¨‹é€€å‡º"><a href="#processWorkerExit-workerçº¿ç¨‹é€€å‡º" class="headerlink" title="processWorkerExit() workerçº¿ç¨‹é€€å‡º"></a><strong>processWorkerExit() workerçº¿ç¨‹é€€å‡º</strong></h4><p><strong>processWorkerExit(Worker w, boolean completedAbruptly)</strong></p>
<p><strong>å‚æ•°:</strong></p>
<ul>
<li><strong>worker:</strong> è¦ç»“æŸçš„worker</li>
<li><strong>completedAbruptly:</strong> æ˜¯å¦çªç„¶å®Œæˆï¼ˆæ˜¯å¦å› ä¸ºå¼‚å¸¸é€€å‡ºï¼‰</li>
</ul>
<p><strong>æ‰§è¡Œæµç¨‹:</strong></p>
<p>1ã€workeræ•°é‡-1</p>
<ul>
<li>å¦‚æœæ˜¯çªç„¶ç»ˆæ­¢ï¼Œè¯´æ˜æ˜¯taskæ‰§è¡Œæ—¶å¼‚å¸¸æƒ…å†µå¯¼è‡´ï¼Œå³run()æ–¹æ³•æ‰§è¡Œæ—¶å‘ç”Ÿäº†å¼‚å¸¸ï¼Œé‚£ä¹ˆæ­£åœ¨å·¥ä½œçš„workerçº¿ç¨‹æ•°é‡éœ€è¦-1</li>
<li>å¦‚æœä¸æ˜¯çªç„¶ç»ˆæ­¢ï¼Œè¯´æ˜æ˜¯workerçº¿ç¨‹æ²¡æœ‰taskå¯æ‰§è¡Œäº†ï¼Œä¸ç”¨-1ï¼Œå› ä¸ºå·²ç»åœ¨getTask()æ–¹æ³•ä¸­-1äº†</li>
</ul>
<p>2ã€ä»Workers Setä¸­ç§»é™¤workerï¼Œåˆ é™¤æ—¶éœ€è¦ä¸Šé”mainlock</p>
<p>3ã€tryTerminate()ï¼šåœ¨å¯¹çº¿ç¨‹æ± æœ‰è´Ÿæ•ˆç›Šçš„æ“ä½œæ—¶ï¼Œéƒ½éœ€è¦â€œå°è¯•ç»ˆæ­¢â€çº¿ç¨‹æ± ï¼Œå¤§æ¦‚é€»è¾‘ï¼šåˆ¤æ–­çº¿ç¨‹æ± æ˜¯å¦æ»¡è¶³ç»ˆæ­¢çš„çŠ¶æ€:</p>
<ul>
<li>å¦‚æœçŠ¶æ€æ»¡è¶³ï¼Œä½†è¿˜æœ‰çº¿ç¨‹æ± è¿˜æœ‰çº¿ç¨‹ï¼Œå°è¯•å¯¹å…¶å‘å‡ºä¸­æ–­å“åº”ï¼Œä½¿å…¶èƒ½è¿›å…¥é€€å‡ºæµç¨‹</li>
<li>æ²¡æœ‰çº¿ç¨‹äº†ï¼Œæ›´æ–°çŠ¶æ€ä¸ºtidying-&gt;terminated</li>
</ul>
<p>4ã€æ˜¯å¦éœ€è¦å¢åŠ workerçº¿ç¨‹ï¼Œå¦‚æœçº¿ç¨‹æ± è¿˜æ²¡æœ‰å®Œå…¨ç»ˆæ­¢ï¼Œä»éœ€è¦ä¿æŒä¸€å®šæ•°é‡çš„çº¿ç¨‹<br>  çº¿ç¨‹æ± çŠ¶æ€æ˜¯running æˆ– shutdown</p>
<ul>
<li>å¦‚æœå½“å‰çº¿ç¨‹æ˜¯çªç„¶ç»ˆæ­¢çš„ï¼ŒaddWorker()</li>
<li>å¦‚æœå½“å‰çº¿ç¨‹ä¸æ˜¯çªç„¶ç»ˆæ­¢çš„ï¼Œä½†å½“å‰çº¿ç¨‹æ•°é‡ &lt; è¦ç»´æŠ¤çš„çº¿ç¨‹æ•°é‡ï¼ŒaddWorker()</li>
</ul>
<p>æ•…å¦‚æœè°ƒç”¨çº¿ç¨‹æ± shutdown()ï¼Œç›´åˆ°workQueueä¸ºç©ºå‰ï¼Œçº¿ç¨‹æ± éƒ½ä¼šç»´æŒcorePoolSizeä¸ªçº¿ç¨‹ï¼Œç„¶åå†é€æ¸é”€æ¯è¿™corePoolSizeä¸ªçº¿ç¨‹</p>
<br>

<h3 id="äº”-çº¿ç¨‹æ± ç»ˆæ­¢"><a href="#äº”-çº¿ç¨‹æ± ç»ˆæ­¢" class="headerlink" title="äº”.çº¿ç¨‹æ± ç»ˆæ­¢"></a>äº”.çº¿ç¨‹æ± ç»ˆæ­¢</h3><h4 id="shutdown-æ¸©æŸ”çš„ç»ˆæ­¢çº¿ç¨‹æ± "><a href="#shutdown-æ¸©æŸ”çš„ç»ˆæ­¢çº¿ç¨‹æ± " class="headerlink" title="shutdown()æ¸©æŸ”çš„ç»ˆæ­¢çº¿ç¨‹æ± "></a>shutdown()æ¸©æŸ”çš„ç»ˆæ­¢çº¿ç¨‹æ± </h4><p><strong>â‘  shutdown()æ‰§è¡Œæµç¨‹:</strong></p>
<p>1ã€ä¸Šé”ï¼ŒmainLockæ˜¯çº¿ç¨‹æ± çš„ä¸»é”ï¼Œæ˜¯å¯é‡å…¥é”ï¼Œå½“è¦æ“ä½œworkers setè¿™ä¸ªä¿æŒçº¿ç¨‹çš„HashSetæ—¶ï¼Œéœ€è¦å…ˆè·å–mainLockï¼Œè¿˜æœ‰å½“è¦å¤„ç†largestPoolSizeã€completedTaskCountè¿™ç±»ç»Ÿè®¡æ•°æ®æ—¶éœ€è¦å…ˆè·å–mainLock</p>
<p>2ã€åˆ¤æ–­è°ƒç”¨è€…æ˜¯å¦æœ‰æƒé™shutdownçº¿ç¨‹æ± </p>
<p>3ã€ä½¿ç”¨CASæ“ä½œå°†çº¿ç¨‹æ± çŠ¶æ€è®¾ç½®ä¸ºshutdownï¼Œshutdownä¹‹åå°†ä¸å†æ¥æ”¶æ–°ä»»åŠ¡</p>
<p>4ã€ä¸­æ–­æ‰€æœ‰ç©ºé—²çº¿ç¨‹  interruptIdleWorkers()</p>
<p>5ã€onShutdown()ï¼ŒScheduledThreadPoolExecutorä¸­å®ç°äº†è¿™ä¸ªæ–¹æ³•ï¼Œå¯ä»¥åœ¨shutdown()æ—¶åšä¸€äº›å¤„ç†</p>
<p>6ã€è§£é”</p>
<p>7ã€å°è¯•ç»ˆæ­¢çº¿ç¨‹æ±   tryTerminate()</p>
<p>å¯ä»¥çœ‹åˆ°shutdown()æ–¹æ³•æœ€é‡è¦çš„å‡ ä¸ªæ­¥éª¤æ˜¯ï¼šæ›´æ–°çº¿ç¨‹æ± çŠ¶æ€ä¸ºshutdownã€ä¸­æ–­æ‰€æœ‰ç©ºé—²çº¿ç¨‹ã€tryTerminated()å°è¯•ç»ˆæ­¢çº¿ç¨‹æ± </p>
<p>é‚£ä¹ˆï¼Œä»€ä¹ˆæ˜¯ç©ºé—²çº¿ç¨‹ï¼ŸinterruptIdleWorkers() æ˜¯æ€ä¹ˆä¸­æ–­ç©ºé—²çº¿ç¨‹çš„ï¼Ÿ</p>
<p>é€šè¿‡interruptIdleWorkers()æ–¹æ³•</p>
<hr>
<p><strong>â‘¡ interruptIdleWorkers()</strong></p>
<p>interruptIdleWorkers() é¦–å…ˆä¼šè·å–mainLocké”ï¼Œå› ä¸ºè¦è¿­ä»£workers setï¼Œåœ¨ä¸­æ–­æ¯ä¸ªworkerå‰ï¼Œéœ€è¦åšä¸¤ä¸ªåˆ¤æ–­ï¼š</p>
<p>1ã€çº¿ç¨‹æ˜¯å¦å·²ç»è¢«ä¸­æ–­ï¼Œæ˜¯å°±ä»€ä¹ˆéƒ½ä¸åš</p>
<p>2ã€worker.tryLock() æ˜¯å¦æˆåŠŸ</p>
<p>ç¬¬äºŒä¸ªåˆ¤æ–­æ¯”è¾ƒé‡è¦ï¼Œå› ä¸ºWorkerç±»é™¤äº†å®ç°äº†å¯æ‰§è¡Œçš„Runnableï¼Œä¹Ÿç»§æ‰¿äº†AQSï¼Œæœ¬èº«ä¹Ÿæ˜¯ä¸€æŠŠé”</p>
<p>tryLock()è°ƒç”¨äº†Workerè‡ªèº«å®ç°çš„tryAcquire()æ–¹æ³•ï¼Œè¿™ä¹Ÿæ˜¯AQSè§„å®šå­ç±»éœ€è¦å®ç°çš„å°è¯•è·å–é”çš„æ–¹æ³•</p>
<p>tryAcquire()å…ˆå°è¯•å°†AQSçš„stateä»0â€“&gt;1ï¼Œè¿”å›trueä»£è¡¨ä¸Šé”æˆåŠŸï¼Œå¹¶è®¾ç½®å½“å‰çº¿ç¨‹ä¸ºé”çš„æ‹¥æœ‰è€…</p>
<p>å¯ä»¥çœ‹åˆ°compareAndSetState(0, 1)åªå°è¯•äº†ä¸€æ¬¡è·å–é”ï¼Œä¸”ä¸æ˜¯æ¯æ¬¡state+1ï¼Œè€Œæ˜¯0â€“&gt;1ï¼Œè¯´æ˜é”ä¸æ˜¯å¯é‡å…¥çš„</p>
<hr>
<p><strong>â‘¢ ä¸ºä»€ä¹ˆè¦worker.tryLock()è·å–workerçš„é”å‘¢ï¼Ÿ</strong></p>
<p>è¿™å°±æ˜¯Wokerç±»å­˜åœ¨çš„ä»·å€¼ä¹‹ä¸€ï¼Œæ§åˆ¶çº¿ç¨‹ä¸­æ–­</p>
<p>åœ¨runWorker()æ–¹æ³•ä¸­æ¯æ¬¡è·å–åˆ°taskï¼Œtask.run()ä¹‹å‰éƒ½éœ€è¦worker.lock()ä¸Šé”ï¼Œè¿è¡Œç»“æŸåè§£é”ï¼Œå³æ­£åœ¨è¿è¡Œä»»åŠ¡çš„å·¥ä½œçº¿ç¨‹éƒ½æ˜¯ä¸Šäº†workeré”çš„</p>
<p>åœ¨interruptIdleWorkers()ä¸­æ–­ä¹‹å‰éœ€è¦å…ˆtryLock()è·å–workeré”ï¼Œæ„å‘³ç€æ­£åœ¨è¿è¡Œçš„workerä¸èƒ½ä¸­æ–­ï¼Œå› ä¸ºworker.tryLock()å¤±è´¥ï¼Œä¸”é”æ˜¯ä¸å¯é‡å…¥çš„</p>
<p>æ•…shutdown()åªæœ‰å¯¹èƒ½è·å–åˆ°workeré”çš„ç©ºé—²çº¿ç¨‹ï¼ˆæ­£åœ¨ä»workQueueä¸­getTask()ï¼Œæ­¤æ—¶workeræ²¡æœ‰åŠ é”ï¼‰å‘é€ä¸­æ–­ä¿¡å·</p>
<p><strong>ç”±æ­¤å¯ä»¥å°†workeråˆ’åˆ†ä¸ºï¼š</strong></p>
<p>1ã€ç©ºé—²workerï¼šæ­£åœ¨ä»workQueueé˜»å¡é˜Ÿåˆ—ä¸­è·å–ä»»åŠ¡çš„worker</p>
<p>2ã€è¿è¡Œä¸­workerï¼šæ­£åœ¨task.run()æ‰§è¡Œä»»åŠ¡çš„worker</p>
<p>æ­£é˜»å¡åœ¨getTask()è·å–ä»»åŠ¡çš„workeråœ¨è¢«ä¸­æ–­åï¼Œä¼šæŠ›å‡ºInterruptedExceptionï¼Œä¸å†é˜»å¡è·å–ä»»åŠ¡</p>
<p>æ•è·ä¸­æ–­å¼‚å¸¸åï¼Œå°†ç»§ç»­å¾ªç¯åˆ°getTask()æœ€å¼€å§‹çš„åˆ¤æ–­çº¿ç¨‹æ± çŠ¶æ€çš„é€»è¾‘ï¼Œå½“çº¿ç¨‹æ± æ˜¯shutdownçŠ¶æ€ï¼Œä¸”workQueue.isEmptyæ—¶ï¼Œreturn nullï¼Œè¿›è¡Œworkerçº¿ç¨‹é€€å‡ºé€»è¾‘</p>
<p>æŸäº›æƒ…å†µä¸‹ï¼ŒinterruptIdleWorkers()æ—¶å¤šä¸ªworkeræ­£åœ¨è¿è¡Œï¼Œä¸ä¼šå¯¹å…¶å‘å‡ºä¸­æ–­ä¿¡å·ï¼Œå‡è®¾æ­¤æ—¶workQueueä¹Ÿä¸ä¸ºç©º</p>
<p>é‚£ä¹ˆå½“å¤šä¸ªworkerè¿è¡Œç»“æŸåï¼Œä¼šåˆ°workQueueé˜»å¡è·å–ä»»åŠ¡ï¼Œè·å–åˆ°çš„æ‰§è¡Œä»»åŠ¡ï¼Œæ²¡è·å–åˆ°çš„ï¼Œå¦‚æœè¿˜æ˜¯æ ¸å¿ƒçº¿ç¨‹ï¼Œä¼šä¸€ç›´workQueue.take()é˜»å¡ä½ï¼Œçº¿ç¨‹æ— æ³•ç»ˆæ­¢ï¼Œå› ä¸ºworkQueueå·²ç»ç©ºäº†ï¼Œä¸”shutdownåä¸ä¼šæ¥æ”¶æ–°ä»»åŠ¡äº†</p>
<p>è¿™å°±éœ€è¦åœ¨shutdown()åï¼Œè¿˜å¯ä»¥å‘å‡ºä¸­æ–­ä¿¡å·</p>
<blockquote>
  <br>

<p>  <strong>Doug Leaå¤§ç¥å·§å¦™çš„åœ¨æ‰€æœ‰å¯èƒ½å¯¼è‡´çº¿ç¨‹æ± äº§ç»ˆæ­¢çš„åœ°æ–¹å®‰æ’äº†tryTerminated()å°è¯•çº¿ç¨‹æ± ç»ˆæ­¢çš„é€»è¾‘ï¼Œå¹¶åœ¨å…¶ä¸­åˆ¤æ–­å¦‚æœçº¿ç¨‹æ± å·²ç»è¿›å…¥ç»ˆæ­¢æµç¨‹ï¼Œæ²¡æœ‰ä»»åŠ¡ç­‰å¾…æ‰§è¡Œäº†ï¼Œä½†çº¿ç¨‹æ± è¿˜æœ‰çº¿ç¨‹ï¼Œä¸­æ–­å”¤é†’ä¸€ä¸ªç©ºé—²çº¿ç¨‹</strong></p>
</blockquote>
<hr>
<p><strong>â‘£ tryTerminated()</strong></p>
<p>tryTerminate() æ‰§è¡Œæµç¨‹ï¼š</p>
<p>1ã€åˆ¤æ–­çº¿ç¨‹æ± æ˜¯å¦éœ€è¦è¿›å…¥ç»ˆæ­¢æµç¨‹ï¼ˆåªæœ‰å½“shutdownçŠ¶æ€+workQueue.isEmpty æˆ– stopçŠ¶æ€ï¼Œæ‰éœ€è¦ï¼‰</p>
<p>2ã€åˆ¤æ–­çº¿ç¨‹æ± ä¸­æ˜¯å¦è¿˜æœ‰çº¿ç¨‹ï¼Œæœ‰åˆ™ interruptIdleWorkers(ONLY_ONE) å°è¯•ä¸­æ–­ä¸€ä¸ªç©ºé—²çº¿ç¨‹ï¼ˆæ­£æ˜¯è¿™ä¸ªé€»è¾‘å¯ä»¥å†æ¬¡å‘å‡ºä¸­æ–­ä¿¡å·ï¼Œä¸­æ–­é˜»å¡åœ¨è·å–ä»»åŠ¡çš„çº¿ç¨‹ï¼‰</p>
<p>3ã€å¦‚æœçŠ¶æ€æ˜¯SHUTDOWNï¼ŒworkQueueä¹Ÿä¸ºç©ºäº†ï¼Œæ­£åœ¨è¿è¡Œçš„workerä¹Ÿæ²¡æœ‰äº†ï¼Œå¼€å§‹terminated</p>
<p>ä¼šå…ˆä¸Šé”ï¼Œå°†çº¿ç¨‹æ± ç½®ä¸ºtidyingçŠ¶æ€ï¼Œä¹‹åè°ƒç”¨éœ€å­ç±»å®ç°çš„ terminated()ï¼Œæœ€åçº¿ç¨‹æ± ç½®ä¸ºterminatedçŠ¶æ€ï¼Œå¹¶å”¤é†’æ‰€æœ‰ç­‰å¾…çº¿ç¨‹æ± ç»ˆæ­¢è¿™ä¸ªConditionçš„çº¿ç¨‹</p>
<br>

<h4 id="shutdownNow-å¼ºç¡¬çš„ç»ˆæ­¢çº¿ç¨‹æ± "><a href="#shutdownNow-å¼ºç¡¬çš„ç»ˆæ­¢çº¿ç¨‹æ± " class="headerlink" title="shutdownNow()å¼ºç¡¬çš„ç»ˆæ­¢çº¿ç¨‹æ± "></a>shutdownNow()å¼ºç¡¬çš„ç»ˆæ­¢çº¿ç¨‹æ± </h4><p>shutdownNow() å’Œ shutdown()çš„å¤§ä½“æµç¨‹ç›¸ä¼¼ï¼Œå·®åˆ«æ˜¯ï¼š</p>
<p>1ã€å°†çº¿ç¨‹æ± æ›´æ–°ä¸ºstopçŠ¶æ€</p>
<p>2ã€è°ƒç”¨ interruptWorkers() ä¸­æ–­æ‰€æœ‰çº¿ç¨‹ï¼ŒåŒ…æ‹¬æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹</p>
<p>3ã€å°†workQueueä¸­å¾…å¤„ç†çš„ä»»åŠ¡ç§»åˆ°ä¸€ä¸ªListä¸­ï¼Œå¹¶åœ¨æ–¹æ³•æœ€åè¿”å›ï¼Œè¯´æ˜shutdownNow()åä¸ä¼šå†å¤„ç†workQueueä¸­çš„ä»»åŠ¡</p>
<p><strong>interruptWorkers()</strong></p>
<p>interruptWorkers() å¾ˆç®€å•ï¼Œå¾ªç¯å¯¹æ‰€æœ‰workerè°ƒç”¨ interruptIfStarted()ï¼Œå…¶ä¸­ä¼šåˆ¤æ–­workerçš„AQS stateæ˜¯å¦å¤§äº0ï¼Œå³workeræ˜¯å¦å·²ç»å¼€å§‹è¿ä½œï¼Œå†è°ƒç”¨Thread.interrupt()</p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¯¹äºè¿è¡Œä¸­çš„çº¿ç¨‹è°ƒç”¨Thread.interrupt()å¹¶ä¸èƒ½ä¿è¯çº¿ç¨‹è¢«ç»ˆæ­¢ï¼Œtask.run()å†…éƒ¨å¯èƒ½æ•è·äº†InterruptExceptionï¼Œæ²¡æœ‰ä¸ŠæŠ›ï¼Œå¯¼è‡´çº¿ç¨‹ä¸€ç›´æ— æ³•ç»“æŸ</p>
<br>

<h4 id="awaitTermination-ç­‰å¾…çº¿ç¨‹æ± ç»ˆæ­¢"><a href="#awaitTermination-ç­‰å¾…çº¿ç¨‹æ± ç»ˆæ­¢" class="headerlink" title="awaitTermination()ç­‰å¾…çº¿ç¨‹æ± ç»ˆæ­¢"></a>awaitTermination()ç­‰å¾…çº¿ç¨‹æ± ç»ˆæ­¢</h4><p><strong>å‚æ•°ï¼š</strong></p>
<ul>
<li>timeoutï¼šè¶…æ—¶æ—¶é—´</li>
<li>unitï¼š   timeoutè¶…æ—¶æ—¶é—´çš„å•ä½</li>
</ul>
<p><strong>è¿”å›ï¼š</strong></p>
<ul>
<li>trueï¼šçº¿ç¨‹æ± ç»ˆæ­¢</li>
<li>falseï¼šè¶…è¿‡timeoutæŒ‡å®šæ—¶é—´</li>
</ul>
<p>åœ¨å‘å‡ºä¸€ä¸ªshutdownè¯·æ±‚åï¼Œåœ¨ä»¥ä¸‹3ç§æƒ…å†µå‘ç”Ÿä¹‹å‰ï¼ŒawaitTermination()éƒ½ä¼šè¢«é˜»å¡</p>
<p>1ã€æ‰€æœ‰ä»»åŠ¡å®Œæˆæ‰§è¡Œ</p>
<p>2ã€åˆ°è¾¾è¶…æ—¶æ—¶é—´</p>
<p>3ã€å½“å‰çº¿ç¨‹è¢«ä¸­æ–­</p>
<hr>
<p>awaitTermination() å¾ªç¯çš„åˆ¤æ–­çº¿ç¨‹æ± æ˜¯å¦terminatedç»ˆæ­¢æˆ–æ˜¯å¦å·²ç»è¶…è¿‡è¶…æ—¶æ—¶é—´ï¼Œç„¶åé€šè¿‡terminationè¿™ä¸ªConditioné˜»å¡ç­‰å¾…ä¸€æ®µæ—¶é—´</p>
<p><font color="#f00"><strong>termination.awaitNanos() æ˜¯é€šè¿‡LockSupport.parkNanos(this, nanosTimeout)å®ç°çš„é˜»å¡ç­‰å¾…</strong></font></p>
<p>é˜»å¡ç­‰å¾…è¿‡ç¨‹ä¸­å‘ç”Ÿä»¥ä¸‹å…·ä½“æƒ…å†µä¼šè§£é™¤é˜»å¡ï¼ˆå¯¹ä¸Šé¢3ç§æƒ…å†µçš„è§£é‡Šï¼‰ï¼š</p>
<p>1ã€å¦‚æœå‘ç”Ÿäº† termination.signalAll()ï¼ˆå†…éƒ¨å®ç°æ˜¯  LockSupport.unpark()ï¼‰ä¼šå”¤é†’é˜»å¡ç­‰å¾…ï¼Œä¸”ç”±äºThreadPoolExecutoråªæœ‰åœ¨  tryTerminated()å°è¯•ç»ˆæ­¢çº¿ç¨‹æ± æˆåŠŸï¼Œå°†çº¿ç¨‹æ± æ›´æ–°ä¸ºterminatedçŠ¶æ€åæ‰ä¼šsignalAll()ï¼Œæ•…awaitTermination()å†æ¬¡åˆ¤æ–­çŠ¶æ€ä¼šreturn trueé€€å‡º</p>
<p>2ã€å¦‚æœè¾¾åˆ°äº†è¶…æ—¶æ—¶é—´ termination.awaitNanos() ä¹Ÿä¼šè¿”å›ï¼Œæ­¤æ—¶nano==0ï¼Œå†æ¬¡å¾ªç¯åˆ¤æ–­return falseï¼Œç­‰å¾…çº¿ç¨‹æ± ç»ˆæ­¢å¤±è´¥</p>
<p>3ã€å¦‚æœå½“å‰çº¿ç¨‹è¢« Thread.interrupt()ï¼Œtermination.awaitNanos()ä¼šä¸ŠæŠ›InterruptExceptionï¼ŒawaitTermination()ç»§ç»­ä¸ŠæŠ›ç»™è°ƒç”¨çº¿ç¨‹ï¼Œä¼šä»¥å¼‚å¸¸çš„å½¢å¼è§£é™¤é˜»å¡</p>
<p>æ•…ç»ˆæ­¢çº¿ç¨‹æ± å¹¶éœ€è¦çŸ¥é“å…¶æ˜¯å¦ç»ˆæ­¢å¯ä»¥ç”¨å¦‚ä¸‹æ–¹å¼ï¼š</p>
<pre><code class="java">executorService.shutdown();
try {
  while(!executorService.awaitTermination(500, TimeUnit.MILLISECONDS)) {
    LOGGER.debug(&quot;Waiting for terminate&quot;);
  }
} 
catch(InterruptedException e) {
  //ä¸­æ–­å¤„ç†
}</code></pre>
<br>

<h3 id="å…­-çº¿ç¨‹æ± çš„ç›‘æ§"><a href="#å…­-çº¿ç¨‹æ± çš„ç›‘æ§" class="headerlink" title="å…­.çº¿ç¨‹æ± çš„ç›‘æ§"></a>å…­.çº¿ç¨‹æ± çš„ç›‘æ§</h3><p>é€šè¿‡ç»§æ‰¿çº¿ç¨‹æ± è¿›è¡Œç›‘æ§</p>
<p>å¯ä»¥é€šè¿‡ç»§æ‰¿çº¿ç¨‹æ± æ¥è‡ªå®šä¹‰çº¿ç¨‹æ± ï¼Œé‡å†™çº¿ç¨‹æ± çš„ beforeExecuteã€afterExecuteå’Œterminatedæ–¹æ³•ï¼Œä¹Ÿå¯ä»¥åœ¨ä»»åŠ¡æ‰§è¡Œå‰ã€æ‰§è¡Œåå’Œçº¿ç¨‹æ± å…³é—­å‰æ‰§ è¡Œä¸€äº›ä»£ç æ¥è¿›è¡Œç›‘æ§</p>
<p>ä¾‹å¦‚ï¼Œç›‘æ§ä»»åŠ¡çš„å¹³å‡æ‰§è¡Œæ—¶é—´ã€æœ€å¤§æ‰§è¡Œæ—¶é—´å’Œæœ€å°æ‰§è¡Œæ—¶é—´ç­‰ã€‚ è¿™å‡ ä¸ªæ–¹æ³•åœ¨çº¿ç¨‹æ± é‡Œæ˜¯ç©ºæ–¹æ³•</p>
<p><strong>â‘  getTaskCount()</strong></p>
<p>è·å–çº¿ç¨‹æ± éœ€è¦æ‰§è¡Œçš„ä»»åŠ¡æ•°é‡</p>
<p>æ€»æ•°=å·²ç»ç»“æŸçº¿å·¥ä½œç¨‹å®Œæˆçš„ä»»åŠ¡æ•°(completedTaskCount) + è¿˜æœªç»“æŸçº¿ç¨‹å·¥ä½œçº¿ç¨‹å®Œæˆçš„ä»»åŠ¡æ•°(w.completedTasks)+æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡æ•°(w.isLocked())+è¿˜æœªæ‰§è¡Œçš„ä»»åŠ¡æ•°(workQueue.size())</p>
<hr>
<p><strong>â‘¡ getCompletedTaskCount()</strong></p>
<p>è·å–çº¿ç¨‹æ± åœ¨è¿è¡Œè¿‡ç¨‹ä¸­å·²å®Œæˆçš„ä»»åŠ¡æ•°é‡</p>
<p> æ€»æ•°=å·²ç»ç»“æŸçº¿å·¥ä½œç¨‹å®Œæˆçš„ä»»åŠ¡æ•°(<code>completedTaskCount</code>) + è¿˜æœªç»“æŸçº¿ç¨‹å·¥ä½œçº¿ç¨‹å®Œæˆçš„ä»»åŠ¡æ•°(<code>w.completedTasks</code>)</p>
<hr>
<p><strong>â‘¢ getLargestPoolSize()</strong></p>
<p>è·å–çº¿ç¨‹æ± é‡Œæ›¾ç»åˆ›å»ºè¿‡çš„æœ€å¤§çº¿ç¨‹æ•°é‡</p>
<p><strong>é€šè¿‡è¿™ä¸ªæ•°æ®å¯ä»¥çŸ¥é“çº¿ç¨‹æ± æ˜¯ å¦æ›¾ç»æ»¡è¿‡: å¦‚è¯¥æ•°å€¼ç­‰äºçº¿ç¨‹æ± çš„æœ€å¤§å¤§å°ï¼Œåˆ™è¡¨ç¤ºçº¿ç¨‹æ± æ›¾ç»æ»¡è¿‡</strong></p>
<hr>
<p><strong>â‘£ getPoolSize()</strong></p>
<p>è·å–çº¿ç¨‹æ± çš„çº¿ç¨‹æ•°é‡</p>
<p>å¦‚æœçº¿ç¨‹æ± ä¸é”€æ¯çš„è¯ï¼Œçº¿ç¨‹æ± é‡Œçš„çº¿ç¨‹ä¸ä¼šè‡ªåŠ¨é”€ æ¯ï¼Œæ‰€ä»¥è¿™ä¸ªå¤§å°åªå¢ä¸å‡</p>
<hr>
<p><strong>â‘¤ getActiveCount()</strong></p>
<p>è·å–æ´»åŠ¨çš„çº¿ç¨‹æ•°</p>
<br>

<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>é›¶é›¶æ´’æ´’æ€»ç»“å®Œäº†ThreadPoolExecutorçš„æºç , æ€»ä½“æ¥è¯´, åœ¨é˜…è¯»ThreadPoolExecutoræºç çš„æ—¶å€™, éµå¾ªä»¥ä¸‹å‡ ä¸ªæ­¥éª¤å³å¯:</p>
<ul>
<li>ctlå±æ€§;</li>
<li>ThreadPoolExecutorä¸­å…¶ä»–å±æ€§;</li>
<li>ä»»åŠ¡æäº¤çš„å®ç°;</li>
<li>å†…éƒ¨ç±»Worker(ä»»åŠ¡æ‰§è¡Œ, ç»ˆæ­¢)</li>
<li>çº¿ç¨‹æ± ç»ˆæ­¢</li>
<li>çº¿ç¨‹æ± çš„ç›‘æ§</li>
</ul>
<p>æœ€åè¯´ä¸€ä¸‹å¦‚ä½•åˆç†åœ°é…ç½®çº¿ç¨‹æ± </p>
<p>è¦æƒ³åˆç†åœ°é…ç½®çº¿ç¨‹æ± ï¼Œå°±å¿…é¡»é¦–å…ˆåˆ†æä»»åŠ¡ç‰¹æ€§ï¼Œå¯ä»¥ä»ä»¥ä¸‹å‡ ä¸ªè§’åº¦æ¥åˆ†æ:</p>
<ul>
<li><strong>ä»»åŠ¡çš„æ€§è´¨ï¼š</strong>CPUå¯†é›†å‹ä»»åŠ¡ã€IOå¯†é›†å‹ä»»åŠ¡å’Œæ··åˆå‹ä»»åŠ¡ã€‚</li>
<li><strong>ä»»åŠ¡çš„ä¼˜å…ˆçº§ï¼š</strong>é«˜ã€ä¸­å’Œä½ã€‚</li>
<li><strong>ä»»åŠ¡çš„æ‰§è¡Œæ—¶é—´ï¼š</strong>é•¿ã€ä¸­å’ŒçŸ­</li>
<li><strong>ä»»åŠ¡çš„ä¾èµ–æ€§ï¼š</strong>æ˜¯å¦ä¾èµ–å…¶ä»–ç³»ç»Ÿèµ„æºï¼Œå¦‚æ•°æ®åº“è¿æ¥</li>
</ul>
<p>æ€§è´¨ä¸åŒçš„ä»»åŠ¡å¯ä»¥ç”¨ä¸åŒè§„æ¨¡çš„çº¿ç¨‹æ± åˆ†å¼€å¤„ç†ã€‚CPUå¯†é›†å‹ä»»åŠ¡åº”é…ç½®å°½å¯èƒ½å°çš„ çº¿ç¨‹ï¼Œå¦‚é…ç½®Ncpu+1ä¸ªçº¿ç¨‹çš„çº¿ç¨‹æ± ã€‚ç”±äºIOå¯†é›†å‹ä»»åŠ¡çº¿ç¨‹å¹¶ä¸æ˜¯ä¸€ç›´åœ¨æ‰§è¡Œä»»åŠ¡ï¼Œåˆ™åº”é… ç½®å°½å¯èƒ½å¤šçš„çº¿ç¨‹ï¼Œå¦‚2*Ncpuã€‚æ··åˆå‹çš„ä»»åŠ¡ï¼Œå¦‚æœå¯ä»¥æ‹†åˆ†ï¼Œå°†å…¶æ‹†åˆ†æˆä¸€ä¸ªCPUå¯†é›†å‹ä»»åŠ¡ å’Œä¸€ä¸ªIOå¯†é›†å‹ä»»åŠ¡ï¼Œåªè¦è¿™ä¸¤ä¸ªä»»åŠ¡æ‰§è¡Œçš„æ—¶é—´ç›¸å·®ä¸æ˜¯å¤ªå¤§ï¼Œé‚£ä¹ˆåˆ†è§£åæ‰§è¡Œçš„ååé‡ å°†é«˜äºä¸²è¡Œæ‰§è¡Œçš„ååé‡ã€‚å¦‚æœè¿™ä¸¤ä¸ªä»»åŠ¡æ‰§è¡Œæ—¶é—´ç›¸å·®å¤ªå¤§ï¼Œåˆ™æ²¡å¿…è¦è¿›è¡Œåˆ†è§£</p>
<p>ä¼˜å…ˆçº§ä¸åŒçš„ä»»åŠ¡å¯ä»¥ä½¿ç”¨ä¼˜å…ˆçº§é˜Ÿåˆ—PriorityBlockingQueueæ¥å¤„ç†ã€‚å®ƒå¯ä»¥è®©ä¼˜å…ˆçº§é«˜ çš„ä»»åŠ¡å…ˆæ‰§è¡Œã€‚</p>
<blockquote>
<ul>
<li>å¦‚æœä¸€ç›´æœ‰ä¼˜å…ˆçº§é«˜çš„ä»»åŠ¡æäº¤åˆ°é˜Ÿåˆ—é‡Œï¼Œé‚£ä¹ˆä¼˜å…ˆçº§ä½çš„ä»»åŠ¡å¯èƒ½æ°¸è¿œä¸èƒ½ æ‰§è¡Œã€‚</li>
<li>å¯ä»¥é€šè¿‡ Runtime.getRuntime().availableProcessors()æ–¹æ³•è·å¾—å½“å‰è®¾å¤‡çš„CPUä¸ªæ•°ã€‚</li>
<li><strong>å»ºè®®ä½¿ç”¨æœ‰ç•Œé˜Ÿåˆ—</strong>æœ‰ç•Œé˜Ÿåˆ—èƒ½å¢åŠ ç³»ç»Ÿçš„ç¨³å®šæ€§å’Œé¢„è­¦èƒ½åŠ›ï¼Œå¯ä»¥æ ¹æ®éœ€è¦è®¾å¤§ä¸€ç‚¹ å„¿ï¼Œæ¯”å¦‚å‡ åƒã€‚æ— ç•Œé˜Ÿåˆ—åœ¨æŸäº›å¼‚å¸¸æƒ…å†µä¸‹å¯èƒ½ä¼šæ’‘çˆ†å†…å­˜ã€‚</li>
</ul>
</blockquote>
<p><font color="#f00"><strong>Næ ¸æœåŠ¡å™¨ï¼Œé€šè¿‡æ‰§è¡Œä¸šåŠ¡çš„å•çº¿ç¨‹åˆ†æå‡ºæœ¬åœ°è®¡ç®—æ—¶é—´ä¸ºxï¼Œç­‰å¾…æ—¶é—´ä¸ºyï¼Œåˆ™å·¥ä½œçº¿ç¨‹æ•°ï¼ˆçº¿ç¨‹æ± çº¿ç¨‹æ•°ï¼‰è®¾ç½®ä¸º N*(x+y)/xï¼Œèƒ½è®©CPUçš„åˆ©ç”¨ç‡æœ€å¤§åŒ–</strong></font></p>
<blockquote>
  <br>

<p>  è¯¦æƒ…å¯ä»¥å‚è€ƒ<a href="https://www.jianshu.com/p/68830a0fdf25" target="_blank" rel="noopener">çº¿ç¨‹æ•°ç©¶ç«Ÿè®¾å¤šå°‘åˆç†</a></p>
</blockquote>
<br>

<h2 id="é™„å½•"><a href="#é™„å½•" class="headerlink" title="é™„å½•"></a>é™„å½•</h2><p>å‚è€ƒæ–‡ç« :</p>
<ul>
<li><a href="https://www.jianshu.com/p/66fd50c37326" target="_blank" rel="noopener">ThreadPoolExecutor ä¸­çš„ ctl å˜é‡</a></li>
<li><a href="https://www.cnblogs.com/trust-freedom/p/6681948.html" target="_blank" rel="noopener">Javaçº¿ç¨‹æ± ThreadPoolExecutorä½¿ç”¨å’Œåˆ†æ(äºŒ) - execute()åŸç†</a></li>
</ul>
<p>å¦‚æœè§‰å¾—æ–‡ç« å†™çš„ä¸é”™, å¯ä»¥å…³æ³¨å¾®ä¿¡å…¬ä¼—å·: Coderå¼ å°å‡¯</p>
<p>å†…å®¹å’Œåšå®¢åŒæ­¥æ›´æ–°~</p>
<br>
  </article>

  <div id="like-container" style="text-align: center">
    <div class="like-feed">
      <p>è§‰å¾—æœ¬æ–‡ä¸é”™å°±ç‚¹ä¸ª<span>â™¥</span>å†èµ°å§~</p>
      <div class="like-img">
        <div class="like-heart" id="like" rel="like"></div>
        <div class="like-count" id="like-count"></div>
      </div>
    </div>
  </div>

  <!-- æ–‡ç« åˆ†äº« -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/css/share.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/js/social-share.min.js"></script>
  <div class="social-share" data-mode="prepend" data-disabled="tencent,diandian"></div>
  <br>

  
  
<div class="nexmoe-post-copyright">
<i class="mdui-list-item-icon nexmoefont icon-info-circle"></i>
<strong>æœ¬æ–‡ä½œè€…ï¼š</strong>Jasonkay<br>
<strong>æœ¬æ–‡é“¾æ¥ï¼š</strong><a href="https://jasonkayzk.github.io/2020/03/05/Javaçº¿ç¨‹æ± ThreadPoolExecutoråˆ†æä¸å®æˆ˜ç»ˆ/" title="https://jasonkayzk.github.io/2020/03/05/Javaçº¿ç¨‹æ± ThreadPoolExecutoråˆ†æä¸å®æˆ˜ç»ˆ/" target="_blank" rel="noopener">https://jasonkayzk.github.io/2020/03/05/Javaçº¿ç¨‹æ± ThreadPoolExecutoråˆ†æä¸å®æˆ˜ç»ˆ/</a><br>

  <strong>ç‰ˆæƒå£°æ˜ï¼š</strong>æœ¬æ–‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/cn/deed.zh" target="_blank">CC BY-NC-SA 3.0 CN</a> åè®®è¿›è¡Œè®¸å¯

</div>


  

  <!-- å¢åŠ é¢è¯•ç‚¹å‡»æ ‡é¢˜æ‰æ˜¾ç¤ºç­”æ¡ˆç­‰æ•ˆæœ! -->
  <!-- <script type="text/javascript">
    $(".question").click(function () {
      var a = $(".answer").eq($(".question").index(this));
      a.is(".answer_shown") ? a.animate({ 'opacity': '1' }, 800).removeClass("answer_shown") : a.animate({ 'opacity': '0' }, 800).addClass("answer_shown");
    });
  </script> -->
  <!-- <style>
    .answer_shown {
      opacity: 0;
    }
  </style> -->

  <!-- åŠ è½½åšå®¢ç‚¹èµåŠŸèƒ½ -->
  <script>
    function ajax(options) {
      return new Promise(function (resolve, reject) {
        $.ajax(options).done(resolve).fail(reject);
      });
    }

    var docName = $('meta[property="og:title"]').attr('content');
    
    // è·³è¿‡localhost
    if (location.hostname !== 'localhost') {
      // åˆå§‹åŒ–
      ajax({
        url: "https://service-rvqf6dam-1257829547.gz.apigw.tencentcs.com/blog_like/",
        type: 'post',
        contentType: 'application/json; charset=utf-8',
        data: JSON.stringify({
          "actionId": "get",
          "docName": docName
        })
      }).then(
        function fulfillHandler(data) {
          $('#like-count').text(data.likeNum);
        },
        function rejectHandler(jqXHR, textStatus, errorThrown) {
          $('#like-count').text(0);
          console.log(jqXHR, textStatus, errorThrown);
        }
      ).catch(function errorHandler(error) {
        $('#like-count').text(0);
        console.log(error);
      });

      $(document).ready(function () {
        $(".like-heart").on("click", function () {
          var heart = $(this);
          var likeCount = $("#like-count" + heart.attr("id").split("like")[1]);
          var intCount = parseInt(likeCount.html());
          var rel = heart.attr("rel");

          if (rel === "like") {
            likeCount.html(intCount + 1);
            heart.addClass("like-heartAnimation").attr("rel", "unlike");
            ajax({
              url: "https://service-rvqf6dam-1257829547.gz.apigw.tencentcs.com/blog_like/",
              type: 'post',
              contentType: 'application/json; charset=utf-8',
              data: JSON.stringify({
                "actionId": "add",
                "docName": docName
              })
            }).catch(function errorHandler(error) {
              console.log(error);
            });
          } else {
            likeCount.html(intCount - 1);
            heart.removeClass("like-heartAnimation").attr("rel", "like");
            heart.css("background-position", "left");
            ajax({
              url: "https://service-rvqf6dam-1257829547.gz.apigw.tencentcs.com/blog_like/",
              type: 'post',
              contentType: 'application/json; charset=utf-8',
              data: JSON.stringify({
                "actionId": "subtract",
                "docName": docName
              })
            }).catch(function errorHandler(error) {
              console.log(error);
            });
          }
        }).on("mouseleave", function () {
          $(this).css("background-position", "");
        });
      });
    }
  </script>
  <style>
    #like-container {
      margin: 0 auto;
      width: 100%;
    }

    .like-img {
      width: 200px;
      height: 100px;
      display: inline-block;
    }

    .like-heart {
      float: left;
      background: url(/images/web_heart_animation.png);
      background-position: left;
      background-repeat: no-repeat;
      height: 50px;
      width: 120px;
      left: -14px;
      background-size: 2900%;
    }

    .like-count {
      float: left;
      font-family: 'Georgia', Times, Times New Roman, serif;
      font-size: 35px;
      color: #999999;
      text-align: left;
      height: 50px;
      width: 50px;
      line-height: 44px;
    }

    .like-heart:hover,
    .like-heart:focus {
      background-position: right;
    }

    @-webkit-keyframes heartBlast {
      0% {
        background-position: left;
      }

      100% {
        background-position: right;
      }
    }

    @keyframes heartBlast {
      0% {
        background-position: left;
      }

      100% {
        background-position: right;
      }
    }

    .like-heartAnimation {
      display: inline-block;
      -webkit-animation-name: heartBlast;
      animation-name: heartBlast;
      -webkit-animation-duration: .8s;
      animation-duration: .8s;
      -webkit-animation-iteration-count: 1;
      animation-iteration-count: 1;
      -webkit-animation-timing-function: steps(28);
      animation-timing-function: steps(28);
      background-position: right;
    }

    .like-feed {
      height: 90px;
      margin-bottom: 20px;
      text-align: center
    }

    .like-feed p {
      font-family: 'microsoft yahei', 'Georgia';
      font-size: 25px;
    }

    .like-feed span {
      font-size: 30px;
      color: #D33115;
    }
  </style>

  <section class="nexmoe-comment">
    <div class="utterances"></div>
<style>
    .v .vwrap {
      border: 1px dashed #c4bfbf
    }
  
    .v .vwrap .vheader .vinput {
      border-bottom: 1px dashed #c4bfbf
    }
</style>
<script src="https://utteranc.es/client.js" repo="JasonkayZK/JasonkayZK.github.io" issue-term="title" label="commentâœ¨ğŸ’¬âœ¨" theme="github-light" crossorigin="anonymous" async>
</script>

</section>
</div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/mdui@0.4.3/dist/js/mdui.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js"></script>
 
    <script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>


 
    <script src="https://cdn.jsdelivr.net/npm/smoothscroll-for-websites@1.4.9/SmoothScroll.min.js"></script>


<script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.16.2/build/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<script src="/js/app.js?v=1770725349044"></script>
<script src="https://cdn.jsdelivr.net/npm/lazysizes@5.1.0/lazysizes.min.js"></script>




  
    <!-- Google Analytics -->
<script>
    window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
    ga('create', 'G-1NWK4EEKDF', 'auto');
    ga('send', 'pageview');
</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>






    <!-- baidu Analytics -->
<script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?5f5ec71a32c11ff54dff64d0341017b0";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
</script>

</body>

<!-- é¡µé¢ç‚¹å‡»å°çº¢å¿ƒ -->
<!-- 
<script type="text/javascript">
  !function (e, t, a) { function n() { c(".heart{width: 10px;height: 10px;position: fixed;background: #f00;transform: rotate(45deg);-webkit-transform: rotate(45deg);-moz-transform: rotate(45deg);}.heart:after,.heart:before{content: '';width: inherit;height: inherit;background: inherit;border-radius: 50%;-webkit-border-radius: 50%;-moz-border-radius: 50%;position: fixed;}.heart:after{top: -5px;}.heart:before{left: -5px;}"), o(), r() } function r() { for (var e = 0; e < d.length; e++)d[e].alpha <= 0 ? (t.body.removeChild(d[e].el), d.splice(e, 1)) : (d[e].y--, d[e].scale += .004, d[e].alpha -= .013, d[e].el.style.cssText = "left:" + d[e].x + "px;top:" + d[e].y + "px;opacity:" + d[e].alpha + ";transform:scale(" + d[e].scale + "," + d[e].scale + ") rotate(45deg);background:" + d[e].color + ";z-index:99999"); requestAnimationFrame(r) } function o() { var t = "function" == typeof e.onclick && e.onclick; e.onclick = function (e) { t && t(), i(e) } } function i(e) { var a = t.createElement("div"); a.className = "heart", d.push({ el: a, x: e.clientX - 5, y: e.clientY - 5, scale: 1, alpha: 1, color: s() }), t.body.appendChild(a) } function c(e) { var a = t.createElement("style"); a.type = "text/css"; try { a.appendChild(t.createTextNode(e)) } catch (t) { a.styleSheet.cssText = e } t.getElementsByTagName("head")[0].appendChild(a) } function s() { return "rgb(" + ~~(255 * Math.random()) + "," + ~~(255 * Math.random()) + "," + ~~(255 * Math.random()) + ")" } var d = []; e.requestAnimationFrame = function () { return e.requestAnimationFrame || e.webkitRequestAnimationFrame || e.mozRequestAnimationFrame || e.oRequestAnimationFrame || e.msRequestAnimationFrame || function (e) { setTimeout(e, 1e3 / 60) } }(), n() }(window, document);
</script>
 -->
 
<script>
  // è¿›åº¦æ¡åŠ è½½: nprogress
  NProgress.start()
  NProgress.done()
</script>

<script type="text/javascript" defer>
  $(document).ready(function () {
    $.goup({
      trigger: 100,
      bottomOffset: 50,
      locationOffset: 50,
      title: '0%',
      titleAsText: true
    });
    $(".goup-container").css("background", "#64dcf0 none repeat scroll 0% 0%").css("opacity", 0.9);
    $(".goup-text").css("font-weight", 600).css("opacity", 0.9);
  });

  $(document).scroll(function () {
    var d_h = $(document).height();
    var c_h = $(window).height();
    var c_t_h = $(window).scrollTop();
    var schedule = c_t_h / (d_h - c_h - 0.5);
    var str = Number(schedule * 100).toFixed();
    str += "%";
    $(".goup-text").text(str);
  });
</script>

<!-- ç«™å†…é€šçŸ¥ -->
<script src="/js/notification.js"></script>
<script>
  'use strict';

  (function () {
    $(function () {
      $('.position').click(function (event) {
        var el = $(event.target);
        $('.position').removeClass('selected');
        el.addClass('selected');
        position = el.attr('data-position');
      });
    });
  });

  var position = 2;
  // å…³é—­ç™¾æ¯«ç§’æ•°
  var closeTime = 50;
  var notifyFunc = function () {
    // Notification.create(
    //   //Â Title
    //   "Tencentå†…æ¨ä¸­ğŸ“§",
    //   //Â Text
    //   "ç®€å†æŠ•é€’å¤„ï¼š<BR/><a href='/hiring/'>ç®€å†æŠ•é€’</a>",
    //   //Â Illustration
    //   "/images/avatar4.jpg",
    //   //Â Effect
    //   'fadeInRight',
    //   //Â PositionÂ 1, 2,Â 3,Â 4
    //   position,
    //   closeTime
    // );
    // setTimeout(() => {
    //   Notification.create(
    //     "èµ„æºä¸‹è½½âš¡",
    //     "ä¼ é€é—¨ï¼š<BR/><a href='/sharing/'>æ–‡ä»¶åˆ†äº«</a>",
    //     "/images/avatar4.jpg",
    //     'fadeInRight',
    //     position,
    //     closeTime
    //   )
    // }, 350);
    setTimeout(() => {
      Notification.create(
        "RSSè®¢é˜…ğŸ“¢",
        "ä¼ é€é—¨ï¼š<BR/><a href='/atom.xml'>RSSè®¢é˜…</a>",
        "/images/avatar4.jpg",
        'fadeInRight',
        position,
        closeTime
      )
    }, 0);
    setTimeout(() => {
        Notification.create(
        "åœ¨çº¿ç¾¤èŠğŸ’­",
        "ä¼ é€é—¨ï¼š<BR/><a href='/chat/'>ç•…æ‰€æ¬²è¨€</a>",
        "/images/avatar4.jpg",
        'fadeInRight',
        position,
        closeTime
      )
    }, 350);
    setTimeout(() => {
        Notification.create(
        // "è·‘æ­¥å¥èº«ğŸƒ",
        // "ä¼ é€é—¨ï¼š<BR/><a href='/running/'>è·‘æ­¥å¥èº«</a>",
        "æ‘„å½±åˆ†äº«ğŸ“·",
        "ä¼ é€é—¨ï¼š<BR/><a href='http://159.75.131.252:32352/'>æ‘„å½±åˆ†äº«</a>",
        "/images/avatar4.jpg",
        'fadeInRight',
        position,
        closeTime
      )
    }, 700);
  };

  (function once() {
    if (sessionStorage.getItem('load') == null) {
      notifyFunc();
      sessionStorage.setItem('load', false);
    } else {
      return;
    }
  })();
</script>
<script>
  $(document).on("click", ".dismiss", function (e) {
    Notification.hide(e.currentTarget.classList[1].split('-')[1]);
  })
</script>

</html>